
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="fmri-glm.html">
      
      
        <link rel="next" href="fmri-rois.html">
      
      
      <link rel="icon" href="../../../assets/hoplab_favicon_white.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>4b. First-level analysis - Scripting - Hoplab Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
        <script src="../../../assets/external/unpkg.com/iframe-worker/shim.js"></script>
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../../assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-71T36SYGT2"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-71T36SYGT2",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-71T36SYGT2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction-to-spm-scripting-with-matlabbatch" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="Hoplab Wiki" class="md-header__button md-logo" aria-label="Hoplab Wiki" data-md-component="logo">
      
  <img src="../../../assets/thicker_white_brain.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hoplab Wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4b. First-level analysis - Scripting
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/HOPLAB-LBP/hoplab-wiki/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    HOPLAB-LBP/hoplab-wiki
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../index.html" class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../get-started/index.html" class="md-tabs__link">
          
  
    
  
  Getting started

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../index.html" class="md-tabs__link">
          
  
    
  
  Research

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../outreach.html" class="md-tabs__link">
        
  
    
  
  Science outreach

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../contribute.html" class="md-tabs__link">
        
  
    
  
  Contribute

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="Hoplab Wiki" class="md-nav__button md-logo" aria-label="Hoplab Wiki" data-md-component="logo">
      
  <img src="../../../assets/thicker_white_brain.svg" alt="logo">

    </a>
    Hoplab Wiki
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/HOPLAB-LBP/hoplab-wiki/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    HOPLAB-LBP/hoplab-wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../get-started/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../get-started/useful-links.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful links
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../get-started/mailing-lists.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mailing lists
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../get-started/practical-setup.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Practical set-up
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../get-started/computer-setup.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Computer set-up
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../get-started/admin-procedures.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Administrative procedures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../get-started/student-starter-pack.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Student starter pack
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Research
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Research
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../ethics/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ethical approval
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2" id="__nav_3_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Ethical approval
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ethics/MEC.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EC onderzoek
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ethics/SMEC.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SMEC
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../coding/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Coding practices
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Coding practices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../behaviour/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Behaviour
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4" id="__nav_3_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Behaviour
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../behaviour/participants.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Find participants
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../behaviour/experimental-setup.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Set up your experiment
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    fMRI
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            fMRI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fmri-get-started.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    First steps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fmri-procedure.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scanning procedure and info
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_4" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Analysis workflow
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5_4" id="__nav_3_5_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_5_4">
            <span class="md-nav__icon md-icon"></span>
            Analysis workflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-general.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0. General information
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-setup-env.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Set-up you environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-bids-conversion.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. BIDS conversion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-prepocessing-qa.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Pre-processing and QA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-glm.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4a. First-level analysis - GUI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    4b. First-level analysis - Scripting
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="fmri-glm-script.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    4b. First-level analysis - Scripting
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-start-with-the-spm-gui" class="md-nav__link">
    <span class="md-ellipsis">
      1. Start with the SPM GUI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-understand-the-basics-of-matlabbatch-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      2. Understand the Basics of matlabbatch Jobs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-assembling-matlabbatch-jobs-in-matlab" class="md-nav__link">
    <span class="md-ellipsis">
      3. Assembling matlabbatch Jobs in MATLAB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-executing-the-job-in-matlab" class="md-nav__link">
    <span class="md-ellipsis">
      4. Executing the Job in MATLAB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-organizing-code-in-functions" class="md-nav__link">
    <span class="md-ellipsis">
      5. Organizing Code in Functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-full-code-example" class="md-nav__link">
    <span class="md-ellipsis">
      6. Full code example
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-rois.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Regions of interest
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-mvpa.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Multi-variate analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fmri-andrea-workflow.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fMRI workflow example
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../eeg/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    EEG
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            EEG
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../eyetracking/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Eye-tracking
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            Eye-tracking
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../dnn/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Neural Networks
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Neural Networks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../outreach.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Science outreach
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../contribute.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-start-with-the-spm-gui" class="md-nav__link">
    <span class="md-ellipsis">
      1. Start with the SPM GUI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-understand-the-basics-of-matlabbatch-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      2. Understand the Basics of matlabbatch Jobs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-assembling-matlabbatch-jobs-in-matlab" class="md-nav__link">
    <span class="md-ellipsis">
      3. Assembling matlabbatch Jobs in MATLAB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-executing-the-job-in-matlab" class="md-nav__link">
    <span class="md-ellipsis">
      4. Executing the Job in MATLAB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-organizing-code-in-functions" class="md-nav__link">
    <span class="md-ellipsis">
      5. Organizing Code in Functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-full-code-example" class="md-nav__link">
    <span class="md-ellipsis">
      6. Full code example
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/HOPLAB-LBP/hoplab-wiki/edit/main/docs/research/fmri/analysis/fmri-glm-script.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="introduction-to-spm-scripting-with-matlabbatch">Introduction to SPM Scripting with <code>matlabbatch</code><a class="headerlink" href="#introduction-to-spm-scripting-with-matlabbatch" title="Permanent link">&para;</a></h1>
<p>You should land on this page after having collected your fMRI data, <a href="fmri-bids-conversion.html">converted it to BIDS</a> and <a href="fmri-prepocessing-qa.html">preprocessed it</a>. Your goal now is to model the BOLD activity with a Generalised Linear Model (GLM), in order to obtain the beta values on which to apply further analyses. Here, we do so using SPM (Statistical Parametric Mapping), and by <strong>scripting</strong> the steps taken by SPM. While the SPM GUI makes analysis accessible, scripting with <code>matlabbatch</code> in MATLAB provides a reproducible, automated workflow. This guide introduces you to SPM scripting, from using the GUI to generate code snippets to creating a full multi-step <code>matlabbatch</code> job for SPM.</p>
<p>You should start here if you are familiar with SPM and what it does. If you feel like the analysis steps are still unclear to you, take some time to learn them by using the GUI first. Check out <a href="fmri-glm.html">First-level analysis - GUI</a>.</p>
<hr />
<h2 id="1-start-with-the-spm-gui">1. Start with the SPM GUI<a class="headerlink" href="#1-start-with-the-spm-gui" title="Permanent link">&para;</a></h2>
<p>SPM's GUI is a valuable resource for beginners. It allows you to set analysis parameters interactively and generate corresponding MATLAB code. This method helps you learn which settings are required for each analysis step and understand how they translate into code.</p>
<h3 id="steps-in-the-gui"><strong>Steps in the GUI</strong><a class="headerlink" href="#steps-in-the-gui" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Open SPM</strong> by typing <code>spm fmri</code> in the MATLAB command window, then click <code>Batch</code></li>
<li><strong>Navigate through each analysis step</strong> you want to script. For example, start with <code>fMRI Model Specification</code> under the <code>SPM</code> &rarr; <code>Stats</code> menu.</li>
<li><strong>Set parameters</strong> such as:<ul>
<li>Timing (e.g., Repetition Time, microtime resolution).</li>
<li>Session information (e.g., scans, conditions, and high-pass filter).</li>
</ul>
</li>
<li>
<p><strong>See the code</strong> by clicking on <code>View</code> &rarr; <code>Show .m code</code>.</p>
<p>This should show something like this:</p>
<div class="language-matlab highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&lt;UNDEFINED&gt;&#39;</span><span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">units</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&lt;UNDEFINED&gt;&#39;</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">RT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&lt;UNDEFINED&gt;&#39;</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">fmri_t</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">fmri_t0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;scans&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s">&#39;cond&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s">&#39;multi&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s">&#39;regress&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s">&#39;multi_reg&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s">&#39;hpf&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">fact</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s">&#39;levels&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">bases</span><span class="p">.</span><span class="n">hrf</span><span class="p">.</span><span class="n">derivs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">volt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;None&#39;</span><span class="p">;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">mthresh</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.8</span><span class="p">;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">mask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">};</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">cvi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;AR(1)&#39;</span><span class="p">;</span>
</span></code></pre></div>
</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To use this feature to learn scripting, save several batches with different parameters. Open the generated code to see how each parameter is defined in <code>matlabbatch</code>.</p>
</div>
<p>Here’s an example of how to use the GUI to extract the respective code, here using <strong>fMRI Model Specification</strong> and <strong>Estimation</strong>.</p>
<ol>
<li>
<p><strong>Model Specification</strong>:</p>
<ul>
<li>Go to <strong>SPM &gt; Stats &gt; fMRI Model Specification</strong>.</li>
<li>Set timing parameters (e.g., TR, microtime resolution).</li>
<li>Add conditions and high-pass filter settings.</li>
<li>Save the batch via <strong>File &gt; Save Batch and Script</strong>.</li>
<li>
<p>Open the generated script and review settings like:</p>
<div class="language-matlab highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;/path/to/output&#39;</span><span class="p">};</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">RT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">  </span><span class="c">% Repetition Time in seconds</span>
</span></code></pre></div>
</li>
</ul>
</li>
<li>
<p><strong>Model Estimation</strong>:</p>
<ul>
<li>In the GUI, go to <strong>Stats &gt; Model Estimation</strong>.</li>
<li>Select your <code>SPM.mat</code> file and save the settings.</li>
<li>
<p>Observe that model estimation is added as <code>matlabbatch{2}</code> in the saved script:</p>
<div class="language-matlab highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_est</span><span class="p">.</span><span class="n">spmmat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;/path/to/SPM.mat&#39;</span><span class="p">};</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_est</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">Classical</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c">% Classical estimation</span>
</span></code></pre></div>
</li>
</ul>
</li>
</ol>
<h2 id="2-understand-the-basics-of-matlabbatch-jobs">2. Understand the Basics of <code>matlabbatch</code> Jobs<a class="headerlink" href="#2-understand-the-basics-of-matlabbatch-jobs" title="Permanent link">&para;</a></h2>
<p>The <code>matlabbatch</code> structure in SPM is a versatile container for storing all settings and steps for your analysis. Each field in <code>matlabbatch</code> corresponds to a parameter in the SPM GUI.</p>
<h3 id="key-concepts-of-matlabbatch-jobs"><strong>Key Concepts of <code>matlabbatch</code> Jobs</strong><a class="headerlink" href="#key-concepts-of-matlabbatch-jobs" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Jobs and Batches</strong>: In SPM scripting, "job" refers to a specific processing step (e.g., model specification or estimation), while "batch" is a collection of jobs executed sequentially.</li>
<li><strong>Fields and Indexing</strong>: Each field in <code>matlabbatch</code> corresponds to a specific setting. For example, <code>matlabbatch{1}.spm.stats.fmri_spec.timing.RT</code> sets the repetition time (TR).</li>
<li><strong>Sessions</strong>: Sessions in <code>matlabbatch</code> typically refer to fMRI runs and are indexed using <code>sess(runIdx)</code> for each run in an analysis.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">SPM Batch Workflow</p>
<p>In SPM scripting, all parameters are set first in <code>matlabbatch</code>, then executed together in a single command:</p>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">spm_jobman</span><span class="p">(</span><span class="s">&#39;run&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">matlabbatch</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
</div>
<h2 id="3-assembling-matlabbatch-jobs-in-matlab">3. Assembling <code>matlabbatch</code> Jobs in MATLAB<a class="headerlink" href="#3-assembling-matlabbatch-jobs-in-matlab" title="Permanent link">&para;</a></h2>
<p>With the basics covered, let’s construct a full <code>matlabbatch</code> job in MATLAB. This example demonstrates setting up a simple fMRI model specification, estimation, and contrast definition.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="code-block-full-matlabbatch-example" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="code-block-full-matlabbatch-example">Code Block: Full <code>matlabbatch</code> Example</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c">% Define output directory and timing parameters</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;/path/to/output&#39;</span><span class="p">};</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">RT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">fmri_t</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">fmri_t0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="c">% Define sessions (runs) and scans</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">scans</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;/path/to/run1.nii&#39;</span><span class="p">};</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">cond</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Condition A&#39;</span><span class="p">;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">cond</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">onset</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">];</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">cond</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">duration</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="c">% Model estimation</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_est</span><span class="p">.</span><span class="n">spmmat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;/path/to/output/SPM.mat&#39;</span><span class="p">};</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_est</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">Classical</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="c">% Contrast specification</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">spmmat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;/path/to/output/SPM.mat&#39;</span><span class="p">};</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">consess</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">tcon</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Condition A &gt; Baseline&#39;</span><span class="p">;</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">consess</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">tcon</span><span class="p">.</span><span class="n">weights</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">consess</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">tcon</span><span class="p">.</span><span class="n">sessrep</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;none&#39;</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>Each block in <code>matlabbatch</code> represents one step in the analysis, identical to configuring them in the GUI.</p>
</div>
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This code will run all steps sequentially when you call <code>spm_jobman('run', matlabbatch);</code>. In this example:
- <code>matlabbatch{1}</code> specifies the model.
- <code>matlabbatch{2}</code> estimates the model.
- <code>matlabbatch{3}</code> defines the contrasts.</p>
</div>
<hr />
<h2 id="4-executing-the-job-in-matlab">4. Executing the Job in MATLAB<a class="headerlink" href="#4-executing-the-job-in-matlab" title="Permanent link">&para;</a></h2>
<p>With all steps defined in <code>matlabbatch</code>, execute the entire analysis workflow:</p>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">spm</span><span class="p">(</span><span class="s">&#39;defaults&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fmri&#39;</span><span class="p">);</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">spm_jobman</span><span class="p">(</span><span class="s">&#39;initcfg&#39;</span><span class="p">);</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">spm_jobman</span><span class="p">(</span><span class="s">&#39;run&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">matlabbatch</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li><code>spm('defaults', 'fmri');</code>: Initializes SPM with fMRI defaults.</li>
<li><code>spm_jobman('initcfg');</code>: Prepares the job manager for execution.</li>
<li><code>spm_jobman('run', matlabbatch);</code>: Executes all defined steps in sequence, producing output in the specified directory.</li>
</ul>
<hr />
<h2 id="5-organizing-code-in-functions">5. Organizing Code in Functions<a class="headerlink" href="#5-organizing-code-in-functions" title="Permanent link">&para;</a></h2>
<p>Using functions in MATLAB effectively improves code readability, reduces redundancy, and simplifies maintenance.</p>
<p>Here’s a breakdown of best practices for managing functions in MATLAB, including where to place them and how to add their directory to the MATLAB path.</p>
<h3 id="where-to-place-functions">Where to Place Functions<a class="headerlink" href="#where-to-place-functions" title="Permanent link">&para;</a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="reusable-functions" name="__tabbed_2" type="radio" /><input id="script-specific-functions" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="reusable-functions"><strong>Reusable Functions</strong></label><label for="script-specific-functions"><strong>Script-Specific Functions</strong></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>If a function is intended for use across multiple scripts, it's best to save it as a separate <code>.m</code> file in a designated folder (e.g., <code>scripts/functions</code>). This keeps your code organized and ensures that changes to the function are applied consistently across all scripts.</p>
<p>To make sure MATLAB can locate your function, add the functions folder to the MATLAB path. This can be done in two ways:</p>
<ol>
<li>
<p><strong>Command Line</strong>: Run the following command in the MATLAB command window:</p>
<div class="language-matlab highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nb">addpath</span><span class="p">(</span><span class="s">&#39;/path/to/scripts/functions&#39;</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Using the MATLAB GUI</strong>:</p>
<ul>
<li>Go to <strong>Home &gt; Set Path</strong>.</li>
<li>Click <strong>Add Folder…</strong> and navigate to the folder containing your functions.</li>
<li>Click <strong>Save</strong> to add this path permanently or <strong>Close</strong> to add it temporarily for the session.</li>
</ul>
</li>
</ol>
<p>By adding the folder to your path, the function is accessible across all scripts, ensuring consistency and reducing redundancy.</p>
</div>
<div class="tabbed-block">
<p>If a function is specifically tailored for a single script and not intended for reuse, include it at the end of that script. This keeps the function accessible only within the script, reducing dependencies on external files.</p>
<p>Here’s an example of including a function at the end of a script.</p>
<div class="language-matlab highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c">% Main part of the script</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">myVar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">setup_variable</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c">% Function definition at the end of the script</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">function</span><span class="w"> </span>result<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">setup_variable</span><span class="p">(</span>a, b<span class="p">)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="c">% This function takes two numbers and multiplies them</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="k">end</span>
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="example-creating-a-reusable-function">Example: Creating a Reusable Function<a class="headerlink" href="#example-creating-a-reusable-function" title="Permanent link">&para;</a></h3>
<p>If <code>setup_variable</code> is a function you’ll use frequently, save it as a separate <code>.m</code> file in your <code>functions</code> directory. The function file <code>setup_variable.m</code> might look like this:</p>
<div class="language-matlab highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">function</span><span class="w"> </span>result<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">setup_variable</span><span class="p">(</span>a, b<span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="c">% This function takes two numbers and multiplies them</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="k">end</span>
</span></code></pre></div>
<p>Then, in your main script, you can call the function after adding the functions folder to the path. For example:</p>
<div class="language-matlab highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nb">addpath</span><span class="p">(</span><span class="s">&#39;/path/to/functions&#39;</span><span class="p">);</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">myVar</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">setup_variable</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
</span></code></pre></div>
<hr />
<h2 id="6-full-code-example">6. Full code example<a class="headerlink" href="#6-full-code-example" title="Permanent link">&para;</a></h2>
<p>Once you have a general understanding of using the SPM GUI and <code>matlabbatch</code> scripting, you’re ready to try more advanced scripting techniques. This final section provides a complete example script that integrates everything covered so far. Specifically, the script below:</p>
<ul>
<li>Sets up essential parameters and paths for analyzing fMRI data,</li>
<li>Loads event and confound files for each run,</li>
<li>Specifies, estimates, and applies contrasts for a General Linear Model (GLM) in SPM,</li>
<li>Saves the final model and a copy of the script for reproducibility.</li>
</ul>
<p>Below, you’ll find the main script, <code>performGLMAutoContrast.m</code>, which performs all these steps, and all required functions to execute the script. Most of the  functions are completely stand-alone, and can be used in your own projects (e.g., <code>smoothNiftiFile</code>, <code>gunzipNiftiFile</code>, <code>fMRIprepConfounds2SPM</code>, <code>eventsBIDS2SPM</code>).</p>
<p>These functions can either be saved as standalone <code>.m</code> files in a <code>functions</code> folder (e.g., <code>setup_model_specification.m</code>) or simply copy-pasted at the end of the script for direct use. If you choose to save functions as standalone files, make sure the filename exactly matches the function name (e.g., <code>setup_model_specification.m</code> for a function called <code>setup_model_specification</code>). This ensures MATLAB can locate and run the function correctly.</p>
<details class="example">
<summary>performGLMAutoContrast.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">  1</a></span>
<span class="normal"><a href="#__codelineno-10-2">  2</a></span>
<span class="normal"><a href="#__codelineno-10-3">  3</a></span>
<span class="normal"><a href="#__codelineno-10-4">  4</a></span>
<span class="normal"><a href="#__codelineno-10-5">  5</a></span>
<span class="normal"><a href="#__codelineno-10-6">  6</a></span>
<span class="normal"><a href="#__codelineno-10-7">  7</a></span>
<span class="normal"><a href="#__codelineno-10-8">  8</a></span>
<span class="normal"><a href="#__codelineno-10-9">  9</a></span>
<span class="normal"><a href="#__codelineno-10-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-10-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-10-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-10-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-10-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-10-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-10-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-10-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-10-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-10-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-10-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-10-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-10-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-10-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-10-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-10-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-10-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-10-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-10-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-10-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-10-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-10-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-10-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-10-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-10-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-10-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-10-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-10-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-10-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-10-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-10-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-10-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-10-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-10-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-10-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-10-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-10-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-10-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-10-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-10-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-10-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-10-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-10-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-10-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-10-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-10-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-10-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-10-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-10-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-10-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-10-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-10-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-10-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-10-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-10-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-10-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-10-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-10-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-10-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-10-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-10-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-10-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-10-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-10-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-10-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-10-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-10-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-10-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-10-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-10-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-10-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-10-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-10-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-10-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-10-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-10-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-10-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-10-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-10-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-10-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-10-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-10-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-10-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-10-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-10-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-10-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-10-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-10-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-10-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-10-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-10-100">100</a></span>
<span class="normal"><a href="#__codelineno-10-101">101</a></span>
<span class="normal"><a href="#__codelineno-10-102">102</a></span>
<span class="normal"><a href="#__codelineno-10-103">103</a></span>
<span class="normal"><a href="#__codelineno-10-104">104</a></span>
<span class="normal"><a href="#__codelineno-10-105">105</a></span>
<span class="normal"><a href="#__codelineno-10-106">106</a></span>
<span class="normal"><a href="#__codelineno-10-107">107</a></span>
<span class="normal"><a href="#__codelineno-10-108">108</a></span>
<span class="normal"><a href="#__codelineno-10-109">109</a></span>
<span class="normal"><a href="#__codelineno-10-110">110</a></span>
<span class="normal"><a href="#__codelineno-10-111">111</a></span>
<span class="normal"><a href="#__codelineno-10-112">112</a></span>
<span class="normal"><a href="#__codelineno-10-113">113</a></span>
<span class="normal"><a href="#__codelineno-10-114">114</a></span>
<span class="normal"><a href="#__codelineno-10-115">115</a></span>
<span class="normal"><a href="#__codelineno-10-116">116</a></span>
<span class="normal"><a href="#__codelineno-10-117">117</a></span>
<span class="normal"><a href="#__codelineno-10-118">118</a></span>
<span class="normal"><a href="#__codelineno-10-119">119</a></span>
<span class="normal"><a href="#__codelineno-10-120">120</a></span>
<span class="normal"><a href="#__codelineno-10-121">121</a></span>
<span class="normal"><a href="#__codelineno-10-122">122</a></span>
<span class="normal"><a href="#__codelineno-10-123">123</a></span>
<span class="normal"><a href="#__codelineno-10-124">124</a></span>
<span class="normal"><a href="#__codelineno-10-125">125</a></span>
<span class="normal"><a href="#__codelineno-10-126">126</a></span>
<span class="normal"><a href="#__codelineno-10-127">127</a></span>
<span class="normal"><a href="#__codelineno-10-128">128</a></span>
<span class="normal"><a href="#__codelineno-10-129">129</a></span>
<span class="normal"><a href="#__codelineno-10-130">130</a></span>
<span class="normal"><a href="#__codelineno-10-131">131</a></span>
<span class="normal"><a href="#__codelineno-10-132">132</a></span>
<span class="normal"><a href="#__codelineno-10-133">133</a></span>
<span class="normal"><a href="#__codelineno-10-134">134</a></span>
<span class="normal"><a href="#__codelineno-10-135">135</a></span>
<span class="normal"><a href="#__codelineno-10-136">136</a></span>
<span class="normal"><a href="#__codelineno-10-137">137</a></span>
<span class="normal"><a href="#__codelineno-10-138">138</a></span>
<span class="normal"><a href="#__codelineno-10-139">139</a></span>
<span class="normal"><a href="#__codelineno-10-140">140</a></span>
<span class="normal"><a href="#__codelineno-10-141">141</a></span>
<span class="normal"><a href="#__codelineno-10-142">142</a></span>
<span class="normal"><a href="#__codelineno-10-143">143</a></span>
<span class="normal"><a href="#__codelineno-10-144">144</a></span>
<span class="normal"><a href="#__codelineno-10-145">145</a></span>
<span class="normal"><a href="#__codelineno-10-146">146</a></span>
<span class="normal"><a href="#__codelineno-10-147">147</a></span>
<span class="normal"><a href="#__codelineno-10-148">148</a></span>
<span class="normal"><a href="#__codelineno-10-149">149</a></span>
<span class="normal"><a href="#__codelineno-10-150">150</a></span>
<span class="normal"><a href="#__codelineno-10-151">151</a></span>
<span class="normal"><a href="#__codelineno-10-152">152</a></span>
<span class="normal"><a href="#__codelineno-10-153">153</a></span>
<span class="normal"><a href="#__codelineno-10-154">154</a></span>
<span class="normal"><a href="#__codelineno-10-155">155</a></span>
<span class="normal"><a href="#__codelineno-10-156">156</a></span>
<span class="normal"><a href="#__codelineno-10-157">157</a></span>
<span class="normal"><a href="#__codelineno-10-158">158</a></span>
<span class="normal"><a href="#__codelineno-10-159">159</a></span>
<span class="normal"><a href="#__codelineno-10-160">160</a></span>
<span class="normal"><a href="#__codelineno-10-161">161</a></span>
<span class="normal"><a href="#__codelineno-10-162">162</a></span>
<span class="normal"><a href="#__codelineno-10-163">163</a></span>
<span class="normal"><a href="#__codelineno-10-164">164</a></span>
<span class="normal"><a href="#__codelineno-10-165">165</a></span>
<span class="normal"><a href="#__codelineno-10-166">166</a></span>
<span class="normal"><a href="#__codelineno-10-167">167</a></span>
<span class="normal"><a href="#__codelineno-10-168">168</a></span>
<span class="normal"><a href="#__codelineno-10-169">169</a></span>
<span class="normal"><a href="#__codelineno-10-170">170</a></span>
<span class="normal"><a href="#__codelineno-10-171">171</a></span>
<span class="normal"><a href="#__codelineno-10-172">172</a></span>
<span class="normal"><a href="#__codelineno-10-173">173</a></span>
<span class="normal"><a href="#__codelineno-10-174">174</a></span>
<span class="normal"><a href="#__codelineno-10-175">175</a></span>
<span class="normal"><a href="#__codelineno-10-176">176</a></span>
<span class="normal"><a href="#__codelineno-10-177">177</a></span>
<span class="normal"><a href="#__codelineno-10-178">178</a></span>
<span class="normal"><a href="#__codelineno-10-179">179</a></span>
<span class="normal"><a href="#__codelineno-10-180">180</a></span>
<span class="normal"><a href="#__codelineno-10-181">181</a></span>
<span class="normal"><a href="#__codelineno-10-182">182</a></span>
<span class="normal"><a href="#__codelineno-10-183">183</a></span>
<span class="normal"><a href="#__codelineno-10-184">184</a></span>
<span class="normal"><a href="#__codelineno-10-185">185</a></span>
<span class="normal"><a href="#__codelineno-10-186">186</a></span>
<span class="normal"><a href="#__codelineno-10-187">187</a></span>
<span class="normal"><a href="#__codelineno-10-188">188</a></span>
<span class="normal"><a href="#__codelineno-10-189">189</a></span>
<span class="normal"><a href="#__codelineno-10-190">190</a></span>
<span class="normal"><a href="#__codelineno-10-191">191</a></span>
<span class="normal"><a href="#__codelineno-10-192">192</a></span>
<span class="normal"><a href="#__codelineno-10-193">193</a></span>
<span class="normal"><a href="#__codelineno-10-194">194</a></span>
<span class="normal"><a href="#__codelineno-10-195">195</a></span>
<span class="normal"><a href="#__codelineno-10-196">196</a></span>
<span class="normal"><a href="#__codelineno-10-197">197</a></span>
<span class="normal"><a href="#__codelineno-10-198">198</a></span>
<span class="normal"><a href="#__codelineno-10-199">199</a></span>
<span class="normal"><a href="#__codelineno-10-200">200</a></span>
<span class="normal"><a href="#__codelineno-10-201">201</a></span>
<span class="normal"><a href="#__codelineno-10-202">202</a></span>
<span class="normal"><a href="#__codelineno-10-203">203</a></span>
<span class="normal"><a href="#__codelineno-10-204">204</a></span>
<span class="normal"><a href="#__codelineno-10-205">205</a></span>
<span class="normal"><a href="#__codelineno-10-206">206</a></span>
<span class="normal"><a href="#__codelineno-10-207">207</a></span>
<span class="normal"><a href="#__codelineno-10-208">208</a></span>
<span class="normal"><a href="#__codelineno-10-209">209</a></span>
<span class="normal"><a href="#__codelineno-10-210">210</a></span>
<span class="normal"><a href="#__codelineno-10-211">211</a></span>
<span class="normal"><a href="#__codelineno-10-212">212</a></span>
<span class="normal"><a href="#__codelineno-10-213">213</a></span>
<span class="normal"><a href="#__codelineno-10-214">214</a></span>
<span class="normal"><a href="#__codelineno-10-215">215</a></span>
<span class="normal"><a href="#__codelineno-10-216">216</a></span>
<span class="normal"><a href="#__codelineno-10-217">217</a></span>
<span class="normal"><a href="#__codelineno-10-218">218</a></span>
<span class="normal"><a href="#__codelineno-10-219">219</a></span>
<span class="normal"><a href="#__codelineno-10-220">220</a></span>
<span class="normal"><a href="#__codelineno-10-221">221</a></span>
<span class="normal"><a href="#__codelineno-10-222">222</a></span>
<span class="normal"><a href="#__codelineno-10-223">223</a></span>
<span class="normal"><a href="#__codelineno-10-224">224</a></span>
<span class="normal"><a href="#__codelineno-10-225">225</a></span>
<span class="normal"><a href="#__codelineno-10-226">226</a></span>
<span class="normal"><a href="#__codelineno-10-227">227</a></span>
<span class="normal"><a href="#__codelineno-10-228">228</a></span>
<span class="normal"><a href="#__codelineno-10-229">229</a></span>
<span class="normal"><a href="#__codelineno-10-230">230</a></span>
<span class="normal"><a href="#__codelineno-10-231">231</a></span>
<span class="normal"><a href="#__codelineno-10-232">232</a></span>
<span class="normal"><a href="#__codelineno-10-233">233</a></span>
<span class="normal"><a href="#__codelineno-10-234">234</a></span>
<span class="normal"><a href="#__codelineno-10-235">235</a></span>
<span class="normal"><a href="#__codelineno-10-236">236</a></span>
<span class="normal"><a href="#__codelineno-10-237">237</a></span>
<span class="normal"><a href="#__codelineno-10-238">238</a></span>
<span class="normal"><a href="#__codelineno-10-239">239</a></span>
<span class="normal"><a href="#__codelineno-10-240">240</a></span>
<span class="normal"><a href="#__codelineno-10-241">241</a></span>
<span class="normal"><a href="#__codelineno-10-242">242</a></span>
<span class="normal"><a href="#__codelineno-10-243">243</a></span>
<span class="normal"><a href="#__codelineno-10-244">244</a></span>
<span class="normal"><a href="#__codelineno-10-245">245</a></span>
<span class="normal"><a href="#__codelineno-10-246">246</a></span>
<span class="normal"><a href="#__codelineno-10-247">247</a></span>
<span class="normal"><a href="#__codelineno-10-248">248</a></span>
<span class="normal"><a href="#__codelineno-10-249">249</a></span>
<span class="normal"><a href="#__codelineno-10-250">250</a></span>
<span class="normal"><a href="#__codelineno-10-251">251</a></span>
<span class="normal"><a href="#__codelineno-10-252">252</a></span>
<span class="normal"><a href="#__codelineno-10-253">253</a></span>
<span class="normal"><a href="#__codelineno-10-254">254</a></span>
<span class="normal"><a href="#__codelineno-10-255">255</a></span>
<span class="normal"><a href="#__codelineno-10-256">256</a></span>
<span class="normal"><a href="#__codelineno-10-257">257</a></span>
<span class="normal"><a href="#__codelineno-10-258">258</a></span>
<span class="normal"><a href="#__codelineno-10-259">259</a></span>
<span class="normal"><a href="#__codelineno-10-260">260</a></span>
<span class="normal"><a href="#__codelineno-10-261">261</a></span>
<span class="normal"><a href="#__codelineno-10-262">262</a></span>
<span class="normal"><a href="#__codelineno-10-263">263</a></span>
<span class="normal"><a href="#__codelineno-10-264">264</a></span>
<span class="normal"><a href="#__codelineno-10-265">265</a></span>
<span class="normal"><a href="#__codelineno-10-266">266</a></span>
<span class="normal"><a href="#__codelineno-10-267">267</a></span>
<span class="normal"><a href="#__codelineno-10-268">268</a></span>
<span class="normal"><a href="#__codelineno-10-269">269</a></span>
<span class="normal"><a href="#__codelineno-10-270">270</a></span>
<span class="normal"><a href="#__codelineno-10-271">271</a></span>
<span class="normal"><a href="#__codelineno-10-272">272</a></span>
<span class="normal"><a href="#__codelineno-10-273">273</a></span>
<span class="normal"><a href="#__codelineno-10-274">274</a></span>
<span class="normal"><a href="#__codelineno-10-275">275</a></span>
<span class="normal"><a href="#__codelineno-10-276">276</a></span>
<span class="normal"><a href="#__codelineno-10-277">277</a></span>
<span class="normal"><a href="#__codelineno-10-278">278</a></span>
<span class="normal"><a href="#__codelineno-10-279">279</a></span>
<span class="normal"><a href="#__codelineno-10-280">280</a></span>
<span class="normal"><a href="#__codelineno-10-281">281</a></span>
<span class="normal"><a href="#__codelineno-10-282">282</a></span>
<span class="normal"><a href="#__codelineno-10-283">283</a></span>
<span class="normal"><a href="#__codelineno-10-284">284</a></span>
<span class="normal"><a href="#__codelineno-10-285">285</a></span>
<span class="normal"><a href="#__codelineno-10-286">286</a></span>
<span class="normal"><a href="#__codelineno-10-287">287</a></span>
<span class="normal"><a href="#__codelineno-10-288">288</a></span>
<span class="normal"><a href="#__codelineno-10-289">289</a></span>
<span class="normal"><a href="#__codelineno-10-290">290</a></span>
<span class="normal"><a href="#__codelineno-10-291">291</a></span>
<span class="normal"><a href="#__codelineno-10-292">292</a></span>
<span class="normal"><a href="#__codelineno-10-293">293</a></span>
<span class="normal"><a href="#__codelineno-10-294">294</a></span>
<span class="normal"><a href="#__codelineno-10-295">295</a></span>
<span class="normal"><a href="#__codelineno-10-296">296</a></span>
<span class="normal"><a href="#__codelineno-10-297">297</a></span>
<span class="normal"><a href="#__codelineno-10-298">298</a></span>
<span class="normal"><a href="#__codelineno-10-299">299</a></span>
<span class="normal"><a href="#__codelineno-10-300">300</a></span>
<span class="normal"><a href="#__codelineno-10-301">301</a></span>
<span class="normal"><a href="#__codelineno-10-302">302</a></span>
<span class="normal"><a href="#__codelineno-10-303">303</a></span>
<span class="normal"><a href="#__codelineno-10-304">304</a></span>
<span class="normal"><a href="#__codelineno-10-305">305</a></span>
<span class="normal"><a href="#__codelineno-10-306">306</a></span>
<span class="normal"><a href="#__codelineno-10-307">307</a></span>
<span class="normal"><a href="#__codelineno-10-308">308</a></span>
<span class="normal"><a href="#__codelineno-10-309">309</a></span>
<span class="normal"><a href="#__codelineno-10-310">310</a></span>
<span class="normal"><a href="#__codelineno-10-311">311</a></span>
<span class="normal"><a href="#__codelineno-10-312">312</a></span>
<span class="normal"><a href="#__codelineno-10-313">313</a></span>
<span class="normal"><a href="#__codelineno-10-314">314</a></span>
<span class="normal"><a href="#__codelineno-10-315">315</a></span>
<span class="normal"><a href="#__codelineno-10-316">316</a></span>
<span class="normal"><a href="#__codelineno-10-317">317</a></span>
<span class="normal"><a href="#__codelineno-10-318">318</a></span>
<span class="normal"><a href="#__codelineno-10-319">319</a></span>
<span class="normal"><a href="#__codelineno-10-320">320</a></span>
<span class="normal"><a href="#__codelineno-10-321">321</a></span>
<span class="normal"><a href="#__codelineno-10-322">322</a></span>
<span class="normal"><a href="#__codelineno-10-323">323</a></span>
<span class="normal"><a href="#__codelineno-10-324">324</a></span>
<span class="normal"><a href="#__codelineno-10-325">325</a></span>
<span class="normal"><a href="#__codelineno-10-326">326</a></span>
<span class="normal"><a href="#__codelineno-10-327">327</a></span>
<span class="normal"><a href="#__codelineno-10-328">328</a></span>
<span class="normal"><a href="#__codelineno-10-329">329</a></span>
<span class="normal"><a href="#__codelineno-10-330">330</a></span>
<span class="normal"><a href="#__codelineno-10-331">331</a></span>
<span class="normal"><a href="#__codelineno-10-332">332</a></span>
<span class="normal"><a href="#__codelineno-10-333">333</a></span>
<span class="normal"><a href="#__codelineno-10-334">334</a></span>
<span class="normal"><a href="#__codelineno-10-335">335</a></span>
<span class="normal"><a href="#__codelineno-10-336">336</a></span>
<span class="normal"><a href="#__codelineno-10-337">337</a></span>
<span class="normal"><a href="#__codelineno-10-338">338</a></span>
<span class="normal"><a href="#__codelineno-10-339">339</a></span>
<span class="normal"><a href="#__codelineno-10-340">340</a></span>
<span class="normal"><a href="#__codelineno-10-341">341</a></span>
<span class="normal"><a href="#__codelineno-10-342">342</a></span>
<span class="normal"><a href="#__codelineno-10-343">343</a></span>
<span class="normal"><a href="#__codelineno-10-344">344</a></span>
<span class="normal"><a href="#__codelineno-10-345">345</a></span>
<span class="normal"><a href="#__codelineno-10-346">346</a></span>
<span class="normal"><a href="#__codelineno-10-347">347</a></span>
<span class="normal"><a href="#__codelineno-10-348">348</a></span>
<span class="normal"><a href="#__codelineno-10-349">349</a></span>
<span class="normal"><a href="#__codelineno-10-350">350</a></span>
<span class="normal"><a href="#__codelineno-10-351">351</a></span>
<span class="normal"><a href="#__codelineno-10-352">352</a></span>
<span class="normal"><a href="#__codelineno-10-353">353</a></span>
<span class="normal"><a href="#__codelineno-10-354">354</a></span>
<span class="normal"><a href="#__codelineno-10-355">355</a></span>
<span class="normal"><a href="#__codelineno-10-356">356</a></span>
<span class="normal"><a href="#__codelineno-10-357">357</a></span>
<span class="normal"><a href="#__codelineno-10-358">358</a></span>
<span class="normal"><a href="#__codelineno-10-359">359</a></span>
<span class="normal"><a href="#__codelineno-10-360">360</a></span>
<span class="normal"><a href="#__codelineno-10-361">361</a></span>
<span class="normal"><a href="#__codelineno-10-362">362</a></span>
<span class="normal"><a href="#__codelineno-10-363">363</a></span>
<span class="normal"><a href="#__codelineno-10-364">364</a></span>
<span class="normal"><a href="#__codelineno-10-365">365</a></span>
<span class="normal"><a href="#__codelineno-10-366">366</a></span>
<span class="normal"><a href="#__codelineno-10-367">367</a></span>
<span class="normal"><a href="#__codelineno-10-368">368</a></span>
<span class="normal"><a href="#__codelineno-10-369">369</a></span>
<span class="normal"><a href="#__codelineno-10-370">370</a></span>
<span class="normal"><a href="#__codelineno-10-371">371</a></span>
<span class="normal"><a href="#__codelineno-10-372">372</a></span>
<span class="normal"><a href="#__codelineno-10-373">373</a></span>
<span class="normal"><a href="#__codelineno-10-374">374</a></span>
<span class="normal"><a href="#__codelineno-10-375">375</a></span>
<span class="normal"><a href="#__codelineno-10-376">376</a></span>
<span class="normal"><a href="#__codelineno-10-377">377</a></span>
<span class="normal"><a href="#__codelineno-10-378">378</a></span>
<span class="normal"><a href="#__codelineno-10-379">379</a></span>
<span class="normal"><a href="#__codelineno-10-380">380</a></span>
<span class="normal"><a href="#__codelineno-10-381">381</a></span>
<span class="normal"><a href="#__codelineno-10-382">382</a></span>
<span class="normal"><a href="#__codelineno-10-383">383</a></span>
<span class="normal"><a href="#__codelineno-10-384">384</a></span>
<span class="normal"><a href="#__codelineno-10-385">385</a></span>
<span class="normal"><a href="#__codelineno-10-386">386</a></span>
<span class="normal"><a href="#__codelineno-10-387">387</a></span>
<span class="normal"><a href="#__codelineno-10-388">388</a></span>
<span class="normal"><a href="#__codelineno-10-389">389</a></span>
<span class="normal"><a href="#__codelineno-10-390">390</a></span>
<span class="normal"><a href="#__codelineno-10-391">391</a></span>
<span class="normal"><a href="#__codelineno-10-392">392</a></span>
<span class="normal"><a href="#__codelineno-10-393">393</a></span>
<span class="normal"><a href="#__codelineno-10-394">394</a></span>
<span class="normal"><a href="#__codelineno-10-395">395</a></span>
<span class="normal"><a href="#__codelineno-10-396">396</a></span>
<span class="normal"><a href="#__codelineno-10-397">397</a></span>
<span class="normal"><a href="#__codelineno-10-398">398</a></span>
<span class="normal"><a href="#__codelineno-10-399">399</a></span>
<span class="normal"><a href="#__codelineno-10-400">400</a></span>
<span class="normal"><a href="#__codelineno-10-401">401</a></span>
<span class="normal"><a href="#__codelineno-10-402">402</a></span>
<span class="normal"><a href="#__codelineno-10-403">403</a></span>
<span class="normal"><a href="#__codelineno-10-404">404</a></span>
<span class="normal"><a href="#__codelineno-10-405">405</a></span>
<span class="normal"><a href="#__codelineno-10-406">406</a></span>
<span class="normal"><a href="#__codelineno-10-407">407</a></span>
<span class="normal"><a href="#__codelineno-10-408">408</a></span>
<span class="normal"><a href="#__codelineno-10-409">409</a></span>
<span class="normal"><a href="#__codelineno-10-410">410</a></span>
<span class="normal"><a href="#__codelineno-10-411">411</a></span>
<span class="normal"><a href="#__codelineno-10-412">412</a></span>
<span class="normal"><a href="#__codelineno-10-413">413</a></span>
<span class="normal"><a href="#__codelineno-10-414">414</a></span>
<span class="normal"><a href="#__codelineno-10-415">415</a></span>
<span class="normal"><a href="#__codelineno-10-416">416</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c">% GLM Analysis Script for fMRI Data using SPM</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="c">%</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="c">% This script performs a General Linear Model (GLM) analysis on fMRI data that has been preprocessed using fMRIprep and</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="c">% is organized in BIDS format. It is designed to run in MATLAB using SPM, specifically for researchers who may be</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="c">% unfamiliar with SPM scripting but have fMRI data analysis needs. The script follows standard steps for GLM setup,</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="c">% specification, estimation, and contrast definition, which are essential in understanding task-related brain activity.</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="c">%</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="c">% Overview of What This Script Does:</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="c">% - Sets up paths and parameters.</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="c">% - Loads event and confound data for each run and prepares it for GLM analysis.</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="c">% - Specifies the GLM parameters, including timing, high-pass filter, and basis function.</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="c">% - Runs model specification and estimation to fit the GLM to the fMRI data.</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="c">% - Defines contrasts to test specific hypotheses.</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="c">% - Saves the final model and a copy of this script for future reference.</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="c">%</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="c">% Steps in this Script:</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="c">% 1. **Set Parameters**: Define paths to data, fMRI timing parameters, selected tasks, contrasts, and subjects.</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="c">% 2. **Load Events and Confounds**: Each run`s event (trial timing) and confound (noise regressors) data are loaded</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="c">%    from BIDS-compliant TSV and JSON files produced by fMRIprep. This prepares each run for GLM analysis.</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="c">% 3. **SPM Model Specification**: Sets up a structure (called`matlabbatch`) that stores all necessary parameters</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="c">%    for defining the GLM model. Each parameter here mirrors options in the SPM GUI.</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="c">% 4. **Run Model Specification and Estimation**: Once all parameters are set in`matlabbatch`, we run batches 1</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="c">%    and 2. Batch 1 specifies the model, and batch 2 estimates the model using the data and settings we’ve defined.</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="c">% 5. **Check SPM.mat File**: Verifies the existence of the SPM.mat file after running the model, confirming the</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="c">%    model specification and estimation steps were successful.</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="c">% 6. **Define and Run Contrasts**: Sets up contrasts based on hypotheses about brain activity, applies them, and</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="c">%    stores results. This is done in batch 3.</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="c">% 7. **Save Script**: Saves a copy of this script in the output folder for reproducibility and future reference.</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29"></a>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="c">% Working with matlabbatch and SPM Batches:</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="c">% - `matlabbatch` is a structure used by SPM to store each step of an analysis, organized as separate fields for </span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="c">%   each processing stage (e.g., model specification, model estimation, contrast definition). Each entry in </span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="c">%   `matlabbatch` corresponds to a batch operation you could run manually in the SPM GUI. SPM’s batch system is </span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="c">%   powerful because it allows us to set parameters programmatically in a way that is identical to the GUI.</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="c">% - **Setting Parameters**: Each field in `matlabbatch` represents a setting or action, matching options in the </span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="c">%   SPM GUI. For example, in this script, `matlabbatch{1}.spm.stats.fmri_spec.timing.RT` corresponds to setting </span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="c">%   the Repetition Time (RT) in the SPM GUI.</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="c">% - **Retrieving GUI Code**: To see the code for any parameter set in the SPM GUI, configure the GUI settings and </span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="c">%   then select **File &gt; Save Batch and Script**. SPM will generate MATLAB code that mirrors the GUI settings, </span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="c">%   which you can use to understand how `matlabbatch` fields align with GUI options.</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="c">%</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="c">% Understanding SPM Batches and Sessions:</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="c">% - In SPM, **sessions** represent individual runs in a study. Each run (session) is specified separately within </span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="c">%   `matlabbatch`, which enables you to specify different conditions or timing settings per run if necessary.</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="c">% - We use indexing within `matlabbatch` to indicate which session or contrast we’re defining. For instance, </span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="c">%   `matlabbatch{1}.spm.stats.fmri_spec.sess(runIdx).scans` refers to the scans (images) in session `runIdx`.</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47"></a><span class="c">%</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48"></a><span class="c">% How SPM Executes Batches:</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49"></a><span class="c">% - SPM uses a deferred execution approach: parameters are specified first by configuring `matlabbatch`, and </span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50"></a><span class="c">%   then `spm_jobman(&#39;run&#39;, matlabbatch)` initiates all specified processing steps in sequence, similar to </span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51"></a><span class="c">%   clicking &quot;Run&quot; in the GUI. In this script, we define `matlabbatch` elements in sequence (batches 1 to 3) </span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52"></a><span class="c">%   and run them together in one command to automate the workflow.</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="c">%</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="c">% Assumptions about Input Data:</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55"></a><span class="c">% - Data must be preprocessed using fMRIprep and follow the BIDS format.</span>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56"></a><span class="c">% - Event files (in TSV format) must adhere to BIDS specifications.</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57"></a><span class="c">% - Confound files (in JSON and TSV formats) must adhere to fMRIprep output standards.</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58"></a><span class="c">%</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59"></a><span class="c">% Requirements:</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60"></a><span class="c">% - SPM12 (or a compatible version) must be installed and added to the MATLAB path.</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61"></a><span class="c">%</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62"></a><span class="c">% Note: This script automates the process typically done in the SPM GUI.</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63"></a>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64"></a><span class="c">% Parameters:</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65"></a><span class="c">% - selectedSubjectsList: List of subject IDs to include in the analysis. Can be a list of integers or &#39;*&#39; to include all subjects.</span>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66"></a><span class="c">% - selectedRuns: List of run numbers to include in the analysis. Can be a list of integers or &#39;*&#39; to include all runs.</span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67"></a><span class="c">% - selectedTasks: Structure array with information about the task(s) to analyze.</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68"></a><span class="c">%     Each task must have the following fields:</span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69"></a><span class="c">%     - name: String. The name of the task.</span>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70"></a><span class="c">%     - contrasts: Cell array of strings. The name(s) of the contrast(s).</span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71"></a><span class="c">%     - weights: Cell array of structs. The weights for the contrast(s).</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72"></a><span class="c">%     - smoothBool: Boolean. Whether to smooth the data before the GLM.</span>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73"></a><span class="c">%</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74"></a><span class="c">% Example of defining tasks, weights, and contrasts:</span>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75"></a><span class="c">% selectedTasks(1).name = &#39;loc&#39;;</span>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76"></a><span class="c">% selectedTasks(1).contrasts = {&#39;Faces &gt; Objects&#39;, &#39;Objects &gt; Scrambled&#39;, &#39;Scenes &gt; Objects&#39;};</span>
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77"></a><span class="c">% selectedTasks(1).weights(1) = struct(&#39;Faces&#39;, 1, &#39;Objects&#39;, -1, &#39;Scrambled&#39;, 0, &#39;Scenes&#39;, 0);</span>
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78"></a><span class="c">% selectedTasks(1).weights(2) = struct(&#39;Faces&#39;, 0, &#39;Objects&#39;, 1, &#39;Scrambled&#39;, -1, &#39;Scenes&#39;, 0);</span>
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79"></a><span class="c">% selectedTasks(1).weights(3) = struct(&#39;Faces&#39;, 0, &#39;Objects&#39;, -1, &#39;Scrambled&#39;, 0, &#39;Scenes&#39;, 1);</span>
</span><span id="__span-10-80"><a id="__codelineno-10-80" name="__codelineno-10-80"></a><span class="c">% selectedTasks(1).smoothBool = true;</span>
</span><span id="__span-10-81"><a id="__codelineno-10-81" name="__codelineno-10-81"></a><span class="c">%</span>
</span><span id="__span-10-82"><a id="__codelineno-10-82" name="__codelineno-10-82"></a><span class="c">% Paths:</span>
</span><span id="__span-10-83"><a id="__codelineno-10-83" name="__codelineno-10-83"></a><span class="c">% - fmriprepRoot: Path to the root folder of the fMRIprep output.</span>
</span><span id="__span-10-84"><a id="__codelineno-10-84" name="__codelineno-10-84"></a><span class="c">% - BIDSRoot: Path to the root folder of the BIDS dataset.</span>
</span><span id="__span-10-85"><a id="__codelineno-10-85" name="__codelineno-10-85"></a><span class="c">% - outRoot: Path to the output root folder for the analysis results.</span>
</span><span id="__span-10-86"><a id="__codelineno-10-86" name="__codelineno-10-86"></a><span class="c">%</span>
</span><span id="__span-10-87"><a id="__codelineno-10-87" name="__codelineno-10-87"></a><span class="c">% Preprocessing Options (uses fMRIprep confounds table):</span>
</span><span id="__span-10-88"><a id="__codelineno-10-88" name="__codelineno-10-88"></a><span class="c">% - pipeline: Denoising pipeline strategy for SPM confound regression.</span>
</span><span id="__span-10-89"><a id="__codelineno-10-89" name="__codelineno-10-89"></a><span class="c">%     It should be a cell array of strings specifying the strategies to use.</span>
</span><span id="__span-10-90"><a id="__codelineno-10-90" name="__codelineno-10-90"></a><span class="c">%     Possible strategies:</span>
</span><span id="__span-10-91"><a id="__codelineno-10-91" name="__codelineno-10-91"></a><span class="c">%         HMP - Head motion parameters (6,12,24)</span>
</span><span id="__span-10-92"><a id="__codelineno-10-92" name="__codelineno-10-92"></a><span class="c">%         GS - Brain mask global signal (1,2,4)</span>
</span><span id="__span-10-93"><a id="__codelineno-10-93" name="__codelineno-10-93"></a><span class="c">%         CSF_WM - CSF and WM masks global signal (2,4,8)</span>
</span><span id="__span-10-94"><a id="__codelineno-10-94" name="__codelineno-10-94"></a><span class="c">%         aCompCor - aCompCor (10,50)</span>
</span><span id="__span-10-95"><a id="__codelineno-10-95" name="__codelineno-10-95"></a><span class="c">%         MotionOutlier - motion outliers FD &gt; 0.5, DVARS &gt; 1.5, non-steady volumes</span>
</span><span id="__span-10-96"><a id="__codelineno-10-96" name="__codelineno-10-96"></a><span class="c">%         Cosine - Discrete cosine-basis regressors (low frequencies) -&gt; HPF</span>
</span><span id="__span-10-97"><a id="__codelineno-10-97" name="__codelineno-10-97"></a><span class="c">%         FD - Raw framewise displacement</span>
</span><span id="__span-10-98"><a id="__codelineno-10-98" name="__codelineno-10-98"></a><span class="c">%         Null - Returns a blank data frame</span>
</span><span id="__span-10-99"><a id="__codelineno-10-99" name="__codelineno-10-99"></a><span class="c">%</span>
</span><span id="__span-10-100"><a id="__codelineno-10-100" name="__codelineno-10-100"></a><span class="c">% Example:</span>
</span><span id="__span-10-101"><a id="__codelineno-10-101" name="__codelineno-10-101"></a><span class="c">% pipeline = {&#39;HMP-6&#39;,&#39;GS-1&#39;,&#39;FD&#39;};</span>
</span><span id="__span-10-102"><a id="__codelineno-10-102" name="__codelineno-10-102"></a><span class="c">% This selects the 6 head motion parameters, the global signal, and the raw Framewise Displacement value.</span>
</span><span id="__span-10-103"><a id="__codelineno-10-103" name="__codelineno-10-103"></a><span class="c">%</span>
</span><span id="__span-10-104"><a id="__codelineno-10-104" name="__codelineno-10-104"></a><span class="c">% Author: Andrea Ivan Costantino</span>
</span><span id="__span-10-105"><a id="__codelineno-10-105" name="__codelineno-10-105"></a><span class="c">% Date: 5 July 2023</span>
</span><span id="__span-10-106"><a id="__codelineno-10-106" name="__codelineno-10-106"></a>
</span><span id="__span-10-107"><a id="__codelineno-10-107" name="__codelineno-10-107"></a><span class="c">% This section of the script defines parameters and settings necessary for a GLM analysis in SPM, using fMRI data</span>
</span><span id="__span-10-108"><a id="__codelineno-10-108" name="__codelineno-10-108"></a><span class="c">% preprocessed with fMRIPrep. We first set up the required paths, select specific subjects, tasks, and contrasts, </span>
</span><span id="__span-10-109"><a id="__codelineno-10-109" name="__codelineno-10-109"></a><span class="c">% and define analysis parameters like repetition time and timing information. The final block iterates through </span>
</span><span id="__span-10-110"><a id="__codelineno-10-110" name="__codelineno-10-110"></a><span class="c">% subjects and tasks, setting up each run of the GLM and checking for the existence of the required data before</span>
</span><span id="__span-10-111"><a id="__codelineno-10-111" name="__codelineno-10-111"></a><span class="c">% beginning the analysis. This setup ensures a consistent pipeline for different subjects and tasks.</span>
</span><span id="__span-10-112"><a id="__codelineno-10-112" name="__codelineno-10-112"></a>
</span><span id="__span-10-113"><a id="__codelineno-10-113" name="__codelineno-10-113"></a><span class="nb">clc</span>
</span><span id="__span-10-114"><a id="__codelineno-10-114" name="__codelineno-10-114"></a><span class="nb">clear</span>
</span><span id="__span-10-115"><a id="__codelineno-10-115" name="__codelineno-10-115"></a>
</span><span id="__span-10-116"><a id="__codelineno-10-116" name="__codelineno-10-116"></a><span class="c">%% PARAMETERS</span>
</span><span id="__span-10-117"><a id="__codelineno-10-117" name="__codelineno-10-117"></a>
</span><span id="__span-10-118"><a id="__codelineno-10-118" name="__codelineno-10-118"></a><span class="c">% Define the space of the images (&#39;T1w&#39; or &#39;MNI&#39;); in this case, we use MNI space at 2mm resolution.</span>
</span><span id="__span-10-119"><a id="__codelineno-10-119" name="__codelineno-10-119"></a><span class="n">niftiSpace</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;MNI152NLin2009cAsym_res-2&#39;</span><span class="p">;</span>
</span><span id="__span-10-120"><a id="__codelineno-10-120" name="__codelineno-10-120"></a>
</span><span id="__span-10-121"><a id="__codelineno-10-121" name="__codelineno-10-121"></a><span class="c">% Define the root directory for the BIDS dataset (where the data is stored).</span>
</span><span id="__span-10-122"><a id="__codelineno-10-122" name="__codelineno-10-122"></a><span class="n">BIDSRoot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;/data/projects/chess/data/BIDS&#39;</span><span class="p">;</span>
</span><span id="__span-10-123"><a id="__codelineno-10-123" name="__codelineno-10-123"></a>
</span><span id="__span-10-124"><a id="__codelineno-10-124" name="__codelineno-10-124"></a><span class="c">% Define paths relative to the BIDS root:</span>
</span><span id="__span-10-125"><a id="__codelineno-10-125" name="__codelineno-10-125"></a><span class="n">fmriprepRoot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">BIDSRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;derivatives&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fmriprep&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Path to fMRIprep output data.</span>
</span><span id="__span-10-126"><a id="__codelineno-10-126" name="__codelineno-10-126"></a><span class="n">outRoot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">BIDSRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;derivatives&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fmriprep-SPM-TEST&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">niftiSpace</span><span class="p">);</span><span class="w"> </span><span class="c">% Directory for storing analysis results.</span>
</span><span id="__span-10-127"><a id="__codelineno-10-127" name="__codelineno-10-127"></a><span class="n">tempDir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">BIDSRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;derivatives&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;fmriprep-preSPM&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Temporary storage for intermediate files.</span>
</span><span id="__span-10-128"><a id="__codelineno-10-128" name="__codelineno-10-128"></a>
</span><span id="__span-10-129"><a id="__codelineno-10-129" name="__codelineno-10-129"></a><span class="c">% Define fMRI timing parameters.</span>
</span><span id="__span-10-130"><a id="__codelineno-10-130" name="__codelineno-10-130"></a><span class="n">RT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">           </span><span class="c">% Repetition time (TR) in seconds, the time between consecutive volume acquisitions.</span>
</span><span id="__span-10-131"><a id="__codelineno-10-131" name="__codelineno-10-131"></a><span class="n">fmri_t</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w">      </span><span class="c">% Microtime resolution (number of slices).</span>
</span><span id="__span-10-132"><a id="__codelineno-10-132" name="__codelineno-10-132"></a><span class="n">fmri_t0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fmri_t</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">     </span><span class="c">% Microtime onset (reference slice for alignment).</span>
</span><span id="__span-10-133"><a id="__codelineno-10-133" name="__codelineno-10-133"></a>
</span><span id="__span-10-134"><a id="__codelineno-10-134" name="__codelineno-10-134"></a><span class="c">% Define the subjects and runs to include in the analysis.</span>
</span><span id="__span-10-135"><a id="__codelineno-10-135" name="__codelineno-10-135"></a><span class="n">selectedSubjectsList</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">];</span><span class="w"> </span><span class="c">% List of subject IDs to include (or use &#39;*&#39; for all subjects).</span>
</span><span id="__span-10-136"><a id="__codelineno-10-136" name="__codelineno-10-136"></a><span class="n">selectedRuns</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;*&#39;</span><span class="p">;</span><span class="w"> </span><span class="c">% Runs to include, with &#39;*&#39; indicating all available runs.</span>
</span><span id="__span-10-137"><a id="__codelineno-10-137" name="__codelineno-10-137"></a>
</span><span id="__span-10-138"><a id="__codelineno-10-138" name="__codelineno-10-138"></a><span class="c">% Define tasks with contrasts and associated weights for GLM analysis.</span>
</span><span id="__span-10-139"><a id="__codelineno-10-139" name="__codelineno-10-139"></a><span class="c">% Each task contains fields: name, contrasts, weights, and smoothBool.</span>
</span><span id="__span-10-140"><a id="__codelineno-10-140" name="__codelineno-10-140"></a><span class="c">% Task 1: Localizer Task</span>
</span><span id="__span-10-141"><a id="__codelineno-10-141" name="__codelineno-10-141"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;loc&#39;</span><span class="p">;</span><span class="w"> </span><span class="c">% Name of task as used in BIDS.</span>
</span><span id="__span-10-142"><a id="__codelineno-10-142" name="__codelineno-10-142"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">contrasts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;Faces &gt; Objects&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Objects &gt; Scrambled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Scenes &gt; Objects&#39;</span><span class="p">};</span><span class="w"> </span><span class="c">% Contrasts of interest.</span>
</span><span id="__span-10-143"><a id="__codelineno-10-143" name="__codelineno-10-143"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">weights</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;Faces&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Objects&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Scrambled&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Scenes&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c">% Weights for contrast 1.</span>
</span><span id="__span-10-144"><a id="__codelineno-10-144" name="__codelineno-10-144"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">weights</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;Faces&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Objects&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Scrambled&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Scenes&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c">% Weights for contrast 2.</span>
</span><span id="__span-10-145"><a id="__codelineno-10-145" name="__codelineno-10-145"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">weights</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;Faces&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Objects&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Scrambled&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Scenes&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c">% Weights for contrast 3.</span>
</span><span id="__span-10-146"><a id="__codelineno-10-146" name="__codelineno-10-146"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">smoothBool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="c">% Apply smoothing before GLM for this task.</span>
</span><span id="__span-10-147"><a id="__codelineno-10-147" name="__codelineno-10-147"></a>
</span><span id="__span-10-148"><a id="__codelineno-10-148" name="__codelineno-10-148"></a><span class="c">% Task 2: Experimental Task</span>
</span><span id="__span-10-149"><a id="__codelineno-10-149" name="__codelineno-10-149"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;exp&#39;</span><span class="p">;</span>
</span><span id="__span-10-150"><a id="__codelineno-10-150" name="__codelineno-10-150"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">contrasts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;Check &gt; No-Check&#39;</span><span class="p">};</span>
</span><span id="__span-10-151"><a id="__codelineno-10-151" name="__codelineno-10-151"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">weights</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;check&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;nocheck&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c">% Weights for contrast 1.</span>
</span><span id="__span-10-152"><a id="__codelineno-10-152" name="__codelineno-10-152"></a><span class="n">selectedTasks</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">smoothBool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c">% Do not apply smoothing for this task.</span>
</span><span id="__span-10-153"><a id="__codelineno-10-153" name="__codelineno-10-153"></a>
</span><span id="__span-10-154"><a id="__codelineno-10-154" name="__codelineno-10-154"></a><span class="c">% Specify confound regressors to include in the GLM.</span>
</span><span id="__span-10-155"><a id="__codelineno-10-155" name="__codelineno-10-155"></a><span class="n">pipeline</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;HMP-6&#39;</span><span class="p">,</span><span class="s">&#39;GS-1&#39;</span><span class="p">,</span><span class="s">&#39;FD&#39;</span><span class="p">};</span><span class="w"> </span><span class="c">% Use head motion parameters, global signal, and framewise displacement.</span>
</span><span id="__span-10-156"><a id="__codelineno-10-156" name="__codelineno-10-156"></a>
</span><span id="__span-10-157"><a id="__codelineno-10-157" name="__codelineno-10-157"></a><span class="c">% Find folders for each subject based on the selected subjects list.</span>
</span><span id="__span-10-158"><a id="__codelineno-10-158" name="__codelineno-10-158"></a><span class="n">sub_paths</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">findSubjectsFolders</span><span class="p">(</span><span class="n">fmriprepRoot</span><span class="p">,</span><span class="w"> </span><span class="n">selectedSubjectsList</span><span class="p">);</span>
</span><span id="__span-10-159"><a id="__codelineno-10-159" name="__codelineno-10-159"></a>
</span><span id="__span-10-160"><a id="__codelineno-10-160" name="__codelineno-10-160"></a><span class="c">%% RUN THE GLM FOR EACH SUBJECT AND TASK</span>
</span><span id="__span-10-161"><a id="__codelineno-10-161" name="__codelineno-10-161"></a>
</span><span id="__span-10-162"><a id="__codelineno-10-162" name="__codelineno-10-162"></a><span class="c">% Loop through each subject in the list.</span>
</span><span id="__span-10-163"><a id="__codelineno-10-163" name="__codelineno-10-163"></a><span class="k">for</span><span class="w"> </span><span class="n">sub_path_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">sub_paths</span><span class="p">)</span>
</span><span id="__span-10-164"><a id="__codelineno-10-164" name="__codelineno-10-164"></a>
</span><span id="__span-10-165"><a id="__codelineno-10-165" name="__codelineno-10-165"></a><span class="w">    </span><span class="c">% Loop through each defined task for analysis.</span>
</span><span id="__span-10-166"><a id="__codelineno-10-166" name="__codelineno-10-166"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">selected_task_idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">selectedTasks</span><span class="p">)</span>
</span><span id="__span-10-167"><a id="__codelineno-10-167" name="__codelineno-10-167"></a>
</span><span id="__span-10-168"><a id="__codelineno-10-168" name="__codelineno-10-168"></a><span class="w">        </span><span class="c">% Clear previous configurations in matlabbatch to avoid conflicts.</span>
</span><span id="__span-10-169"><a id="__codelineno-10-169" name="__codelineno-10-169"></a><span class="w">        </span><span class="nb">clearvars</span><span class="w"> </span><span class="n">matlabbatch</span>
</span><span id="__span-10-170"><a id="__codelineno-10-170" name="__codelineno-10-170"></a>
</span><span id="__span-10-171"><a id="__codelineno-10-171" name="__codelineno-10-171"></a><span class="w">        </span><span class="c">%% SUBJECT AND TASK INFO</span>
</span><span id="__span-10-172"><a id="__codelineno-10-172" name="__codelineno-10-172"></a>
</span><span id="__span-10-173"><a id="__codelineno-10-173" name="__codelineno-10-173"></a><span class="w">        </span><span class="c">% Get the current task details (name, contrasts, smoothing preference).</span>
</span><span id="__span-10-174"><a id="__codelineno-10-174" name="__codelineno-10-174"></a><span class="w">        </span><span class="n">selectedTask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">selectedTasks</span><span class="p">(</span><span class="n">selected_task_idx</span><span class="p">).</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="c">% Task name.</span>
</span><span id="__span-10-175"><a id="__codelineno-10-175" name="__codelineno-10-175"></a><span class="w">        </span><span class="n">contrasts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">selectedTasks</span><span class="p">(</span><span class="n">selected_task_idx</span><span class="p">).</span><span class="n">contrasts</span><span class="p">;</span><span class="w"> </span><span class="c">% Task contrasts.</span>
</span><span id="__span-10-176"><a id="__codelineno-10-176" name="__codelineno-10-176"></a><span class="w">        </span><span class="n">smoothBool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">selectedTasks</span><span class="p">(</span><span class="n">selected_task_idx</span><span class="p">).</span><span class="n">smoothBool</span><span class="p">;</span><span class="w"> </span><span class="c">% Boolean: smooth images before GLM?</span>
</span><span id="__span-10-177"><a id="__codelineno-10-177" name="__codelineno-10-177"></a>
</span><span id="__span-10-178"><a id="__codelineno-10-178" name="__codelineno-10-178"></a><span class="w">        </span><span class="c">% Extract the subject ID from the folder name (formatted as &#39;sub-01&#39;).</span>
</span><span id="__span-10-179"><a id="__codelineno-10-179" name="__codelineno-10-179"></a><span class="w">        </span><span class="n">subPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sub_paths</span><span class="p">(</span><span class="n">sub_path_idx</span><span class="p">);</span>
</span><span id="__span-10-180"><a id="__codelineno-10-180" name="__codelineno-10-180"></a><span class="w">        </span><span class="n">subName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">subPath</span><span class="p">.</span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="c">% e.g., &#39;sub-01&#39;</span>
</span><span id="__span-10-181"><a id="__codelineno-10-181" name="__codelineno-10-181"></a><span class="w">        </span><span class="n">sub_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strsplit</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Splits &#39;sub-01&#39; into {&#39;sub&#39;, &#39;01&#39;}</span>
</span><span id="__span-10-182"><a id="__codelineno-10-182" name="__codelineno-10-182"></a><span class="w">        </span><span class="n">selectedSub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">str2double</span><span class="p">(</span><span class="n">sub_id</span><span class="p">{</span><span class="mi">2</span><span class="p">});</span><span class="w"> </span><span class="c">% Extracts and converts the subject ID to a number.</span>
</span><span id="__span-10-183"><a id="__codelineno-10-183" name="__codelineno-10-183"></a>
</span><span id="__span-10-184"><a id="__codelineno-10-184" name="__codelineno-10-184"></a><span class="w">        </span><span class="c">% Define the output path for storing GLM results for this subject and task.</span>
</span><span id="__span-10-185"><a id="__codelineno-10-185" name="__codelineno-10-185"></a><span class="w">        </span><span class="n">outPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;GLM&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">);</span>
</span><span id="__span-10-186"><a id="__codelineno-10-186" name="__codelineno-10-186"></a>
</span><span id="__span-10-187"><a id="__codelineno-10-187" name="__codelineno-10-187"></a><span class="w">        </span><span class="c">% Define paths to the functional data for this subject.</span>
</span><span id="__span-10-188"><a id="__codelineno-10-188" name="__codelineno-10-188"></a><span class="w">        </span><span class="n">funcPathSub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">fmriprepRoot</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;func&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Functional data path.</span>
</span><span id="__span-10-189"><a id="__codelineno-10-189" name="__codelineno-10-189"></a><span class="w">        </span><span class="n">bidsPathSub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">BIDSRoot</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;func&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% BIDS formatted path.</span>
</span><span id="__span-10-190"><a id="__codelineno-10-190" name="__codelineno-10-190"></a>
</span><span id="__span-10-191"><a id="__codelineno-10-191" name="__codelineno-10-191"></a><span class="w">        </span><span class="c">% Check if the specified task exists in the subject’s data.</span>
</span><span id="__span-10-192"><a id="__codelineno-10-192" name="__codelineno-10-192"></a><span class="w">        </span><span class="n">files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="n">funcPathSub</span><span class="p">);</span><span class="w"> </span><span class="c">% List files in the functional data directory.</span>
</span><span id="__span-10-193"><a id="__codelineno-10-193" name="__codelineno-10-193"></a><span class="w">        </span><span class="n">fileNames</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">files</span><span class="p">.</span><span class="n">name</span><span class="p">};</span><span class="w"> </span><span class="c">% Extract file names.</span>
</span><span id="__span-10-194"><a id="__codelineno-10-194" name="__codelineno-10-194"></a><span class="w">        </span><span class="n">containsTask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">fileNames</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">]));</span><span class="w"> </span><span class="c">% Check for the task in file names.</span>
</span><span id="__span-10-195"><a id="__codelineno-10-195" name="__codelineno-10-195"></a>
</span><span id="__span-10-196"><a id="__codelineno-10-196" name="__codelineno-10-196"></a><span class="w">        </span><span class="c">% If the task is missing for this subject, skip to the next iteration.</span>
</span><span id="__span-10-197"><a id="__codelineno-10-197" name="__codelineno-10-197"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">containsTask</span>
</span><span id="__span-10-198"><a id="__codelineno-10-198" name="__codelineno-10-198"></a><span class="w">            </span><span class="nb">warning</span><span class="p">([</span><span class="s">&#39;Task &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39; not found for &#39;</span><span class="w"> </span><span class="n">subName</span><span class="w"> </span><span class="s">&#39; in &#39;</span><span class="w"> </span><span class="n">funcPathSub</span><span class="w"> </span><span class="s">&#39;. Skipping...&#39;</span><span class="p">]);</span>
</span><span id="__span-10-199"><a id="__codelineno-10-199" name="__codelineno-10-199"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-10-200"><a id="__codelineno-10-200" name="__codelineno-10-200"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-10-201"><a id="__codelineno-10-201" name="__codelineno-10-201"></a>
</span><span id="__span-10-202"><a id="__codelineno-10-202" name="__codelineno-10-202"></a><span class="w">        </span><span class="c">% Print a status update showing the subject and task being processed.</span>
</span><span id="__span-10-203"><a id="__codelineno-10-203" name="__codelineno-10-203"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;############################### \n# STEP: running %s - %s #\n############################### \n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">);</span>
</span><span id="__span-10-204"><a id="__codelineno-10-204" name="__codelineno-10-204"></a>
</span><span id="__span-10-205"><a id="__codelineno-10-205" name="__codelineno-10-205"></a><span class="w">        </span><span class="c">% This first section finds and loads the event and confound files for each run, based on selections specified earlier. </span>
</span><span id="__span-10-206"><a id="__codelineno-10-206" name="__codelineno-10-206"></a><span class="w">        </span><span class="c">% We retrieve and organize the event data (which includes onset times and durations) and confound data </span>
</span><span id="__span-10-207"><a id="__codelineno-10-207" name="__codelineno-10-207"></a><span class="w">        </span><span class="c">% (like motion parameters or physiological noise) for each run of a task. These inputs are essential for setting up the </span>
</span><span id="__span-10-208"><a id="__codelineno-10-208" name="__codelineno-10-208"></a><span class="w">        </span><span class="c">% GLM model, as they provide information needed for modeling the BOLD signal in relation to task events and controlling </span>
</span><span id="__span-10-209"><a id="__codelineno-10-209" name="__codelineno-10-209"></a><span class="w">        </span><span class="c">% for noise.</span>
</span><span id="__span-10-210"><a id="__codelineno-10-210" name="__codelineno-10-210"></a>
</span><span id="__span-10-211"><a id="__codelineno-10-211" name="__codelineno-10-211"></a><span class="w">        </span><span class="c">%% FIND AND LOAD EVENTS AND CONFOUNDS FROM FMRIPREP FOLDER</span>
</span><span id="__span-10-212"><a id="__codelineno-10-212" name="__codelineno-10-212"></a>
</span><span id="__span-10-213"><a id="__codelineno-10-213" name="__codelineno-10-213"></a><span class="w">        </span><span class="c">% Retrieve event and confound files for selected runs.</span>
</span><span id="__span-10-214"><a id="__codelineno-10-214" name="__codelineno-10-214"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">ismember</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRuns</span><span class="p">)</span>
</span><span id="__span-10-215"><a id="__codelineno-10-215" name="__codelineno-10-215"></a><span class="w">            </span><span class="c">% If &#39;*&#39; is specified, include all available runs for this subject and task.</span>
</span><span id="__span-10-216"><a id="__codelineno-10-216" name="__codelineno-10-216"></a><span class="w">            </span><span class="n">eventsTsvFiles</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">bidsPathSub</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_run-*_events.tsv&#39;</span><span class="p">)));</span>
</span><span id="__span-10-217"><a id="__codelineno-10-217" name="__codelineno-10-217"></a><span class="w">            </span><span class="n">json_confounds_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">funcPathSub</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_run-*_desc-confounds_timeseries.json&#39;</span><span class="p">)));</span>
</span><span id="__span-10-218"><a id="__codelineno-10-218" name="__codelineno-10-218"></a><span class="w">            </span><span class="n">tsv_confounds_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">funcPathSub</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_run-*_desc-confounds_timeseries.tsv&#39;</span><span class="p">)));</span>
</span><span id="__span-10-219"><a id="__codelineno-10-219" name="__codelineno-10-219"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-10-220"><a id="__codelineno-10-220" name="__codelineno-10-220"></a><span class="w">            </span><span class="c">% Include only the specific runs listed in `selectedRuns`.</span>
</span><span id="__span-10-221"><a id="__codelineno-10-221" name="__codelineno-10-221"></a><span class="w">            </span><span class="n">eventsTsvFiles</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">arrayfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">bidsPathSub</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_run-&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;%01d&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;_events.tsv&#39;</span><span class="p">))),</span><span class="w"> </span><span class="n">selectedRuns</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</span><span id="__span-10-222"><a id="__codelineno-10-222" name="__codelineno-10-222"></a><span class="w">            </span><span class="n">json_confounds_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">arrayfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">funcPathSub</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_run-&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;%01d&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;_events.json&#39;</span><span class="p">))),</span><span class="w"> </span><span class="n">selectedRuns</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</span><span id="__span-10-223"><a id="__codelineno-10-223" name="__codelineno-10-223"></a><span class="w">            </span><span class="n">tsv_confounds_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">arrayfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">funcPathSub</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_run-&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;%01d&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;_events.tsv&#39;</span><span class="p">))),</span><span class="w"> </span><span class="n">selectedRuns</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</span><span id="__span-10-224"><a id="__codelineno-10-224" name="__codelineno-10-224"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-10-225"><a id="__codelineno-10-225" name="__codelineno-10-225"></a>
</span><span id="__span-10-226"><a id="__codelineno-10-226" name="__codelineno-10-226"></a><span class="w">        </span><span class="c">% Sort the retrieved files alphabetically by name for consistent ordering.</span>
</span><span id="__span-10-227"><a id="__codelineno-10-227" name="__codelineno-10-227"></a><span class="w">        </span><span class="n">eventsTsvFiles</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">table2struct</span><span class="p">(</span><span class="nb">sortrows</span><span class="p">(</span><span class="nb">struct2table</span><span class="p">(</span><span class="n">eventsTsvFiles</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;name&#39;</span><span class="p">));</span>
</span><span id="__span-10-228"><a id="__codelineno-10-228" name="__codelineno-10-228"></a><span class="w">        </span><span class="n">json_confounds_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">table2struct</span><span class="p">(</span><span class="nb">sortrows</span><span class="p">(</span><span class="nb">struct2table</span><span class="p">(</span><span class="n">json_confounds_files</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;name&#39;</span><span class="p">));</span>
</span><span id="__span-10-229"><a id="__codelineno-10-229" name="__codelineno-10-229"></a><span class="w">        </span><span class="n">tsv_confounds_files</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">table2struct</span><span class="p">(</span><span class="nb">sortrows</span><span class="p">(</span><span class="nb">struct2table</span><span class="p">(</span><span class="n">tsv_confounds_files</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;name&#39;</span><span class="p">));</span>
</span><span id="__span-10-230"><a id="__codelineno-10-230" name="__codelineno-10-230"></a>
</span><span id="__span-10-231"><a id="__codelineno-10-231" name="__codelineno-10-231"></a><span class="w">        </span><span class="c">% Ensure the number of event and confound files matches across all run files.</span>
</span><span id="__span-10-232"><a id="__codelineno-10-232" name="__codelineno-10-232"></a><span class="w">        </span><span class="nb">assert</span><span class="p">(</span><span class="nb">numel</span><span class="p">(</span><span class="n">eventsTsvFiles</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">json_confounds_files</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">json_confounds_files</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">tsv_confounds_files</span><span class="p">),</span><span class="w"> </span><span class="k">...</span>
</span><span id="__span-10-233"><a id="__codelineno-10-233" name="__codelineno-10-233"></a><span class="w">            </span><span class="s">&#39;Mismatch in number of TSV events, TSV confounds, and JSON confounds files in %s&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">funcPathSub</span><span class="p">)</span>
</span><span id="__span-10-234"><a id="__codelineno-10-234" name="__codelineno-10-234"></a>
</span><span id="__span-10-235"><a id="__codelineno-10-235" name="__codelineno-10-235"></a>
</span><span id="__span-10-236"><a id="__codelineno-10-236" name="__codelineno-10-236"></a><span class="w">        </span><span class="c">% This second section sets non-run-specific SPM model parameters, defining the core structure of the GLM model. </span>
</span><span id="__span-10-237"><a id="__codelineno-10-237" name="__codelineno-10-237"></a><span class="w">        </span><span class="c">% Here we specify settings such as the repetition time, microtime resolution, basis functions, and whether global </span>
</span><span id="__span-10-238"><a id="__codelineno-10-238" name="__codelineno-10-238"></a><span class="w">        </span><span class="c">% normalization should be applied. These parameters remain consistent across different runs and subjects, creating </span>
</span><span id="__span-10-239"><a id="__codelineno-10-239" name="__codelineno-10-239"></a><span class="w">        </span><span class="c">% a standardized foundation for the GLM analysis.</span>
</span><span id="__span-10-240"><a id="__codelineno-10-240" name="__codelineno-10-240"></a>
</span><span id="__span-10-241"><a id="__codelineno-10-241" name="__codelineno-10-241"></a><span class="w">        </span><span class="c">%% SPM MODEL PARAMETERS (NON RUN DEPENDENT)</span>
</span><span id="__span-10-242"><a id="__codelineno-10-242" name="__codelineno-10-242"></a>
</span><span id="__span-10-243"><a id="__codelineno-10-243" name="__codelineno-10-243"></a><span class="w">        </span><span class="c">% Define non-run-specific parameters for the GLM in SPM.</span>
</span><span id="__span-10-244"><a id="__codelineno-10-244" name="__codelineno-10-244"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">dir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellstr</span><span class="p">(</span><span class="n">outPath</span><span class="p">);</span><span class="w"> </span><span class="c">% Directory where SPM output will be saved.</span>
</span><span id="__span-10-245"><a id="__codelineno-10-245" name="__codelineno-10-245"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">units</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;secs&#39;</span><span class="p">;</span><span class="w"> </span><span class="c">% Units for event timing (set to seconds).</span>
</span><span id="__span-10-246"><a id="__codelineno-10-246" name="__codelineno-10-246"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">RT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">RT</span><span class="p">;</span><span class="w"> </span><span class="c">% Repetition time (TR) defines time between successive scans.</span>
</span><span id="__span-10-247"><a id="__codelineno-10-247" name="__codelineno-10-247"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">fmri_t</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fmri_t</span><span class="p">;</span><span class="w"> </span><span class="c">% Microtime resolution - number of time bins within one TR.</span>
</span><span id="__span-10-248"><a id="__codelineno-10-248" name="__codelineno-10-248"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">fmri_t0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fmri_t0</span><span class="p">;</span><span class="w"> </span><span class="c">% Microtime onset - reference slice for alignment.</span>
</span><span id="__span-10-249"><a id="__codelineno-10-249" name="__codelineno-10-249"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">fact</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s">&#39;levels&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span><span class="w"> </span><span class="c">% No factorial design applied here.</span>
</span><span id="__span-10-250"><a id="__codelineno-10-250" name="__codelineno-10-250"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">bases</span><span class="p">.</span><span class="n">hrf</span><span class="p">.</span><span class="n">derivs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="c">% Canonical HRF without derivatives (time/dispersion).</span>
</span><span id="__span-10-251"><a id="__codelineno-10-251" name="__codelineno-10-251"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">volt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c">% Volterra interactions disabled (linear model).</span>
</span><span id="__span-10-252"><a id="__codelineno-10-252" name="__codelineno-10-252"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">global</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;None&#39;</span><span class="p">;</span><span class="w"> </span><span class="c">% No global normalization applied.</span>
</span><span id="__span-10-253"><a id="__codelineno-10-253" name="__codelineno-10-253"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">mthresh</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.8</span><span class="p">;</span><span class="w"> </span><span class="c">% Masking threshold excludes voxels below 80% of mean signal.</span>
</span><span id="__span-10-254"><a id="__codelineno-10-254" name="__codelineno-10-254"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">mask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">};</span><span class="w"> </span><span class="c">% No explicit mask specified.</span>
</span><span id="__span-10-255"><a id="__codelineno-10-255" name="__codelineno-10-255"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">cvi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;AR(1)&#39;</span><span class="p">;</span><span class="w"> </span><span class="c">% AR(1) autocorrelation correction for temporal dependencies.</span>
</span><span id="__span-10-256"><a id="__codelineno-10-256" name="__codelineno-10-256"></a>
</span><span id="__span-10-257"><a id="__codelineno-10-257" name="__codelineno-10-257"></a><span class="w">        </span><span class="c">% Set up parameters for estimating the GLM in the second stage.</span>
</span><span id="__span-10-258"><a id="__codelineno-10-258" name="__codelineno-10-258"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_est</span><span class="p">.</span><span class="n">spmmat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cfg_dep</span><span class="p">(</span><span class="s">&#39;fMRI model specification: SPM.mat File&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
</span><span id="__span-10-259"><a id="__codelineno-10-259" name="__codelineno-10-259"></a><span class="w">            </span><span class="nb">substruct</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;val&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;{}&#39;</span><span class="p">,{</span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;val&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;{}&#39;</span><span class="p">,{</span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;val&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;{}&#39;</span><span class="p">,{</span><span class="mi">1</span><span class="p">}),</span><span class="w"> </span><span class="nb">substruct</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;spmmat&#39;</span><span class="p">));</span>
</span><span id="__span-10-260"><a id="__codelineno-10-260" name="__codelineno-10-260"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_est</span><span class="p">.</span><span class="n">write_residuals</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c">% Do not save residuals.</span>
</span><span id="__span-10-261"><a id="__codelineno-10-261" name="__codelineno-10-261"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_est</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">Classical</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c">% Use classical estimation method (ReML).</span>
</span><span id="__span-10-262"><a id="__codelineno-10-262" name="__codelineno-10-262"></a>
</span><span id="__span-10-263"><a id="__codelineno-10-263" name="__codelineno-10-263"></a><span class="w">        </span><span class="c">% This section iterates over each run of the task for the current subject, setting up the required SPM parameters </span>
</span><span id="__span-10-264"><a id="__codelineno-10-264" name="__codelineno-10-264"></a><span class="w">        </span><span class="c">% for each run. We load event and confound data, identify the correct NIfTI files, apply smoothing if required, </span>
</span><span id="__span-10-265"><a id="__codelineno-10-265" name="__codelineno-10-265"></a><span class="w">        </span><span class="c">% and configure session-specific settings in the SPM model specification. Each step is verified to ensure data </span>
</span><span id="__span-10-266"><a id="__codelineno-10-266" name="__codelineno-10-266"></a><span class="w">        </span><span class="c">% integrity, and any issues with missing or multiple files are flagged for user review.</span>
</span><span id="__span-10-267"><a id="__codelineno-10-267" name="__codelineno-10-267"></a>
</span><span id="__span-10-268"><a id="__codelineno-10-268" name="__codelineno-10-268"></a><span class="w">        </span><span class="c">%% SPM RUN SETTINGS (E.G., EVENTS, CONFOUNDS, IMAGES)</span>
</span><span id="__span-10-269"><a id="__codelineno-10-269" name="__codelineno-10-269"></a>
</span><span id="__span-10-270"><a id="__codelineno-10-270" name="__codelineno-10-270"></a><span class="w">        </span><span class="c">% Loop over each run of the task.</span>
</span><span id="__span-10-271"><a id="__codelineno-10-271" name="__codelineno-10-271"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">runIdx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">eventsTsvFiles</span><span class="p">)</span>
</span><span id="__span-10-272"><a id="__codelineno-10-272" name="__codelineno-10-272"></a>
</span><span id="__span-10-273"><a id="__codelineno-10-273" name="__codelineno-10-273"></a><span class="w">            </span><span class="c">% Load event information into a structure compatible with SPM.</span>
</span><span id="__span-10-274"><a id="__codelineno-10-274" name="__codelineno-10-274"></a><span class="w">            </span><span class="n">events_struct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">eventsBIDS2SPM</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">eventsTsvFiles</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">folder</span><span class="p">,</span><span class="w"> </span><span class="n">eventsTsvFiles</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">name</span><span class="p">));</span>
</span><span id="__span-10-275"><a id="__codelineno-10-275" name="__codelineno-10-275"></a><span class="w">            </span><span class="n">selectedRun</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">findRunSubstring</span><span class="p">(</span><span class="n">eventsTsvFiles</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="c">% Identify the current run (e.g., &#39;run-01&#39;).</span>
</span><span id="__span-10-276"><a id="__codelineno-10-276" name="__codelineno-10-276"></a>
</span><span id="__span-10-277"><a id="__codelineno-10-277" name="__codelineno-10-277"></a><span class="w">            </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;## STEP: TASK %s - %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRun</span><span class="p">)</span>
</span><span id="__span-10-278"><a id="__codelineno-10-278" name="__codelineno-10-278"></a>
</span><span id="__span-10-279"><a id="__codelineno-10-279" name="__codelineno-10-279"></a><span class="w">            </span><span class="c">% Select the corresponding confound files for the current run.</span>
</span><span id="__span-10-280"><a id="__codelineno-10-280" name="__codelineno-10-280"></a><span class="w">            </span><span class="n">jsonRows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">filterRowsBySubstring</span><span class="p">(</span><span class="n">json_confounds_files</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRun</span><span class="p">);</span>
</span><span id="__span-10-281"><a id="__codelineno-10-281" name="__codelineno-10-281"></a><span class="w">            </span><span class="n">confoundsRows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">filterRowsBySubstring</span><span class="p">(</span><span class="n">tsv_confounds_files</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRun</span><span class="p">);</span>
</span><span id="__span-10-282"><a id="__codelineno-10-282" name="__codelineno-10-282"></a>
</span><span id="__span-10-283"><a id="__codelineno-10-283" name="__codelineno-10-283"></a><span class="w">            </span><span class="c">% Check for a single JSON confounds file, and flag errors if multiple or none are found.</span>
</span><span id="__span-10-284"><a id="__codelineno-10-284" name="__codelineno-10-284"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">jsonRows</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-10-285"><a id="__codelineno-10-285" name="__codelineno-10-285"></a><span class="w">                </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;More than one JSON file found for the specified run. Please check the dataset.&#39;</span><span class="p">);</span>
</span><span id="__span-10-286"><a id="__codelineno-10-286" name="__codelineno-10-286"></a><span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">jsonRows</span><span class="p">)</span>
</span><span id="__span-10-287"><a id="__codelineno-10-287" name="__codelineno-10-287"></a><span class="w">                </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;No JSON file found for the specified run. Please check the dataset.&#39;</span><span class="p">);</span>
</span><span id="__span-10-288"><a id="__codelineno-10-288" name="__codelineno-10-288"></a><span class="w">            </span><span class="k">else</span>
</span><span id="__span-10-289"><a id="__codelineno-10-289" name="__codelineno-10-289"></a><span class="w">                </span><span class="n">jsonRow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">jsonRows</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">:};</span>
</span><span id="__span-10-290"><a id="__codelineno-10-290" name="__codelineno-10-290"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-10-291"><a id="__codelineno-10-291" name="__codelineno-10-291"></a>
</span><span id="__span-10-292"><a id="__codelineno-10-292" name="__codelineno-10-292"></a><span class="w">            </span><span class="c">% Check for a single TSV confounds file, and handle errors similarly.</span>
</span><span id="__span-10-293"><a id="__codelineno-10-293" name="__codelineno-10-293"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">confoundsRows</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-10-294"><a id="__codelineno-10-294" name="__codelineno-10-294"></a><span class="w">                </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;More than one TSV confounds file found for the specified run. Please check the dataset.&#39;</span><span class="p">);</span>
</span><span id="__span-10-295"><a id="__codelineno-10-295" name="__codelineno-10-295"></a><span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">confoundsRows</span><span class="p">)</span>
</span><span id="__span-10-296"><a id="__codelineno-10-296" name="__codelineno-10-296"></a><span class="w">                </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;No TSV confounds file found for the specified run. Please check the dataset.&#39;</span><span class="p">);</span>
</span><span id="__span-10-297"><a id="__codelineno-10-297" name="__codelineno-10-297"></a><span class="w">            </span><span class="k">else</span>
</span><span id="__span-10-298"><a id="__codelineno-10-298" name="__codelineno-10-298"></a><span class="w">                </span><span class="n">confoundsRow</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">confoundsRows</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">:};</span>
</span><span id="__span-10-299"><a id="__codelineno-10-299" name="__codelineno-10-299"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-10-300"><a id="__codelineno-10-300" name="__codelineno-10-300"></a>
</span><span id="__span-10-301"><a id="__codelineno-10-301" name="__codelineno-10-301"></a><span class="w">            </span><span class="c">% Extract confound data based on the specified pipeline, loading it into an array.</span>
</span><span id="__span-10-302"><a id="__codelineno-10-302" name="__codelineno-10-302"></a><span class="w">            </span><span class="n">confounds_array</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fMRIprepConfounds2SPM</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">jsonRow</span><span class="p">.</span><span class="n">folder</span><span class="p">,</span><span class="w"> </span><span class="n">jsonRow</span><span class="p">.</span><span class="n">name</span><span class="p">),</span><span class="k">...</span>
</span><span id="__span-10-303"><a id="__codelineno-10-303" name="__codelineno-10-303"></a><span class="w">                </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">confoundsRow</span><span class="p">.</span><span class="n">folder</span><span class="p">,</span><span class="w"> </span><span class="n">confoundsRow</span><span class="p">.</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="n">pipeline</span><span class="p">);</span>
</span><span id="__span-10-304"><a id="__codelineno-10-304" name="__codelineno-10-304"></a>
</span><span id="__span-10-305"><a id="__codelineno-10-305" name="__codelineno-10-305"></a><span class="w">            </span><span class="c">% Define the pattern to locate the NIfTI file and check for its existence.</span>
</span><span id="__span-10-306"><a id="__codelineno-10-306" name="__codelineno-10-306"></a><span class="w">            </span><span class="n">filePattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_task-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRun</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_space-&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">niftiSpace</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_desc-preproc_bold&#39;</span><span class="p">);</span>
</span><span id="__span-10-307"><a id="__codelineno-10-307" name="__codelineno-10-307"></a><span class="w">            </span><span class="n">niiFileStruct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">fmriprepRoot</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;func&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">filePattern</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.nii&#39;</span><span class="p">)));</span>
</span><span id="__span-10-308"><a id="__codelineno-10-308" name="__codelineno-10-308"></a>
</span><span id="__span-10-309"><a id="__codelineno-10-309" name="__codelineno-10-309"></a><span class="w">            </span><span class="c">% Handle cases with missing or multiple NIfTI files.</span>
</span><span id="__span-10-310"><a id="__codelineno-10-310" name="__codelineno-10-310"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">niiFileStruct</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-10-311"><a id="__codelineno-10-311" name="__codelineno-10-311"></a><span class="w">                </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Multiple NIFTI files found for %s.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRun</span><span class="p">)</span>
</span><span id="__span-10-312"><a id="__codelineno-10-312" name="__codelineno-10-312"></a><span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">niiFileStruct</span><span class="p">)</span>
</span><span id="__span-10-313"><a id="__codelineno-10-313" name="__codelineno-10-313"></a><span class="w">                </span><span class="c">% If no NIfTI files are found, check for compressed (.nii.gz) files and decompress if necessary.</span>
</span><span id="__span-10-314"><a id="__codelineno-10-314" name="__codelineno-10-314"></a><span class="w">                </span><span class="n">niiGzFilePattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">funcPathSub</span><span class="p">,</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">filePattern</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.nii.gz&#39;</span><span class="p">));</span>
</span><span id="__span-10-315"><a id="__codelineno-10-315" name="__codelineno-10-315"></a><span class="w">                </span><span class="n">niiGzFileStruct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="n">niiGzFilePattern</span><span class="p">);</span>
</span><span id="__span-10-316"><a id="__codelineno-10-316" name="__codelineno-10-316"></a>
</span><span id="__span-10-317"><a id="__codelineno-10-317" name="__codelineno-10-317"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">niiGzFileStruct</span><span class="p">)</span>
</span><span id="__span-10-318"><a id="__codelineno-10-318" name="__codelineno-10-318"></a><span class="w">                    </span><span class="nb">warning</span><span class="p">(</span><span class="s">&#39;No NIFTI file found for run %s. SKIPPING!&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRun</span><span class="p">)</span>
</span><span id="__span-10-319"><a id="__codelineno-10-319" name="__codelineno-10-319"></a><span class="w">                    </span><span class="k">continue</span>
</span><span id="__span-10-320"><a id="__codelineno-10-320" name="__codelineno-10-320"></a><span class="w">                </span><span class="k">elseif</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">niiGzFileStruct</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-10-321"><a id="__codelineno-10-321" name="__codelineno-10-321"></a><span class="w">                    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Multiple NIFTI.GZ files found for this run.&#39;</span><span class="p">)</span>
</span><span id="__span-10-322"><a id="__codelineno-10-322" name="__codelineno-10-322"></a><span class="w">                </span><span class="k">else</span>
</span><span id="__span-10-323"><a id="__codelineno-10-323" name="__codelineno-10-323"></a><span class="w">                    </span><span class="c">% Decompress the .nii.gz file if found.</span>
</span><span id="__span-10-324"><a id="__codelineno-10-324" name="__codelineno-10-324"></a><span class="w">                    </span><span class="n">niiGzFileString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">niiGzFileStruct</span><span class="p">.</span><span class="n">folder</span><span class="p">,</span><span class="w"> </span><span class="n">niiGzFileStruct</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-10-325"><a id="__codelineno-10-325" name="__codelineno-10-325"></a><span class="w">                    </span><span class="n">gunzippedNii</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gunzipNiftiFile</span><span class="p">(</span><span class="n">niiGzFileString</span><span class="p">,</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;gunzipped&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">));</span>
</span><span id="__span-10-326"><a id="__codelineno-10-326" name="__codelineno-10-326"></a><span class="w">                    </span><span class="n">niiFileStruct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="n">gunzippedNii</span><span class="p">{</span><span class="mi">1</span><span class="p">});</span>
</span><span id="__span-10-327"><a id="__codelineno-10-327" name="__codelineno-10-327"></a><span class="w">                </span><span class="k">end</span>
</span><span id="__span-10-328"><a id="__codelineno-10-328" name="__codelineno-10-328"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-10-329"><a id="__codelineno-10-329" name="__codelineno-10-329"></a>
</span><span id="__span-10-330"><a id="__codelineno-10-330" name="__codelineno-10-330"></a><span class="w">            </span><span class="c">% Get the full path of the (possibly decompressed) NIfTI file.</span>
</span><span id="__span-10-331"><a id="__codelineno-10-331" name="__codelineno-10-331"></a><span class="w">            </span><span class="n">niiFileString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">niiFileStruct</span><span class="p">.</span><span class="n">folder</span><span class="p">,</span><span class="w"> </span><span class="n">niiFileStruct</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-10-332"><a id="__codelineno-10-332" name="__codelineno-10-332"></a>
</span><span id="__span-10-333"><a id="__codelineno-10-333" name="__codelineno-10-333"></a><span class="w">            </span><span class="c">% Smooth the NIfTI file if smoothing is enabled for this task.</span>
</span><span id="__span-10-334"><a id="__codelineno-10-334" name="__codelineno-10-334"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">smoothBool</span>
</span><span id="__span-10-335"><a id="__codelineno-10-335" name="__codelineno-10-335"></a><span class="w">                </span><span class="n">niiFileString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">smoothNiftiFile</span><span class="p">(</span><span class="n">niiFileString</span><span class="p">,</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;smoothed&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">));</span>
</span><span id="__span-10-336"><a id="__codelineno-10-336" name="__codelineno-10-336"></a><span class="w">            </span><span class="k">else</span>
</span><span id="__span-10-337"><a id="__codelineno-10-337" name="__codelineno-10-337"></a><span class="w">                </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;SMOOTH: smoothBool set to false for this task. Skipping...\n&#39;</span><span class="p">)</span>
</span><span id="__span-10-338"><a id="__codelineno-10-338" name="__codelineno-10-338"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-10-339"><a id="__codelineno-10-339" name="__codelineno-10-339"></a>
</span><span id="__span-10-340"><a id="__codelineno-10-340" name="__codelineno-10-340"></a><span class="w">            </span><span class="c">% Specify functional images in SPM model specification for the current run.</span>
</span><span id="__span-10-341"><a id="__codelineno-10-341" name="__codelineno-10-341"></a><span class="w">            </span><span class="n">niiFileCell</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">niiFileString</span><span class="p">};</span>
</span><span id="__span-10-342"><a id="__codelineno-10-342" name="__codelineno-10-342"></a><span class="w">            </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">scans</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">spm_select</span><span class="p">(</span><span class="s">&#39;expand&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">niiFileCell</span><span class="p">);</span><span class="w"> </span><span class="c">% Expanded list of images.</span>
</span><span id="__span-10-343"><a id="__codelineno-10-343" name="__codelineno-10-343"></a>
</span><span id="__span-10-344"><a id="__codelineno-10-344" name="__codelineno-10-344"></a><span class="w">            </span><span class="c">% Set high-pass filter (HPF) to a value higher than the run duration to avoid filtering.</span>
</span><span id="__span-10-345"><a id="__codelineno-10-345" name="__codelineno-10-345"></a><span class="w">            </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">hpf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">timing</span><span class="p">.</span><span class="n">RT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">...</span>
</span><span id="__span-10-346"><a id="__codelineno-10-346" name="__codelineno-10-346"></a><span class="w">                </span><span class="nb">size</span><span class="p">(</span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">scans</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span><span id="__span-10-347"><a id="__codelineno-10-347" name="__codelineno-10-347"></a>
</span><span id="__span-10-348"><a id="__codelineno-10-348" name="__codelineno-10-348"></a><span class="w">            </span><span class="c">% Add conditions (events) to the model for the current run.</span>
</span><span id="__span-10-349"><a id="__codelineno-10-349" name="__codelineno-10-349"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">cond_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">events_struct</span><span class="p">.</span><span class="n">names</span><span class="p">)</span>
</span><span id="__span-10-350"><a id="__codelineno-10-350" name="__codelineno-10-350"></a><span class="w">                </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">cond</span><span class="p">(</span><span class="n">cond_id</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">events_struct</span><span class="p">.</span><span class="n">names</span><span class="p">{</span><span class="n">cond_id</span><span class="p">};</span>
</span><span id="__span-10-351"><a id="__codelineno-10-351" name="__codelineno-10-351"></a><span class="w">                </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">cond</span><span class="p">(</span><span class="n">cond_id</span><span class="p">).</span><span class="n">onset</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">events_struct</span><span class="p">.</span><span class="n">onsets</span><span class="p">{</span><span class="n">cond_id</span><span class="p">};</span>
</span><span id="__span-10-352"><a id="__codelineno-10-352" name="__codelineno-10-352"></a><span class="w">                </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">cond</span><span class="p">(</span><span class="n">cond_id</span><span class="p">).</span><span class="n">duration</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">events_struct</span><span class="p">.</span><span class="n">durations</span><span class="p">{</span><span class="n">cond_id</span><span class="p">};</span>
</span><span id="__span-10-353"><a id="__codelineno-10-353" name="__codelineno-10-353"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-10-354"><a id="__codelineno-10-354" name="__codelineno-10-354"></a>
</span><span id="__span-10-355"><a id="__codelineno-10-355" name="__codelineno-10-355"></a><span class="w">            </span><span class="c">% Add confound regressors to the model for the current run.</span>
</span><span id="__span-10-356"><a id="__codelineno-10-356" name="__codelineno-10-356"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">reg_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">confounds_array</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-10-357"><a id="__codelineno-10-357" name="__codelineno-10-357"></a><span class="w">                </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">regress</span><span class="p">(</span><span class="n">reg_id</span><span class="p">).</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">confounds_array</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">VariableNames</span><span class="p">{</span><span class="n">reg_id</span><span class="p">};</span>
</span><span id="__span-10-358"><a id="__codelineno-10-358" name="__codelineno-10-358"></a><span class="w">                </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">fmri_spec</span><span class="p">.</span><span class="n">sess</span><span class="p">(</span><span class="n">runIdx</span><span class="p">).</span><span class="n">regress</span><span class="p">(</span><span class="n">reg_id</span><span class="p">).</span><span class="n">val</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">confounds_array</span><span class="p">{:,</span><span class="w"> </span><span class="n">reg_id</span><span class="p">};</span>
</span><span id="__span-10-359"><a id="__codelineno-10-359" name="__codelineno-10-359"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-10-360"><a id="__codelineno-10-360" name="__codelineno-10-360"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-10-361"><a id="__codelineno-10-361" name="__codelineno-10-361"></a>
</span><span id="__span-10-362"><a id="__codelineno-10-362" name="__codelineno-10-362"></a>
</span><span id="__span-10-363"><a id="__codelineno-10-363" name="__codelineno-10-363"></a><span class="w">        </span><span class="c">% This final section initializes the SPM defaults, executes the GLM model specification and estimation,</span>
</span><span id="__span-10-364"><a id="__codelineno-10-364" name="__codelineno-10-364"></a><span class="w">        </span><span class="c">% verifies that the model ran successfully by checking for the SPM.mat file, and then defines and</span>
</span><span id="__span-10-365"><a id="__codelineno-10-365" name="__codelineno-10-365"></a><span class="w">        </span><span class="c">% applies contrasts. Finally, the script is copied to the output folder for replicability. Each step</span>
</span><span id="__span-10-366"><a id="__codelineno-10-366" name="__codelineno-10-366"></a><span class="w">        </span><span class="c">% is verified with status messages, providing clear feedback for the user.</span>
</span><span id="__span-10-367"><a id="__codelineno-10-367" name="__codelineno-10-367"></a>
</span><span id="__span-10-368"><a id="__codelineno-10-368" name="__codelineno-10-368"></a><span class="w">        </span><span class="c">%% RUN BATCHES 1 AND 2</span>
</span><span id="__span-10-369"><a id="__codelineno-10-369" name="__codelineno-10-369"></a>
</span><span id="__span-10-370"><a id="__codelineno-10-370" name="__codelineno-10-370"></a><span class="w">        </span><span class="c">% Initialize SPM defaults for fMRI analysis.</span>
</span><span id="__span-10-371"><a id="__codelineno-10-371" name="__codelineno-10-371"></a><span class="w">        </span><span class="n">spm</span><span class="p">(</span><span class="s">&#39;defaults&#39;</span><span class="p">,</span><span class="s">&#39;fmri&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Load SPM defaults for fMRI.</span>
</span><span id="__span-10-372"><a id="__codelineno-10-372" name="__codelineno-10-372"></a><span class="w">        </span><span class="n">spm_jobman</span><span class="p">(</span><span class="s">&#39;initcfg&#39;</span><span class="p">);</span><span class="w">  </span><span class="c">% Initialize the SPM job configuration.</span>
</span><span id="__span-10-373"><a id="__codelineno-10-373" name="__codelineno-10-373"></a>
</span><span id="__span-10-374"><a id="__codelineno-10-374" name="__codelineno-10-374"></a><span class="w">        </span><span class="c">% Execute the model specification (batch 1) and model estimation (batch 2).</span>
</span><span id="__span-10-375"><a id="__codelineno-10-375" name="__codelineno-10-375"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;GLM: Running GLM for: %s - TASK:  %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">subName</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTask</span><span class="p">)</span>
</span><span id="__span-10-376"><a id="__codelineno-10-376" name="__codelineno-10-376"></a><span class="w">        </span><span class="n">spm_jobman</span><span class="p">(</span><span class="s">&#39;run&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">matlabbatch</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">));</span>
</span><span id="__span-10-377"><a id="__codelineno-10-377" name="__codelineno-10-377"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;GLM: DONE!\n&#39;</span><span class="p">)</span>
</span><span id="__span-10-378"><a id="__codelineno-10-378" name="__codelineno-10-378"></a>
</span><span id="__span-10-379"><a id="__codelineno-10-379" name="__codelineno-10-379"></a><span class="w">        </span><span class="c">%% FIND SPM.mat</span>
</span><span id="__span-10-380"><a id="__codelineno-10-380" name="__codelineno-10-380"></a>
</span><span id="__span-10-381"><a id="__codelineno-10-381" name="__codelineno-10-381"></a><span class="w">        </span><span class="c">% After running the GLM, check for the existence of the SPM.mat file in the output path.</span>
</span><span id="__span-10-382"><a id="__codelineno-10-382" name="__codelineno-10-382"></a><span class="w">        </span><span class="c">% The SPM.mat file is essential for contrast specification.</span>
</span><span id="__span-10-383"><a id="__codelineno-10-383" name="__codelineno-10-383"></a><span class="w">        </span><span class="n">spmMatPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;SPM.mat&#39;</span><span class="p">);</span>
</span><span id="__span-10-384"><a id="__codelineno-10-384" name="__codelineno-10-384"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">exist</span><span class="p">(</span><span class="n">spmMatPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;file&#39;</span><span class="p">)</span>
</span><span id="__span-10-385"><a id="__codelineno-10-385" name="__codelineno-10-385"></a><span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;SPM.mat file not found in the specified output directory.&#39;</span><span class="p">);</span>
</span><span id="__span-10-386"><a id="__codelineno-10-386" name="__codelineno-10-386"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-10-387"><a id="__codelineno-10-387" name="__codelineno-10-387"></a>
</span><span id="__span-10-388"><a id="__codelineno-10-388" name="__codelineno-10-388"></a><span class="w">        </span><span class="c">%% RUN BATCH 3 (CONTRASTS)</span>
</span><span id="__span-10-389"><a id="__codelineno-10-389" name="__codelineno-10-389"></a>
</span><span id="__span-10-390"><a id="__codelineno-10-390" name="__codelineno-10-390"></a><span class="w">        </span><span class="c">% Define the path to the SPM.mat file in the batch structure for contrast estimation.</span>
</span><span id="__span-10-391"><a id="__codelineno-10-391" name="__codelineno-10-391"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">spmmat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">spmMatPath</span><span class="p">};</span>
</span><span id="__span-10-392"><a id="__codelineno-10-392" name="__codelineno-10-392"></a>
</span><span id="__span-10-393"><a id="__codelineno-10-393" name="__codelineno-10-393"></a><span class="w">        </span><span class="c">% Loop through each contrast defined for the current task.</span>
</span><span id="__span-10-394"><a id="__codelineno-10-394" name="__codelineno-10-394"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">contrasts</span><span class="p">)</span>
</span><span id="__span-10-395"><a id="__codelineno-10-395" name="__codelineno-10-395"></a><span class="w">            </span><span class="c">% Adjust contrast weights to fit the current design matrix structure.</span>
</span><span id="__span-10-396"><a id="__codelineno-10-396" name="__codelineno-10-396"></a><span class="w">            </span><span class="n">weights</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">adjust_contrasts</span><span class="p">(</span><span class="n">spmMatPath</span><span class="p">,</span><span class="w"> </span><span class="n">selectedTasks</span><span class="p">(</span><span class="n">selected_task_idx</span><span class="p">).</span><span class="n">weights</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
</span><span id="__span-10-397"><a id="__codelineno-10-397" name="__codelineno-10-397"></a>
</span><span id="__span-10-398"><a id="__codelineno-10-398" name="__codelineno-10-398"></a><span class="w">            </span><span class="c">% Define each contrast and its properties in the SPM batch structure.</span>
</span><span id="__span-10-399"><a id="__codelineno-10-399" name="__codelineno-10-399"></a><span class="w">            </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">consess</span><span class="p">{</span><span class="n">k</span><span class="p">}.</span><span class="n">tcon</span><span class="p">.</span><span class="n">weights</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">weights</span><span class="p">;</span><span class="w"> </span><span class="c">% Contrast weights.</span>
</span><span id="__span-10-400"><a id="__codelineno-10-400" name="__codelineno-10-400"></a><span class="w">            </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">consess</span><span class="p">{</span><span class="n">k</span><span class="p">}.</span><span class="n">tcon</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">contrasts</span><span class="p">{</span><span class="n">k</span><span class="p">};</span><span class="w"> </span><span class="c">% Name of the contrast.</span>
</span><span id="__span-10-401"><a id="__codelineno-10-401" name="__codelineno-10-401"></a><span class="w">            </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">3</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">con</span><span class="p">.</span><span class="n">consess</span><span class="p">{</span><span class="n">k</span><span class="p">}.</span><span class="n">tcon</span><span class="p">.</span><span class="n">sessrep</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;none&#39;</span><span class="p">;</span><span class="w"> </span><span class="c">% No session-specific replication.</span>
</span><span id="__span-10-402"><a id="__codelineno-10-402" name="__codelineno-10-402"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-10-403"><a id="__codelineno-10-403" name="__codelineno-10-403"></a>
</span><span id="__span-10-404"><a id="__codelineno-10-404" name="__codelineno-10-404"></a><span class="c">% Execute the contrast batch (batch 3).</span>
</span><span id="__span-10-405"><a id="__codelineno-10-405" name="__codelineno-10-405"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;Setting contrasts...\n&#39;</span><span class="p">);</span>
</span><span id="__span-10-406"><a id="__codelineno-10-406" name="__codelineno-10-406"></a><span class="n">spm_jobman</span><span class="p">(</span><span class="s">&#39;run&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">matlabbatch</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span><span id="__span-10-407"><a id="__codelineno-10-407" name="__codelineno-10-407"></a><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;DONE!\n&#39;</span><span class="p">);</span>
</span><span id="__span-10-408"><a id="__codelineno-10-408" name="__codelineno-10-408"></a><span class="k">end</span>
</span><span id="__span-10-409"><a id="__codelineno-10-409" name="__codelineno-10-409"></a><span class="c">%% SAVE SCRIPT</span>
</span><span id="__span-10-410"><a id="__codelineno-10-410" name="__codelineno-10-410"></a>
</span><span id="__span-10-411"><a id="__codelineno-10-411" name="__codelineno-10-411"></a><span class="c">% Save a copy of this script in the output directory for documentation and replicability.</span>
</span><span id="__span-10-412"><a id="__codelineno-10-412" name="__codelineno-10-412"></a><span class="n">FileNameAndLocation</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nb">mfilename</span><span class="p">(</span><span class="s">&#39;fullpath&#39;</span><span class="p">)];</span><span class="w"> </span><span class="c">% Get full path to this script.</span>
</span><span id="__span-10-413"><a id="__codelineno-10-413" name="__codelineno-10-413"></a><span class="n">script_outdir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="s">&#39;spmGLMautoContrast.m&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Set destination path for script copy.</span>
</span><span id="__span-10-414"><a id="__codelineno-10-414" name="__codelineno-10-414"></a><span class="n">currentfile</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="n">FileNameAndLocation</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.m&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% Get filename with extension.</span>
</span><span id="__span-10-415"><a id="__codelineno-10-415" name="__codelineno-10-415"></a><span class="nb">copyfile</span><span class="p">(</span><span class="n">currentfile</span><span class="p">,</span><span class="w"> </span><span class="n">script_outdir</span><span class="p">);</span><span class="w"> </span><span class="c">% Copy script to output directory.</span>
</span><span id="__span-10-416"><a id="__codelineno-10-416" name="__codelineno-10-416"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>findRunSubstring.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">function</span><span class="w"> </span>runSubstring<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">findRunSubstring</span><span class="p">(</span>inputStr<span class="p">)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="c">%FINDRUNSUBSTRING Extracts a &#39;run-xx&#39; substring from a given string</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="c">%   This function takes an input string and searches for a substring that</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="c">%   matches the pattern &#39;run-xx&#39;, where &#39;xx&#39; can be any one or two digit number.</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="c">%   If such a substring is found, it is returned; otherwise, an empty string</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="c">%   is returned.</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="c">% Regular expression to match &#39;run-&#39; followed by one or two digits</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="nb">pattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;run-\d{1,2}&#39;</span><span class="p">;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="c">% Search for the pattern in the input string</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="nb">matches</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">regexp</span><span class="p">(</span><span class="n">inputStr</span><span class="p">,</span><span class="w"> </span><span class="nb">pattern</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;match&#39;</span><span class="p">);</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="c">% Check if any match was found</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="nb">matches</span><span class="p">)</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="c">% If a match was found, return the first match</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="n">runSubstring</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">matches</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="k">else</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="c">% If no match was found, return an empty string</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="n">runSubstring</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">;</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="k">end</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>filterRowsBySubstring.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">function</span><span class="w"> </span>filteredRows<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">filterRowsBySubstring</span><span class="p">(</span>data, substring<span class="p">)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="c">%FILTERROWSBYSUBSTRING Filters rows based on a substring in the first column</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="c">%   This function takes a cell array &#39;data&#39; and a &#39;substring&#39; as inputs,</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="c">%   and returns a new cell array &#39;filteredRows&#39; containing only the rows</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="c">%   from &#39;data&#39; where the first column includes the specified &#39;substring&#39;.</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="c">% Initialize an empty cell array to store the filtered rows</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="n">filteredRows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="c">% Iterate through each row in the data</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="k">for</span><span class="w"> </span><span class="n">rowIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="c">% Fetch the first column of the current row</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="n">currentEntry</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">rowIndex</span><span class="p">).</span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">    </span><span class="c">% Check if the first column contains the specified substring</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">contains</span><span class="p">(</span><span class="n">currentEntry</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;_&#39;</span><span class="w"> </span><span class="n">substring</span><span class="w"> </span><span class="s">&#39;_&#39;</span><span class="p">])</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">        </span><span class="c">% If it does, add the current row to the filteredRows array</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">        </span><span class="n">filteredRows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">filteredRows</span><span class="p">;</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="n">rowIndex</span><span class="p">,</span><span class="w"> </span><span class="p">:)];</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="k">end</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>adjust_contrasts.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span>
<span class="normal"><a href="#__codelineno-13-43">43</a></span>
<span class="normal"><a href="#__codelineno-13-44">44</a></span>
<span class="normal"><a href="#__codelineno-13-45">45</a></span>
<span class="normal"><a href="#__codelineno-13-46">46</a></span>
<span class="normal"><a href="#__codelineno-13-47">47</a></span>
<span class="normal"><a href="#__codelineno-13-48">48</a></span>
<span class="normal"><a href="#__codelineno-13-49">49</a></span>
<span class="normal"><a href="#__codelineno-13-50">50</a></span>
<span class="normal"><a href="#__codelineno-13-51">51</a></span>
<span class="normal"><a href="#__codelineno-13-52">52</a></span>
<span class="normal"><a href="#__codelineno-13-53">53</a></span>
<span class="normal"><a href="#__codelineno-13-54">54</a></span>
<span class="normal"><a href="#__codelineno-13-55">55</a></span>
<span class="normal"><a href="#__codelineno-13-56">56</a></span>
<span class="normal"><a href="#__codelineno-13-57">57</a></span>
<span class="normal"><a href="#__codelineno-13-58">58</a></span>
<span class="normal"><a href="#__codelineno-13-59">59</a></span>
<span class="normal"><a href="#__codelineno-13-60">60</a></span>
<span class="normal"><a href="#__codelineno-13-61">61</a></span>
<span class="normal"><a href="#__codelineno-13-62">62</a></span>
<span class="normal"><a href="#__codelineno-13-63">63</a></span>
<span class="normal"><a href="#__codelineno-13-64">64</a></span>
<span class="normal"><a href="#__codelineno-13-65">65</a></span>
<span class="normal"><a href="#__codelineno-13-66">66</a></span>
<span class="normal"><a href="#__codelineno-13-67">67</a></span>
<span class="normal"><a href="#__codelineno-13-68">68</a></span>
<span class="normal"><a href="#__codelineno-13-69">69</a></span>
<span class="normal"><a href="#__codelineno-13-70">70</a></span>
<span class="normal"><a href="#__codelineno-13-71">71</a></span>
<span class="normal"><a href="#__codelineno-13-72">72</a></span>
<span class="normal"><a href="#__codelineno-13-73">73</a></span>
<span class="normal"><a href="#__codelineno-13-74">74</a></span>
<span class="normal"><a href="#__codelineno-13-75">75</a></span>
<span class="normal"><a href="#__codelineno-13-76">76</a></span>
<span class="normal"><a href="#__codelineno-13-77">77</a></span>
<span class="normal"><a href="#__codelineno-13-78">78</a></span>
<span class="normal"><a href="#__codelineno-13-79">79</a></span>
<span class="normal"><a href="#__codelineno-13-80">80</a></span>
<span class="normal"><a href="#__codelineno-13-81">81</a></span>
<span class="normal"><a href="#__codelineno-13-82">82</a></span>
<span class="normal"><a href="#__codelineno-13-83">83</a></span>
<span class="normal"><a href="#__codelineno-13-84">84</a></span>
<span class="normal"><a href="#__codelineno-13-85">85</a></span>
<span class="normal"><a href="#__codelineno-13-86">86</a></span>
<span class="normal"><a href="#__codelineno-13-87">87</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">function</span><span class="w"> </span>weight_vector<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">adjust_contrasts</span><span class="p">(</span>spmMatPath, contrastWeights<span class="p">)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="c">% ADJUST_CONTRASTS Adjust contrast weights according to the design matrix in SPM.</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="c">%</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c">% DESCRIPTION:</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="c">% This function adjusts the specified contrast weights according to the design</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="c">% matrix in SPM, and provides a visual representation of the weights applied to</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="c">% the design matrix.</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="c">%</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="c">% INPUTS:</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="c">% spmMatPath: String</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="c">%   - Path to the SPM.mat file.</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="c">%     Example: &#39;/path/to/SPM.mat&#39;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="c">%</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="c">% contrastWeights: Struct</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="c">%   - Specifies the weight of each condition in the contrast.</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="c">%     For wildcard specification, use &#39;*WILDCARD*&#39;. E.g., &#39;condition_WILDCARD_&#39;: weight</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="c">%     Example: struct(&#39;condition1&#39;, 1, &#39;condition2_WILDCARD_&#39;, -1)</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="c">%</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="c">% OUTPUTS:</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="c">% weight_vector: Numeric Vector</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="c">%   - A vector of weights for each regressor.</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="c">%     Example: [0, 1, -1, 0, ...]</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="c">%</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="c">% The function also generates a visual representation of the design matrix with</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="c">% the specified contrast weights.</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="c">% Load the SPM.mat</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="nb">load</span><span class="p">(</span><span class="n">spmMatPath</span><span class="p">);</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="c">% Extracting regressor names from the SPM structure</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="n">regressor_names</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SPM</span><span class="p">.</span><span class="n">xX</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="c">% Generate weight vector based on SPMs design matrix and specified weights for the single contrast</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="n">weight_vector</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">generate_weight_vector_from_spm</span><span class="p">(</span><span class="n">contrastWeights</span><span class="p">,</span><span class="w"> </span><span class="n">regressor_names</span><span class="p">);</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="c">% % Plotting for visual verification</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="c">% figure;</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="c">% </span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="c">% % Display the design matrix</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="c">% imagesc(SPM.xX.X);  % Display the design matrix</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="c">% colormap(&#39;gray&#39;);   % Set base colormap to gray for design matrix</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41"></a><span class="c">% hold on;</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42"></a><span class="c">% </span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43"></a><span class="c">% % Create a color overlay based on the weights</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44"></a><span class="c">% for i = 1:length(weight_vector)</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45"></a><span class="c">%     x = [i-0.5, i+0.5, i+0.5, i-0.5];</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46"></a><span class="c">%     y = [0.5, 0.5, length(SPM.xX.X) + 0.5, length(SPM.xX.X) + 0.5];</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47"></a><span class="c">%     if weight_vector(i) &gt; 0</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48"></a><span class="c">%         % Green for positive weights</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49"></a><span class="c">%         color = [0, weight_vector(i), 0];  % Green intensity based on weight value</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50"></a><span class="c">%         patch(x, y, color, &#39;EdgeColor&#39;, &#39;none&#39;, &#39;FaceAlpha&#39;, 0.3);  % Reduced transparency</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51"></a><span class="c">%     elseif weight_vector(i) &lt; 0</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52"></a><span class="c">%         % Red for negative weights</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53"></a><span class="c">%         color = [abs(weight_vector(i)), 0, 0];  % Red intensity based on absolute weight value</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54"></a><span class="c">%         patch(x, y, color, &#39;EdgeColor&#39;, &#39;none&#39;, &#39;FaceAlpha&#39;, 0.3);  % Reduced transparency</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55"></a><span class="c">%     end</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56"></a><span class="c">% end</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57"></a><span class="c">% </span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58"></a><span class="c">% % Annotate with regressor names</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59"></a><span class="c">% xticks(1:length(regressor_names));</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60"></a><span class="c">% xticklabels(&#39;&#39;);  % Initially empty, to be replaced by colored text objects</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61"></a><span class="c">% xtickangle(45);  % Angle the text so it doesnt overlap</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62"></a><span class="c">% set(gca, &#39;TickLabelInterpreter&#39;, &#39;none&#39;);  % Ensure special characters in regressor names display correctly</span>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63"></a><span class="c">% </span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64"></a><span class="c">% % Color code the regressor names using text objects</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65"></a><span class="c">% for i = 1:length(regressor_names)</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66"></a><span class="c">%     if weight_vector(i) &gt; 0</span>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67"></a><span class="c">%         textColor = [0, 0.6, 0];</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68"></a><span class="c">%     elseif weight_vector(i) &lt; 0</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69"></a><span class="c">%         textColor = [0.6, 0, 0];</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70"></a><span class="c">%     else</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71"></a><span class="c">%         textColor = [0, 0, 0];</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72"></a><span class="c">%     end</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73"></a><span class="c">%     text(i, length(SPM.xX.X) + 5, regressor_names{i}, &#39;Color&#39;, textColor, &#39;Rotation&#39;, 45, &#39;Interpreter&#39;, &#39;none&#39;, &#39;HorizontalAlignment&#39;, &#39;right&#39;, &#39;VerticalAlignment&#39;, &#39;bottom&#39;);</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74"></a><span class="c">% end</span>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75"></a><span class="c">% </span>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76"></a><span class="c">% title(&#39;Design Matrix with Contrast Weights&#39;);</span>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77"></a><span class="c">% xlabel(&#39;&#39;);</span>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78"></a><span class="c">% ylabel(&#39;Scans&#39;);</span>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79"></a><span class="c">% </span>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80"></a><span class="c">% % Add legends</span>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81"></a><span class="c">% legend({&#39;Positive Weights&#39;, &#39;Negative Weights&#39;}, &#39;Location&#39;, &#39;northoutside&#39;);</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82"></a><span class="c">% </span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83"></a><span class="c">% % Optional: Add a dual color colorbar to represent positive and negative weight intensities</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84"></a><span class="c">% colorbar(&#39;Ticks&#39;, [-1, 0, 1], &#39;TickLabels&#39;, {&#39;-Max Weight&#39;, &#39;0&#39;, &#39;+Max Weight&#39;}, &#39;Direction&#39;, &#39;reverse&#39;);</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85"></a><span class="c">% </span>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86"></a><span class="c">% hold off;</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>generate_weight_vector_from_spm.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span>
<span class="normal"><a href="#__codelineno-14-50">50</a></span>
<span class="normal"><a href="#__codelineno-14-51">51</a></span>
<span class="normal"><a href="#__codelineno-14-52">52</a></span>
<span class="normal"><a href="#__codelineno-14-53">53</a></span>
<span class="normal"><a href="#__codelineno-14-54">54</a></span>
<span class="normal"><a href="#__codelineno-14-55">55</a></span>
<span class="normal"><a href="#__codelineno-14-56">56</a></span>
<span class="normal"><a href="#__codelineno-14-57">57</a></span>
<span class="normal"><a href="#__codelineno-14-58">58</a></span>
<span class="normal"><a href="#__codelineno-14-59">59</a></span>
<span class="normal"><a href="#__codelineno-14-60">60</a></span>
<span class="normal"><a href="#__codelineno-14-61">61</a></span>
<span class="normal"><a href="#__codelineno-14-62">62</a></span>
<span class="normal"><a href="#__codelineno-14-63">63</a></span>
<span class="normal"><a href="#__codelineno-14-64">64</a></span>
<span class="normal"><a href="#__codelineno-14-65">65</a></span>
<span class="normal"><a href="#__codelineno-14-66">66</a></span>
<span class="normal"><a href="#__codelineno-14-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">function</span><span class="w"> </span>weight_vector<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">generate_weight_vector_from_spm</span><span class="p">(</span>contrastWeights, regressor_names<span class="p">)</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="c">% GENERATE_WEIGHT_VECTOR_FROM_SPM Generates a weight vector from the SPM design matrix.</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="c">%</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="c">% This function constructs a weight vector based on the design matrix in SPM</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="c">% and the user-specified contrast weights. Its equipped to handle wildcard matches</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="c">% in condition names for flexibility in defining contrasts.</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="c">%</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="c">% USAGE:</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="c">%   weight_vector = generate_weight_vector_from_spm(contrastWeights, regressor_names)</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="c">%</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="c">% INPUTS:</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="c">%   contrastWeights : struct</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="c">%       A struct specifying the weight of each condition in the contrast.</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="c">%       Fields of the struct are condition names and the associated values are the contrast weights.</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="c">%       Use &#39;*WILDCARD*&#39; in the condition name to denote a wildcard match.</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="c">%       Example:</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="c">%           contrastWeights = struct(&#39;Faces&#39;, 1, &#39;Objects_WILDCARD_&#39;, -1);</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="c">%</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="c">%   regressor_names : cell array of strings</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="c">%       Names of the regressors extracted from the SPM.mat structure.</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="c">%       Typically includes task conditions and confound regressors.</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="c">%       Example:</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="c">%           {&#39;Sn(1) Faces*bf(1)&#39;, &#39;Sn(1) Objects*bf(1)&#39;, &#39;Sn(1) trans_x&#39;, ...}</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="c">%</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="c">% OUTPUTS:</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="c">%   weight_vector : numeric vector</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27"></a><span class="c">%       A vector of weights for each regressor in the order they appear in the regressor_names.</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="c">%       Example:</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="c">%           [1, -1, 0, ...]</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30"></a><span class="c">%</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31"></a><span class="c">% Note:</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32"></a><span class="c">%   This function assumes that task-related regressors in the SPM design matrix end with &quot;*bf(1)&quot;.</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="c">%   Confound regressors (e.g., motion parameters) do not have this suffix.</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34"></a>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35"></a><span class="c">% Initialize a weight vector of zeros</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36"></a><span class="n">weight_vector</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">length</span><span class="p">(</span><span class="n">regressor_names</span><span class="p">));</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37"></a>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="c">% Extract field names from the contrastWeights structure</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39"></a><span class="n">fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fieldnames</span><span class="p">(</span><span class="n">contrastWeights</span><span class="p">);</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40"></a>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="c">% Iterate over the field names to match with regressor names</span>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="w">    </span><span class="n">field</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fields</span><span class="p">{</span><span class="nb">i</span><span class="p">};</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44"></a>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45"></a><span class="w">    </span><span class="c">% If the field contains a wildcard, handle it</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">contains</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_WILDCARD_&#39;</span><span class="p">)</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47"></a><span class="w">        </span><span class="c">% Convert the wildcard pattern to a regular expression pattern</span>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48"></a><span class="w">        </span><span class="nb">pattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;Sn\(.\) &#39;</span><span class="w"> </span><span class="nb">strrep</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_WILDCARD_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.*&#39;</span><span class="p">)];</span>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49"></a>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50"></a><span class="w">        </span><span class="c">% Find indices of matching regressors using the regular expression pattern</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="o">~</span><span class="nb">cellfun</span><span class="p">(</span><span class="s">&#39;isempty&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">regexp</span><span class="p">(</span><span class="n">regressor_names</span><span class="p">,</span><span class="w"> </span><span class="nb">pattern</span><span class="p">)));</span>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52"></a>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53"></a><span class="w">        </span><span class="c">% Assign the weight from contrastWeights to the matching regressors</span>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54"></a><span class="w">        </span><span class="n">weight_vector</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">contrastWeights</span><span class="p">.(</span><span class="n">field</span><span class="p">);</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56"></a><span class="w">        </span><span class="c">% No need to extract the condition name, just append *bf(1) to match the SPM regressor pattern</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57"></a><span class="w">        </span><span class="nb">pattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;Sn\(.\) &#39;</span><span class="w"> </span><span class="n">field</span><span class="p">];</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58"></a>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="o">~</span><span class="nb">cellfun</span><span class="p">(</span><span class="s">&#39;isempty&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">regexp</span><span class="p">(</span><span class="n">regressor_names</span><span class="p">,</span><span class="w"> </span><span class="nb">pattern</span><span class="p">)));</span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60"></a>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61"></a><span class="w">        </span><span class="c">% Assign the weight from contrastWeights to the regressor</span>
</span><span id="__span-14-62"><a id="__codelineno-14-62" name="__codelineno-14-62"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63"></a><span class="w">            </span><span class="n">weight_vector</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">contrastWeights</span><span class="p">.(</span><span class="n">field</span><span class="p">);</span>
</span><span id="__span-14-64"><a id="__codelineno-14-64" name="__codelineno-14-64"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-14-65"><a id="__codelineno-14-65" name="__codelineno-14-65"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-14-66"><a id="__codelineno-14-66" name="__codelineno-14-66"></a><span class="k">end</span>
</span><span id="__span-14-67"><a id="__codelineno-14-67" name="__codelineno-14-67"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>eventsBIDS2SPM.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span>
<span class="normal"><a href="#__codelineno-15-33">33</a></span>
<span class="normal"><a href="#__codelineno-15-34">34</a></span>
<span class="normal"><a href="#__codelineno-15-35">35</a></span>
<span class="normal"><a href="#__codelineno-15-36">36</a></span>
<span class="normal"><a href="#__codelineno-15-37">37</a></span>
<span class="normal"><a href="#__codelineno-15-38">38</a></span>
<span class="normal"><a href="#__codelineno-15-39">39</a></span>
<span class="normal"><a href="#__codelineno-15-40">40</a></span>
<span class="normal"><a href="#__codelineno-15-41">41</a></span>
<span class="normal"><a href="#__codelineno-15-42">42</a></span>
<span class="normal"><a href="#__codelineno-15-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">function</span><span class="w"> </span>new_df<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">eventsBIDS2SPM</span><span class="p">(</span>tsv_file<span class="p">)</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">    </span><span class="c">% eventsBIDS2SPM - Convert BIDS event files to SPM format</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="c">% This function reads a BIDS event file and converts it to the format required by SPM.</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="c">% It extracts the unique trial types and their onsets and durations and stores them in a</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="c">% Matlab structure.</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="c">% Author: Andrea Costantino</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="c">% Date: 23/1/2023</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">    </span><span class="c">% Usage:</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">    </span><span class="c">%   mat_dict = eventsBIDS2SPM(tsv_file, run_id)</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">    </span><span class="c">% Inputs:</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">    </span><span class="c">%   tsv_file - string, path to the tsv file containing the events</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="c">% Outputs:</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="c">%   mat_dict - struct, a Matlab structure containing the events in the format</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">    </span><span class="c">%              required by SPM. The structure contains three fields:</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">    </span><span class="c">%                - &#39;names&#39;: cell array of string, the names of the trial types</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="w">    </span><span class="c">%                - &#39;onsets&#39;: cell array of double, onset times of the trials</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">    </span><span class="c">%                - &#39;durations&#39;: cell array of double, duration of the trials</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">    </span><span class="c">% This function reads a BIDS event file and converts it to the format required by SPM.</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="w">    </span><span class="c">% It extracts the unique trial types and their onsets and durations and stores them in a</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">    </span><span class="c">% Matlab structure</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="w">    </span><span class="c">% read the tsv file</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">    </span><span class="n">df</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">readtable</span><span class="p">(</span><span class="n">tsv_file</span><span class="p">,</span><span class="s">&#39;FileType&#39;</span><span class="p">,</span><span class="s">&#39;text&#39;</span><span class="p">);</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">    </span><span class="c">% Select unique trial type name</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="w">    </span><span class="n">unique_names</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">unique</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">trial_type</span><span class="p">);</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="w">    </span><span class="c">% Make new table in a form that SPM can read</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="w">    </span><span class="n">new_df</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">table</span><span class="p">(</span><span class="s">&#39;Size&#39;</span><span class="p">,[</span><span class="nb">length</span><span class="p">(</span><span class="n">unique_names</span><span class="p">),</span><span class="mi">3</span><span class="p">],</span><span class="s">&#39;VariableTypes&#39;</span><span class="p">,{</span><span class="s">&#39;cellstr&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;cellstr&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;cellstr&#39;</span><span class="p">},</span><span class="s">&#39;VariableNames&#39;</span><span class="p">,{</span><span class="s">&#39;names&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;onsets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;durations&#39;</span><span class="p">});</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="w">    </span><span class="c">% For each trial type (i.e., condition)</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">unique_names</span><span class="p">)</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="w">        </span><span class="c">% Select rows belonging to that condition</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="w">        </span><span class="n">filtered</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">df</span><span class="p">(</span><span class="nb">strcmp</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">trial_type</span><span class="p">,</span><span class="n">unique_names</span><span class="p">{</span><span class="n">k</span><span class="p">}),:);</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37"></a><span class="w">        </span><span class="c">% Copy trial name, onset and duration to the new table</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38"></a><span class="w">        </span><span class="n">new_df</span><span class="p">.</span><span class="n">names</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">unique</span><span class="p">(</span><span class="n">filtered</span><span class="p">.</span><span class="n">trial_type</span><span class="p">);</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39"></a><span class="w">        </span><span class="n">new_df</span><span class="p">.</span><span class="n">onsets</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">filtered</span><span class="p">.</span><span class="n">onset</span><span class="p">};</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40"></a><span class="w">        </span><span class="n">new_df</span><span class="p">.</span><span class="n">durations</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">filtered</span><span class="p">.</span><span class="n">duration</span><span class="p">};</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42"></a><span class="w">    </span><span class="n">new_df</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sortrows</span><span class="p">(</span><span class="n">new_df</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;names&#39;</span><span class="p">);</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>findSubjectsFolders.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span>
<span class="normal"><a href="#__codelineno-16-45">45</a></span>
<span class="normal"><a href="#__codelineno-16-46">46</a></span>
<span class="normal"><a href="#__codelineno-16-47">47</a></span>
<span class="normal"><a href="#__codelineno-16-48">48</a></span>
<span class="normal"><a href="#__codelineno-16-49">49</a></span>
<span class="normal"><a href="#__codelineno-16-50">50</a></span>
<span class="normal"><a href="#__codelineno-16-51">51</a></span>
<span class="normal"><a href="#__codelineno-16-52">52</a></span>
<span class="normal"><a href="#__codelineno-16-53">53</a></span>
<span class="normal"><a href="#__codelineno-16-54">54</a></span>
<span class="normal"><a href="#__codelineno-16-55">55</a></span>
<span class="normal"><a href="#__codelineno-16-56">56</a></span>
<span class="normal"><a href="#__codelineno-16-57">57</a></span>
<span class="normal"><a href="#__codelineno-16-58">58</a></span>
<span class="normal"><a href="#__codelineno-16-59">59</a></span>
<span class="normal"><a href="#__codelineno-16-60">60</a></span>
<span class="normal"><a href="#__codelineno-16-61">61</a></span>
<span class="normal"><a href="#__codelineno-16-62">62</a></span>
<span class="normal"><a href="#__codelineno-16-63">63</a></span>
<span class="normal"><a href="#__codelineno-16-64">64</a></span>
<span class="normal"><a href="#__codelineno-16-65">65</a></span>
<span class="normal"><a href="#__codelineno-16-66">66</a></span>
<span class="normal"><a href="#__codelineno-16-67">67</a></span>
<span class="normal"><a href="#__codelineno-16-68">68</a></span>
<span class="normal"><a href="#__codelineno-16-69">69</a></span>
<span class="normal"><a href="#__codelineno-16-70">70</a></span>
<span class="normal"><a href="#__codelineno-16-71">71</a></span>
<span class="normal"><a href="#__codelineno-16-72">72</a></span>
<span class="normal"><a href="#__codelineno-16-73">73</a></span>
<span class="normal"><a href="#__codelineno-16-74">74</a></span>
<span class="normal"><a href="#__codelineno-16-75">75</a></span>
<span class="normal"><a href="#__codelineno-16-76">76</a></span>
<span class="normal"><a href="#__codelineno-16-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">function</span><span class="w"> </span>[filteredFolderStructure]<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">findSubjectsFolders</span><span class="p">(</span>fmriprepRoot, selectedSubjectsList, excludedSubjectsList<span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="c">% FINDSUBJECTSFOLDERS Locate subject folders based on a list or wildcard.</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="c">%</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="c">% USAGE:</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="c">% sub_paths = findSubjectsFolders(fmriprepRoot, selectedSubjectsList)</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="c">%</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="c">% INPUTS:</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="c">% fmriprepRoot          - The root directory where &#39;sub-*&#39; folders are located.</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="c">%</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="c">% selectedSubjectsList  - Can be one of two things:</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="c">%                         1) A list of integers, each representing a subject ID.</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="c">%                            For example, [7,9] would search for folders &#39;sub-07&#39;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="c">%                            and &#39;sub-09&#39; respectively.</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="c">%                         2) A single character string &#39;*&#39;. In this case, the function</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="c">%                            will return all folders starting with &#39;sub-*&#39;.</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="c">%</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="c">% OUTPUTS:</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="c">% sub_paths             - A structure array corresponding to the found directories.</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="c">%                         Each structure has fields: &#39;name&#39;, &#39;folder&#39;, &#39;date&#39;,</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="c">%                         &#39;bytes&#39;, &#39;isdir&#39;, and &#39;datenum&#39;.</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="c">%</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="c">% EXAMPLES:</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="c">% 1) To fetch directories for specific subjects:</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="c">%    sub_paths = findSubjectsFolders(&#39;/path/to/fmriprepRoot&#39;, [7,9]);</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="c">%</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="c">% 2) To fetch all directories starting with &#39;sub-*&#39;:</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="c">%    sub_paths = findSubjectsFolders(&#39;/path/to/fmriprepRoot&#39;, &#39;*&#39;);</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="c">%</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="c">% NOTE:</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="c">% If a subject ID from the list does not match any directory, a warning is issued.</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="c">% Start by fetching all directories with the &#39;sub-*&#39; pattern.</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="n">sub_paths</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">dir</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">fmriprepRoot</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;sub-*&#39;</span><span class="p">));</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="n">sub_paths</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sub_paths</span><span class="p">([</span><span class="n">sub_paths</span><span class="p">.</span><span class="n">isdir</span><span class="p">]);</span><span class="w"> </span><span class="c">% Keep only directories.</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="c">% Check the type of selectedSubjectsList</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="k">if</span><span class="w"> </span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">selectedSubjectsList</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="w">    </span><span class="c">% Case 1: selectedSubjectsList is a list of integers.</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="w">    </span><span class="c">% Convert each integer in the list to a string of the form &#39;sub-XX&#39;.</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41"></a><span class="w">    </span><span class="n">subIDs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;sub-%02d&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="nb">num2cell</span><span class="p">(</span><span class="n">selectedSubjectsList</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42"></a>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="w">    </span><span class="c">% Filter the sub_paths to keep only those directories matching the subIDs.</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a><span class="w">    </span><span class="n">sub_paths</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sub_paths</span><span class="p">(</span><span class="nb">ismember</span><span class="p">({</span><span class="n">sub_paths</span><span class="p">.</span><span class="n">name</span><span class="p">},</span><span class="w"> </span><span class="n">subIDs</span><span class="p">));</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45"></a>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46"></a><span class="w">    </span><span class="c">% Check and throw warnings for any missing subID.</span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47"></a><span class="w">    </span><span class="n">foundSubIDs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">sub_paths</span><span class="p">.</span><span class="n">name</span><span class="p">};</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">subIDs</span><span class="p">)</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">ismember</span><span class="p">(</span><span class="n">subIDs</span><span class="p">{</span><span class="nb">i</span><span class="p">},</span><span class="w"> </span><span class="n">foundSubIDs</span><span class="p">)</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50"></a><span class="w">            </span><span class="nb">warning</span><span class="p">([</span><span class="s">&#39;The subID &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">subIDs</span><span class="p">{</span><span class="nb">i</span><span class="p">},</span><span class="w"> </span><span class="s">&#39; was not found in sub_paths.name.&#39;</span><span class="p">]);</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53"></a>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54"></a><span class="k">elseif</span><span class="w"> </span><span class="nb">ischar</span><span class="p">(</span><span class="n">selectedSubjectsList</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">strcmp</span><span class="p">(</span><span class="n">selectedSubjectsList</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;*&#39;</span><span class="p">)</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55"></a><span class="w">    </span><span class="c">% Case 2: selectedSubjectsList is &#39;*&#39;. </span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56"></a><span class="w">    </span><span class="c">% No further action required as we have already selected all &#39;sub-*&#39; folders.</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57"></a>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58"></a><span class="k">else</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59"></a><span class="w">    </span><span class="c">% Invalid input.</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60"></a><span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;Invalid format for selectedSubjects. It should be either &quot;*&quot; or a list of integers.&#39;</span><span class="p">);</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61"></a><span class="k">end</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62"></a>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63"></a><span class="c">% Only process exclusion if the excludedSubjectsList is provided.</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64"></a><span class="k">if</span><span class="w"> </span><span class="nb">nargin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65"></a><span class="w">    </span><span class="c">% Create a list of excluded folder names</span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66"></a><span class="w">    </span><span class="n">excludedNames</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;sub-%02d&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="nb">num2cell</span><span class="p">(</span><span class="n">excludedSubjectsList</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67"></a>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68"></a><span class="w">    </span><span class="c">% Logical array of folders to exclude</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69"></a><span class="w">    </span><span class="n">excludeMask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">arrayfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">ismember</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">excludedNames</span><span class="p">),</span><span class="w"> </span><span class="n">sub_paths</span><span class="p">);</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70"></a>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71"></a><span class="w">    </span><span class="c">% Filtered structure</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72"></a><span class="w">    </span><span class="n">filteredFolderStructure</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sub_paths</span><span class="p">(</span><span class="o">~</span><span class="n">excludeMask</span><span class="p">);</span>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73"></a><span class="k">else</span>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74"></a><span class="w">    </span><span class="c">% If no excludedSubjectsList is provided, just return the sub_paths.</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75"></a><span class="w">    </span><span class="n">filteredFolderStructure</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">sub_paths</span><span class="p">;</span>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76"></a><span class="k">end</span>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>fMRIprepConfounds2SPM.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">  1</a></span>
<span class="normal"><a href="#__codelineno-17-2">  2</a></span>
<span class="normal"><a href="#__codelineno-17-3">  3</a></span>
<span class="normal"><a href="#__codelineno-17-4">  4</a></span>
<span class="normal"><a href="#__codelineno-17-5">  5</a></span>
<span class="normal"><a href="#__codelineno-17-6">  6</a></span>
<span class="normal"><a href="#__codelineno-17-7">  7</a></span>
<span class="normal"><a href="#__codelineno-17-8">  8</a></span>
<span class="normal"><a href="#__codelineno-17-9">  9</a></span>
<span class="normal"><a href="#__codelineno-17-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-17-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-17-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-17-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-17-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-17-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-17-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-17-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-17-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-17-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-17-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-17-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-17-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-17-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-17-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-17-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-17-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-17-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-17-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-17-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-17-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-17-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-17-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-17-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-17-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-17-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-17-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-17-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-17-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-17-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-17-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-17-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-17-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-17-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-17-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-17-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-17-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-17-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-17-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-17-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-17-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-17-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-17-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-17-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-17-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-17-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-17-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-17-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-17-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-17-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-17-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-17-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-17-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-17-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-17-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-17-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-17-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-17-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-17-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-17-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-17-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-17-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-17-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-17-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-17-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-17-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-17-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-17-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-17-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-17-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-17-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-17-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-17-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-17-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-17-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-17-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-17-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-17-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-17-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-17-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-17-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-17-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-17-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-17-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-17-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-17-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-17-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-17-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-17-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-17-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-17-100">100</a></span>
<span class="normal"><a href="#__codelineno-17-101">101</a></span>
<span class="normal"><a href="#__codelineno-17-102">102</a></span>
<span class="normal"><a href="#__codelineno-17-103">103</a></span>
<span class="normal"><a href="#__codelineno-17-104">104</a></span>
<span class="normal"><a href="#__codelineno-17-105">105</a></span>
<span class="normal"><a href="#__codelineno-17-106">106</a></span>
<span class="normal"><a href="#__codelineno-17-107">107</a></span>
<span class="normal"><a href="#__codelineno-17-108">108</a></span>
<span class="normal"><a href="#__codelineno-17-109">109</a></span>
<span class="normal"><a href="#__codelineno-17-110">110</a></span>
<span class="normal"><a href="#__codelineno-17-111">111</a></span>
<span class="normal"><a href="#__codelineno-17-112">112</a></span>
<span class="normal"><a href="#__codelineno-17-113">113</a></span>
<span class="normal"><a href="#__codelineno-17-114">114</a></span>
<span class="normal"><a href="#__codelineno-17-115">115</a></span>
<span class="normal"><a href="#__codelineno-17-116">116</a></span>
<span class="normal"><a href="#__codelineno-17-117">117</a></span>
<span class="normal"><a href="#__codelineno-17-118">118</a></span>
<span class="normal"><a href="#__codelineno-17-119">119</a></span>
<span class="normal"><a href="#__codelineno-17-120">120</a></span>
<span class="normal"><a href="#__codelineno-17-121">121</a></span>
<span class="normal"><a href="#__codelineno-17-122">122</a></span>
<span class="normal"><a href="#__codelineno-17-123">123</a></span>
<span class="normal"><a href="#__codelineno-17-124">124</a></span>
<span class="normal"><a href="#__codelineno-17-125">125</a></span>
<span class="normal"><a href="#__codelineno-17-126">126</a></span>
<span class="normal"><a href="#__codelineno-17-127">127</a></span>
<span class="normal"><a href="#__codelineno-17-128">128</a></span>
<span class="normal"><a href="#__codelineno-17-129">129</a></span>
<span class="normal"><a href="#__codelineno-17-130">130</a></span>
<span class="normal"><a href="#__codelineno-17-131">131</a></span>
<span class="normal"><a href="#__codelineno-17-132">132</a></span>
<span class="normal"><a href="#__codelineno-17-133">133</a></span>
<span class="normal"><a href="#__codelineno-17-134">134</a></span>
<span class="normal"><a href="#__codelineno-17-135">135</a></span>
<span class="normal"><a href="#__codelineno-17-136">136</a></span>
<span class="normal"><a href="#__codelineno-17-137">137</a></span>
<span class="normal"><a href="#__codelineno-17-138">138</a></span>
<span class="normal"><a href="#__codelineno-17-139">139</a></span>
<span class="normal"><a href="#__codelineno-17-140">140</a></span>
<span class="normal"><a href="#__codelineno-17-141">141</a></span>
<span class="normal"><a href="#__codelineno-17-142">142</a></span>
<span class="normal"><a href="#__codelineno-17-143">143</a></span>
<span class="normal"><a href="#__codelineno-17-144">144</a></span>
<span class="normal"><a href="#__codelineno-17-145">145</a></span>
<span class="normal"><a href="#__codelineno-17-146">146</a></span>
<span class="normal"><a href="#__codelineno-17-147">147</a></span>
<span class="normal"><a href="#__codelineno-17-148">148</a></span>
<span class="normal"><a href="#__codelineno-17-149">149</a></span>
<span class="normal"><a href="#__codelineno-17-150">150</a></span>
<span class="normal"><a href="#__codelineno-17-151">151</a></span>
<span class="normal"><a href="#__codelineno-17-152">152</a></span>
<span class="normal"><a href="#__codelineno-17-153">153</a></span>
<span class="normal"><a href="#__codelineno-17-154">154</a></span>
<span class="normal"><a href="#__codelineno-17-155">155</a></span>
<span class="normal"><a href="#__codelineno-17-156">156</a></span>
<span class="normal"><a href="#__codelineno-17-157">157</a></span>
<span class="normal"><a href="#__codelineno-17-158">158</a></span>
<span class="normal"><a href="#__codelineno-17-159">159</a></span>
<span class="normal"><a href="#__codelineno-17-160">160</a></span>
<span class="normal"><a href="#__codelineno-17-161">161</a></span>
<span class="normal"><a href="#__codelineno-17-162">162</a></span>
<span class="normal"><a href="#__codelineno-17-163">163</a></span>
<span class="normal"><a href="#__codelineno-17-164">164</a></span>
<span class="normal"><a href="#__codelineno-17-165">165</a></span>
<span class="normal"><a href="#__codelineno-17-166">166</a></span>
<span class="normal"><a href="#__codelineno-17-167">167</a></span>
<span class="normal"><a href="#__codelineno-17-168">168</a></span>
<span class="normal"><a href="#__codelineno-17-169">169</a></span>
<span class="normal"><a href="#__codelineno-17-170">170</a></span>
<span class="normal"><a href="#__codelineno-17-171">171</a></span>
<span class="normal"><a href="#__codelineno-17-172">172</a></span>
<span class="normal"><a href="#__codelineno-17-173">173</a></span>
<span class="normal"><a href="#__codelineno-17-174">174</a></span>
<span class="normal"><a href="#__codelineno-17-175">175</a></span>
<span class="normal"><a href="#__codelineno-17-176">176</a></span>
<span class="normal"><a href="#__codelineno-17-177">177</a></span>
<span class="normal"><a href="#__codelineno-17-178">178</a></span>
<span class="normal"><a href="#__codelineno-17-179">179</a></span>
<span class="normal"><a href="#__codelineno-17-180">180</a></span>
<span class="normal"><a href="#__codelineno-17-181">181</a></span>
<span class="normal"><a href="#__codelineno-17-182">182</a></span>
<span class="normal"><a href="#__codelineno-17-183">183</a></span>
<span class="normal"><a href="#__codelineno-17-184">184</a></span>
<span class="normal"><a href="#__codelineno-17-185">185</a></span>
<span class="normal"><a href="#__codelineno-17-186">186</a></span>
<span class="normal"><a href="#__codelineno-17-187">187</a></span>
<span class="normal"><a href="#__codelineno-17-188">188</a></span>
<span class="normal"><a href="#__codelineno-17-189">189</a></span>
<span class="normal"><a href="#__codelineno-17-190">190</a></span>
<span class="normal"><a href="#__codelineno-17-191">191</a></span>
<span class="normal"><a href="#__codelineno-17-192">192</a></span>
<span class="normal"><a href="#__codelineno-17-193">193</a></span>
<span class="normal"><a href="#__codelineno-17-194">194</a></span>
<span class="normal"><a href="#__codelineno-17-195">195</a></span>
<span class="normal"><a href="#__codelineno-17-196">196</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">function</span><span class="w"> </span>confounds<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">fMRIprepConfounds2SPM</span><span class="p">(</span>json_path, tsv_path, pipeline<span class="p">)</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="c">% fMRIprepConfounds2SPM - Extracts and formats fMRI confounds for SPM analysis</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="c">%</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="c">% This function processes confound data from fMRIprep outputs, suitable for</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="c">% Statistical Parametric Mapping (SPM) analysis. It reads a JSON file with</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="c">% confound descriptions and a TSV file with confound values, then selects and</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="c">% formats the required confounds based on the specified denoising pipeline.</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="c">%</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="c">% Usage:</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="c">%   confounds = fMRIprepConfounds2SPM(json_path, tsv_path, pipeline)</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="c">%</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="c">% Inputs:</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="c">%   json_path (string): Full path to the JSON file. This file contains metadata</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="c">%                       about the confounds, such as their names and properties.</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="c">%</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="c">%   tsv_path (string):  Full path to the TSV file. This file holds the actual</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="c">%                       confound values in a tabular format for each fMRI run.</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="c">%</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="c">%   pipeline (cell array of strings): Specifies the denoising strategies to be</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="c">%                                     applied. Each element is a string in the</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="c">%                                     format &#39;strategy-number&#39;. For example,</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="c">%                                     &#39;HMP-6&#39; indicates using 6 head motion</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="c">%                                     parameters. Valid strategies include:</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="c">%             &#39;HMP&#39;: Head Motion Parameters, options: 6, 12, 24</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="c">%             &#39;GS&#39;: Global Signal, options: 1, 2, 4</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="c">%             &#39;CSF_WM&#39;: CSF and White Matter signals, options: 2, 4, 8</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="c">%             &#39;aCompCor&#39;: CompCor, options: 10, 50</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="c">%             &#39;MotionOutlier&#39;: Motion Outliers, options: FD &gt; 0.5, DVARS &gt; 1.5</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="c">%             &#39;Cosine&#39;: Discrete Cosine Transform based regressors for HPF</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="c">%             &#39;FD&#39;: Framewise Displacement, a raw non-binary value</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="c">%             &#39;Null&#39;: Returns an empty table if no confounds are to be applied</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32"></a><span class="c">%</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33"></a><span class="c">% Outputs:</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34"></a><span class="c">%   confounds (table): A table containing the selected confounds, formatted for</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35"></a><span class="c">%                      use in SPM. Each column represents a different confound,</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36"></a><span class="c">%                      and each row corresponds to a time point in the fMRI data.</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37"></a><span class="c">%</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38"></a><span class="c">% Author: Andrea Costantino</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39"></a><span class="c">% Date: 23/1/2023</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="c">%</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41"></a><span class="c">% Example:</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42"></a><span class="c">%   confounds = fMRIprepConfounds2SPM(&#39;path/to/json&#39;, &#39;path/to/tsv&#39;, {&#39;HMP-6&#39;, &#39;GS-4&#39;});</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43"></a><span class="c">%</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44"></a><span class="c">% This example would extract and format 6 head motion parameters and the global</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45"></a><span class="c">% signal (with raw, derivative, and squared derivative) for SPM analysis.</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46"></a>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47"></a><span class="c">% Read the TSV file containing the confound values</span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48"></a><span class="n">tsv_run</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">readtable</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;FileType&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;text&#39;</span><span class="p">);</span>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49"></a>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50"></a><span class="c">% Open and read the JSON file, then parse it into a MATLAB structure</span>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51"></a><span class="n">fid</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fopen</span><span class="p">(</span><span class="n">json_path</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52"></a><span class="n">raw</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fread</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="n">inf</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53"></a><span class="n">str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="n">raw</span><span class="o">&#39;</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54"></a><span class="nb">fclose</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55"></a><span class="n">json_run</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">jsondecode</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56"></a>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57"></a><span class="c">% Initialize an empty cell array to store the keys of the selected confounds</span>
</span><span id="__span-17-58"><a id="__codelineno-17-58" name="__codelineno-17-58"></a><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-17-59"><a id="__codelineno-17-59" name="__codelineno-17-59"></a>
</span><span id="__span-17-60"><a id="__codelineno-17-60" name="__codelineno-17-60"></a><span class="c">% If &#39;Null&#39; is found in the pipeline, return an empty table and exit the function</span>
</span><span id="__span-17-61"><a id="__codelineno-17-61" name="__codelineno-17-61"></a><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">strcmp</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Null&#39;</span><span class="p">))</span>
</span><span id="__span-17-62"><a id="__codelineno-17-62" name="__codelineno-17-62"></a><span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;&quot;Null&quot; found in the pipeline. Returning an empty table.&#39;</span><span class="p">)</span>
</span><span id="__span-17-63"><a id="__codelineno-17-63" name="__codelineno-17-63"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-17-64"><a id="__codelineno-17-64" name="__codelineno-17-64"></a><span class="k">else</span>
</span><span id="__span-17-65"><a id="__codelineno-17-65" name="__codelineno-17-65"></a><span class="w">    </span><span class="c">% Process each specified strategy in the pipeline</span>
</span><span id="__span-17-66"><a id="__codelineno-17-66" name="__codelineno-17-66"></a>
</span><span id="__span-17-67"><a id="__codelineno-17-67" name="__codelineno-17-67"></a><span class="w">    </span><span class="c">% Head Motion Parameters (HMP)</span>
</span><span id="__span-17-68"><a id="__codelineno-17-68" name="__codelineno-17-68"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;HMP&#39;</span><span class="p">))</span>
</span><span id="__span-17-69"><a id="__codelineno-17-69" name="__codelineno-17-69"></a><span class="w">        </span><span class="c">% Extract and validate the specified number of head motion parameters</span>
</span><span id="__span-17-70"><a id="__codelineno-17-70" name="__codelineno-17-70"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;HMP&#39;</span><span class="p">));</span>
</span><span id="__span-17-71"><a id="__codelineno-17-71" name="__codelineno-17-71"></a><span class="w">        </span><span class="n">conf_num_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pipeline</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span>
</span><span id="__span-17-72"><a id="__codelineno-17-72" name="__codelineno-17-72"></a><span class="w">        </span><span class="n">conf_num_str_split</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strsplit</span><span class="p">(</span><span class="n">conf_num_str</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;-&#39;</span><span class="p">);</span>
</span><span id="__span-17-73"><a id="__codelineno-17-73" name="__codelineno-17-73"></a><span class="w">        </span><span class="n">conf_num</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">str2double</span><span class="p">(</span><span class="n">conf_num_str_split</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span id="__span-17-74"><a id="__codelineno-17-74" name="__codelineno-17-74"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">any</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">conf_num</span><span class="p">)</span>
</span><span id="__span-17-75"><a id="__codelineno-17-75" name="__codelineno-17-75"></a><span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;HMP must be 6, 12, or 24.&#39;</span><span class="p">);</span>
</span><span id="__span-17-76"><a id="__codelineno-17-76" name="__codelineno-17-76"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-17-77"><a id="__codelineno-17-77" name="__codelineno-17-77"></a><span class="w">            </span><span class="c">% Add the appropriate head motion parameters to selected_keys</span>
</span><span id="__span-17-78"><a id="__codelineno-17-78" name="__codelineno-17-78"></a><span class="w">            </span><span class="n">hmp_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">floor</span><span class="p">(</span><span class="n">conf_num</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
</span><span id="__span-17-79"><a id="__codelineno-17-79" name="__codelineno-17-79"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">hmp_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-17-80"><a id="__codelineno-17-80" name="__codelineno-17-80"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;rot_x&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_z&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_x&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_z&#39;</span><span class="p">}];</span>
</span><span id="__span-17-81"><a id="__codelineno-17-81" name="__codelineno-17-81"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-82"><a id="__codelineno-17-82" name="__codelineno-17-82"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">hmp_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-17-83"><a id="__codelineno-17-83" name="__codelineno-17-83"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;rot_x_derivative1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_y_derivative1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_z_derivative1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_x_derivative1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_y_derivative1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_z_derivative1&#39;</span><span class="p">}];</span>
</span><span id="__span-17-84"><a id="__codelineno-17-84" name="__codelineno-17-84"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-85"><a id="__codelineno-17-85" name="__codelineno-17-85"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">hmp_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-17-86"><a id="__codelineno-17-86" name="__codelineno-17-86"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;rot_x_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_y_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_z_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_x_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_y_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_z_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_x_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_y_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;rot_z_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_x_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_y_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;trans_z_derivative1_power2&#39;</span><span class="p">}];</span>
</span><span id="__span-17-87"><a id="__codelineno-17-87" name="__codelineno-17-87"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-88"><a id="__codelineno-17-88" name="__codelineno-17-88"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-17-89"><a id="__codelineno-17-89" name="__codelineno-17-89"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-17-90"><a id="__codelineno-17-90" name="__codelineno-17-90"></a>
</span><span id="__span-17-91"><a id="__codelineno-17-91" name="__codelineno-17-91"></a><span class="w">    </span><span class="c">% Global Signal (GS)</span>
</span><span id="__span-17-92"><a id="__codelineno-17-92" name="__codelineno-17-92"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;GS&#39;</span><span class="p">))</span>
</span><span id="__span-17-93"><a id="__codelineno-17-93" name="__codelineno-17-93"></a><span class="w">        </span><span class="c">% Extract and validate the specified level of global signal processing</span>
</span><span id="__span-17-94"><a id="__codelineno-17-94" name="__codelineno-17-94"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;GS&#39;</span><span class="p">));</span>
</span><span id="__span-17-95"><a id="__codelineno-17-95" name="__codelineno-17-95"></a><span class="w">        </span><span class="n">conf_num_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pipeline</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span>
</span><span id="__span-17-96"><a id="__codelineno-17-96" name="__codelineno-17-96"></a><span class="w">        </span><span class="n">conf_num_str_split</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strsplit</span><span class="p">(</span><span class="n">conf_num_str</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;-&#39;</span><span class="p">);</span>
</span><span id="__span-17-97"><a id="__codelineno-17-97" name="__codelineno-17-97"></a><span class="w">        </span><span class="n">conf_num</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">str2double</span><span class="p">(</span><span class="n">conf_num_str_split</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span id="__span-17-98"><a id="__codelineno-17-98" name="__codelineno-17-98"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">any</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">conf_num</span><span class="p">)</span>
</span><span id="__span-17-99"><a id="__codelineno-17-99" name="__codelineno-17-99"></a><span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;GS must be 1, 2, or 4.&#39;</span><span class="p">);</span>
</span><span id="__span-17-100"><a id="__codelineno-17-100" name="__codelineno-17-100"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-17-101"><a id="__codelineno-17-101" name="__codelineno-17-101"></a><span class="w">            </span><span class="c">% Add the global signal parameters to selected_keys based on the specified level</span>
</span><span id="__span-17-102"><a id="__codelineno-17-102" name="__codelineno-17-102"></a><span class="w">            </span><span class="n">gs_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">conf_num</span><span class="p">;</span>
</span><span id="__span-17-103"><a id="__codelineno-17-103" name="__codelineno-17-103"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">gs_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-17-104"><a id="__codelineno-17-104" name="__codelineno-17-104"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;global_signal&#39;</span><span class="p">}];</span>
</span><span id="__span-17-105"><a id="__codelineno-17-105" name="__codelineno-17-105"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-106"><a id="__codelineno-17-106" name="__codelineno-17-106"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">gs_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-17-107"><a id="__codelineno-17-107" name="__codelineno-17-107"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;global_signal_derivative1&#39;</span><span class="p">}];</span>
</span><span id="__span-17-108"><a id="__codelineno-17-108" name="__codelineno-17-108"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-109"><a id="__codelineno-17-109" name="__codelineno-17-109"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">gs_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-17-110"><a id="__codelineno-17-110" name="__codelineno-17-110"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;global_signal_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;global_signal_power2&#39;</span><span class="p">}];</span>
</span><span id="__span-17-111"><a id="__codelineno-17-111" name="__codelineno-17-111"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-112"><a id="__codelineno-17-112" name="__codelineno-17-112"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-17-113"><a id="__codelineno-17-113" name="__codelineno-17-113"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-17-114"><a id="__codelineno-17-114" name="__codelineno-17-114"></a>
</span><span id="__span-17-115"><a id="__codelineno-17-115" name="__codelineno-17-115"></a><span class="w">    </span><span class="c">% CSF and WM masks global signal (CSF_WM)</span>
</span><span id="__span-17-116"><a id="__codelineno-17-116" name="__codelineno-17-116"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;CSF_WM&#39;</span><span class="p">))</span>
</span><span id="__span-17-117"><a id="__codelineno-17-117" name="__codelineno-17-117"></a><span class="w">        </span><span class="c">% Extract and validate the specified level of CSF/WM signal processing</span>
</span><span id="__span-17-118"><a id="__codelineno-17-118" name="__codelineno-17-118"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;CSF_WM&#39;</span><span class="p">));</span>
</span><span id="__span-17-119"><a id="__codelineno-17-119" name="__codelineno-17-119"></a><span class="w">        </span><span class="n">conf_num_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pipeline</span><span class="p">(</span><span class="n">idx</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span>
</span><span id="__span-17-120"><a id="__codelineno-17-120" name="__codelineno-17-120"></a><span class="w">        </span><span class="n">conf_num_str_split</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strsplit</span><span class="p">(</span><span class="n">conf_num_str</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;-&#39;</span><span class="p">);</span>
</span><span id="__span-17-121"><a id="__codelineno-17-121" name="__codelineno-17-121"></a><span class="w">        </span><span class="n">conf_num</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">str2double</span><span class="p">(</span><span class="n">conf_num_str_split</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span id="__span-17-122"><a id="__codelineno-17-122" name="__codelineno-17-122"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">any</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">conf_num</span><span class="p">)</span>
</span><span id="__span-17-123"><a id="__codelineno-17-123" name="__codelineno-17-123"></a><span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;CSF_WM must be 2, 4, or 8.&#39;</span><span class="p">);</span>
</span><span id="__span-17-124"><a id="__codelineno-17-124" name="__codelineno-17-124"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-17-125"><a id="__codelineno-17-125" name="__codelineno-17-125"></a><span class="w">            </span><span class="c">% Add the CSF and WM parameters to selected_keys based on the specified level</span>
</span><span id="__span-17-126"><a id="__codelineno-17-126" name="__codelineno-17-126"></a><span class="w">            </span><span class="n">phys_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">floor</span><span class="p">(</span><span class="n">conf_num</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-17-127"><a id="__codelineno-17-127" name="__codelineno-17-127"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">phys_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-17-128"><a id="__codelineno-17-128" name="__codelineno-17-128"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;white_matter&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;csf&#39;</span><span class="p">}];</span>
</span><span id="__span-17-129"><a id="__codelineno-17-129" name="__codelineno-17-129"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-130"><a id="__codelineno-17-130" name="__codelineno-17-130"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">phys_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-17-131"><a id="__codelineno-17-131" name="__codelineno-17-131"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;white_matter_derivative1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;csf_derivative1&#39;</span><span class="p">}];</span>
</span><span id="__span-17-132"><a id="__codelineno-17-132" name="__codelineno-17-132"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-133"><a id="__codelineno-17-133" name="__codelineno-17-133"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">phys_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-17-134"><a id="__codelineno-17-134" name="__codelineno-17-134"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;white_matter_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;csf_derivative1_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;white_matter_power2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;csf_power2&#39;</span><span class="p">}];</span>
</span><span id="__span-17-135"><a id="__codelineno-17-135" name="__codelineno-17-135"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-136"><a id="__codelineno-17-136" name="__codelineno-17-136"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-17-137"><a id="__codelineno-17-137" name="__codelineno-17-137"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-17-138"><a id="__codelineno-17-138" name="__codelineno-17-138"></a>
</span><span id="__span-17-139"><a id="__codelineno-17-139" name="__codelineno-17-139"></a><span class="w">    </span><span class="c">% aCompCor</span>
</span><span id="__span-17-140"><a id="__codelineno-17-140" name="__codelineno-17-140"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;aCompCor&#39;</span><span class="p">))</span>
</span><span id="__span-17-141"><a id="__codelineno-17-141" name="__codelineno-17-141"></a><span class="w">        </span><span class="c">% Extract and format aCompCor confounds based on the specified number</span>
</span><span id="__span-17-142"><a id="__codelineno-17-142" name="__codelineno-17-142"></a><span class="w">        </span><span class="n">csf_50_dict</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">json_run</span><span class="p">(</span><span class="nb">ismember</span><span class="p">({</span><span class="n">json_run</span><span class="p">.</span><span class="n">Mask</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;CSF&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nb">ismember</span><span class="p">({</span><span class="n">json_run</span><span class="p">.</span><span class="n">Method</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;aCompCor&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="nb">contains</span><span class="p">({</span><span class="n">json_run</span><span class="p">.</span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;dropped&#39;</span><span class="p">));</span>
</span><span id="__span-17-143"><a id="__codelineno-17-143" name="__codelineno-17-143"></a><span class="w">        </span><span class="n">wm_50_dict</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">json_run</span><span class="p">(</span><span class="nb">ismember</span><span class="p">({</span><span class="n">json_run</span><span class="p">.</span><span class="n">Mask</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;WM&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nb">ismember</span><span class="p">({</span><span class="n">json_run</span><span class="p">.</span><span class="n">Method</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;aCompCor&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="nb">contains</span><span class="p">({</span><span class="n">json_run</span><span class="p">.</span><span class="n">key</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;dropped&#39;</span><span class="p">));</span>
</span><span id="__span-17-144"><a id="__codelineno-17-144" name="__codelineno-17-144"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;aCompCor&#39;</span><span class="p">));</span>
</span><span id="__span-17-145"><a id="__codelineno-17-145" name="__codelineno-17-145"></a><span class="w">        </span><span class="n">conf_num_str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pipeline</span><span class="p">{</span><span class="n">idx</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span><span class="w"> </span>
</span><span id="__span-17-146"><a id="__codelineno-17-146" name="__codelineno-17-146"></a><span class="w">        </span><span class="n">conf_num_str_split</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strsplit</span><span class="p">(</span><span class="n">conf_num_str</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="s">&#39;-&#39;</span><span class="p">);</span>
</span><span id="__span-17-147"><a id="__codelineno-17-147" name="__codelineno-17-147"></a><span class="w">        </span><span class="n">conf_num</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">str2double</span><span class="p">(</span><span class="n">conf_num_str_split</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span id="__span-17-148"><a id="__codelineno-17-148" name="__codelineno-17-148"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">any</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">conf_num</span><span class="p">)</span>
</span><span id="__span-17-149"><a id="__codelineno-17-149" name="__codelineno-17-149"></a><span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;aCompCor must be 10 or 50.&#39;</span><span class="p">);</span>
</span><span id="__span-17-150"><a id="__codelineno-17-150" name="__codelineno-17-150"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-17-151"><a id="__codelineno-17-151" name="__codelineno-17-151"></a><span class="w">            </span><span class="c">% Select the appropriate aCompCor components and add them to selected_keys</span>
</span><span id="__span-17-152"><a id="__codelineno-17-152" name="__codelineno-17-152"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">conf_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-17-153"><a id="__codelineno-17-153" name="__codelineno-17-153"></a><span class="w">                </span><span class="n">csf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sort</span><span class="p">(</span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">csf_50_dict</span><span class="p">.</span><span class="n">keys</span><span class="p">()));</span>
</span><span id="__span-17-154"><a id="__codelineno-17-154" name="__codelineno-17-154"></a><span class="w">                </span><span class="n">csf_10</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">csf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">);</span>
</span><span id="__span-17-155"><a id="__codelineno-17-155" name="__codelineno-17-155"></a><span class="w">                </span><span class="n">wm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sort</span><span class="p">(</span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">wm_50_dict</span><span class="p">.</span><span class="n">keys</span><span class="p">()));</span>
</span><span id="__span-17-156"><a id="__codelineno-17-156" name="__codelineno-17-156"></a><span class="w">                </span><span class="n">wm_10</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">);</span>
</span><span id="__span-17-157"><a id="__codelineno-17-157" name="__codelineno-17-157"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="n">csf_10</span><span class="p">,</span><span class="w"> </span><span class="n">wm_10</span><span class="p">];</span>
</span><span id="__span-17-158"><a id="__codelineno-17-158" name="__codelineno-17-158"></a><span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="n">conf_num</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">50</span>
</span><span id="__span-17-159"><a id="__codelineno-17-159" name="__codelineno-17-159"></a><span class="w">                </span><span class="n">csf_50</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">csf_50_dict</span><span class="p">.</span><span class="n">keys</span><span class="p">());</span>
</span><span id="__span-17-160"><a id="__codelineno-17-160" name="__codelineno-17-160"></a><span class="w">                </span><span class="n">wm_50</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">wm_50_dict</span><span class="p">.</span><span class="n">keys</span><span class="p">());</span>
</span><span id="__span-17-161"><a id="__codelineno-17-161" name="__codelineno-17-161"></a><span class="w">                </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="n">csf_50</span><span class="p">,</span><span class="w"> </span><span class="n">wm_50</span><span class="p">];</span>
</span><span id="__span-17-162"><a id="__codelineno-17-162" name="__codelineno-17-162"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-17-163"><a id="__codelineno-17-163" name="__codelineno-17-163"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-17-164"><a id="__codelineno-17-164" name="__codelineno-17-164"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-17-165"><a id="__codelineno-17-165" name="__codelineno-17-165"></a>
</span><span id="__span-17-166"><a id="__codelineno-17-166" name="__codelineno-17-166"></a><span class="w">    </span><span class="c">% Cosine</span>
</span><span id="__span-17-167"><a id="__codelineno-17-167" name="__codelineno-17-167"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Cosine&#39;</span><span class="p">))</span>
</span><span id="__span-17-168"><a id="__codelineno-17-168" name="__codelineno-17-168"></a><span class="w">        </span><span class="c">% Extract cosine-based regressors for high-pass filtering</span>
</span><span id="__span-17-169"><a id="__codelineno-17-169" name="__codelineno-17-169"></a><span class="w">        </span><span class="n">cosine_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tsv_run</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">VariableNames</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">tsv_run</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">VariableNames</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;cosine&#39;</span><span class="p">));</span>
</span><span id="__span-17-170"><a id="__codelineno-17-170" name="__codelineno-17-170"></a><span class="w">        </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="n">cosine_keys</span><span class="p">];</span>
</span><span id="__span-17-171"><a id="__codelineno-17-171" name="__codelineno-17-171"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-17-172"><a id="__codelineno-17-172" name="__codelineno-17-172"></a>
</span><span id="__span-17-173"><a id="__codelineno-17-173" name="__codelineno-17-173"></a><span class="w">    </span><span class="c">% MotionOutlier</span>
</span><span id="__span-17-174"><a id="__codelineno-17-174" name="__codelineno-17-174"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;MotionOutlier&#39;</span><span class="p">))</span>
</span><span id="__span-17-175"><a id="__codelineno-17-175" name="__codelineno-17-175"></a><span class="w">        </span><span class="c">% Process motion outliers, either using pre-computed values or calculating them</span>
</span><span id="__span-17-176"><a id="__codelineno-17-176" name="__codelineno-17-176"></a><span class="w">        </span><span class="n">motion_outlier_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tsv_run</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">VariableNames</span><span class="p">(</span><span class="nb">find</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">tsv_run</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">VariableNames</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;non_steady_state_outlier&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;motion_outlier&#39;</span><span class="p">})));</span>
</span><span id="__span-17-177"><a id="__codelineno-17-177" name="__codelineno-17-177"></a><span class="w">        </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="n">motion_outlier_keys</span><span class="p">];</span>
</span><span id="__span-17-178"><a id="__codelineno-17-178" name="__codelineno-17-178"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-17-179"><a id="__codelineno-17-179" name="__codelineno-17-179"></a>
</span><span id="__span-17-180"><a id="__codelineno-17-180" name="__codelineno-17-180"></a><span class="w">    </span><span class="c">% Framewise Displacement (FD)</span>
</span><span id="__span-17-181"><a id="__codelineno-17-181" name="__codelineno-17-181"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;FD&#39;</span><span class="p">))</span>
</span><span id="__span-17-182"><a id="__codelineno-17-182" name="__codelineno-17-182"></a><span class="w">        </span><span class="c">% Add raw framewise displacement values to selected_keys</span>
</span><span id="__span-17-183"><a id="__codelineno-17-183" name="__codelineno-17-183"></a><span class="w">        </span><span class="c">% If the first row is &#39;n/a&#39;, replace it with 0</span>
</span><span id="__span-17-184"><a id="__codelineno-17-184" name="__codelineno-17-184"></a><span class="w">        </span><span class="n">fd_values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tsv_run</span><span class="p">.</span><span class="n">framewise_displacement</span><span class="p">;</span>
</span><span id="__span-17-185"><a id="__codelineno-17-185" name="__codelineno-17-185"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">isnan</span><span class="p">(</span><span class="n">fd_values</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="__span-17-186"><a id="__codelineno-17-186" name="__codelineno-17-186"></a><span class="w">            </span><span class="n">fd_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-17-187"><a id="__codelineno-17-187" name="__codelineno-17-187"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-17-188"><a id="__codelineno-17-188" name="__codelineno-17-188"></a><span class="w">        </span><span class="n">tsv_run</span><span class="p">.</span><span class="n">framewise_displacement</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fd_values</span><span class="p">;</span>
</span><span id="__span-17-189"><a id="__codelineno-17-189" name="__codelineno-17-189"></a><span class="w">        </span><span class="n">selected_keys</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">selected_keys</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;framewise_displacement&#39;</span><span class="p">}];</span>
</span><span id="__span-17-190"><a id="__codelineno-17-190" name="__codelineno-17-190"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-17-191"><a id="__codelineno-17-191" name="__codelineno-17-191"></a>
</span><span id="__span-17-192"><a id="__codelineno-17-192" name="__codelineno-17-192"></a><span class="w">    </span><span class="c">% Retrieve the selected confounds and convert them into a table</span>
</span><span id="__span-17-193"><a id="__codelineno-17-193" name="__codelineno-17-193"></a><span class="w">    </span><span class="n">confounds_table</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tsv_run</span><span class="p">(:,</span><span class="w"> </span><span class="nb">ismember</span><span class="p">(</span><span class="n">tsv_run</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">VariableNames</span><span class="p">,</span><span class="w"> </span><span class="n">selected_keys</span><span class="p">));</span>
</span><span id="__span-17-194"><a id="__codelineno-17-194" name="__codelineno-17-194"></a><span class="w">    </span><span class="n">confounds</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fillmissing</span><span class="p">(</span><span class="n">confounds_table</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;constant&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-17-195"><a id="__codelineno-17-195" name="__codelineno-17-195"></a><span class="k">end</span>
</span><span id="__span-17-196"><a id="__codelineno-17-196" name="__codelineno-17-196"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>gunzipNiftiFile.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span>
<span class="normal"><a href="#__codelineno-18-42">42</a></span>
<span class="normal"><a href="#__codelineno-18-43">43</a></span>
<span class="normal"><a href="#__codelineno-18-44">44</a></span>
<span class="normal"><a href="#__codelineno-18-45">45</a></span>
<span class="normal"><a href="#__codelineno-18-46">46</a></span>
<span class="normal"><a href="#__codelineno-18-47">47</a></span>
<span class="normal"><a href="#__codelineno-18-48">48</a></span>
<span class="normal"><a href="#__codelineno-18-49">49</a></span>
<span class="normal"><a href="#__codelineno-18-50">50</a></span>
<span class="normal"><a href="#__codelineno-18-51">51</a></span>
<span class="normal"><a href="#__codelineno-18-52">52</a></span>
<span class="normal"><a href="#__codelineno-18-53">53</a></span>
<span class="normal"><a href="#__codelineno-18-54">54</a></span>
<span class="normal"><a href="#__codelineno-18-55">55</a></span>
<span class="normal"><a href="#__codelineno-18-56">56</a></span>
<span class="normal"><a href="#__codelineno-18-57">57</a></span>
<span class="normal"><a href="#__codelineno-18-58">58</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="k">function</span><span class="w"> </span>gunzippedNii<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">gunzipNiftiFile</span><span class="p">(</span>niiGzFile, outPath<span class="p">)</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="c">% gunzipNiftiFile - Decompress (gunzip) .nii.gz file and save it into a</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="c">% &#39;./BIDS/derivatives/pre-SPM/gunzipped/sub-xx&#39; folder in the derivatives directory of a BIDS dataset</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="c">% Author: Andrea Costantino</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="c">% Date: 3/2/2023</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="c">% Usage:  </span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="c">%   outPath = gunzipNiftiFile(niiGzFile, outPath)</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">    </span><span class="c">% Inputs:</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">    </span><span class="c">%    niiGzFile - String indicating the path to the input .nii file.</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">    </span><span class="c">%    outPath - String indicating the root output directory.</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">    </span><span class="c">% Outputs:</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">    </span><span class="c">%    gunzippedNii - String indicating the new directory of the output file.</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18"></a>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="w">    </span><span class="c">% Extract subject and task from nii file name</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="w">    </span><span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="w"> </span><span class="n">niiGzName</span><span class="p">,</span><span class="w"> </span><span class="n">niiGzExt</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fileparts</span><span class="p">(</span><span class="n">niiGzFile</span><span class="p">);</span><span class="w"> </span><span class="c">% isolate the name of the nii.gz file</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21"></a><span class="w">    </span><span class="n">nameSplits</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="n">niiGzName</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">);</span><span class="w"> </span><span class="c">% split the nii file name into segments</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">    </span><span class="n">selectedSub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">nameSplits</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span><span class="w"> </span><span class="c">% subject is the first segment</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23"></a>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">    </span><span class="c">% Infer the output path if not provided</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">nargin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="w">        </span><span class="c">% get the BIDS root folder path</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="w">        </span><span class="n">splitPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strsplit</span><span class="p">(</span><span class="n">niiGzFile</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;/&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% split the string into folders</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">splitPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;BIDS&#39;</span><span class="p">));</span><span class="w"> </span><span class="c">% find the index of the split that includes &#39;BIDS&#39;</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="w">        </span><span class="n">bidsPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strjoin</span><span class="p">(</span><span class="n">splitPath</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">idx</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;/&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% create the full folder path</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="w">        </span><span class="n">outPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">bidsPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;derivatives&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pre-SPM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;gunzipped&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedSub</span><span class="p">);</span><span class="w"> </span><span class="c">% build the output path</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32"></a>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33"></a><span class="w">    </span><span class="c">% Check if the output folder already exists</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">exist</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;dir&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">7</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;GUNZIP: Output directory already exists: %s.\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">outPath</span><span class="p">);</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37"></a><span class="w">        </span><span class="nb">mkdir</span><span class="p">(</span><span class="n">outPath</span><span class="p">);</span><span class="w"> </span><span class="c">% create the output directory</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;GUNZIP: Created output directory: %s.\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">outPath</span><span class="p">);</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40"></a>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41"></a><span class="w">    </span><span class="c">% Check if the output file already exists</span>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42"></a><span class="w">    </span><span class="n">newFilePath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="n">niiGzName</span><span class="p">);</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43"></a>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">exist</span><span class="p">(</span><span class="n">newFilePath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;GUNZIP: Gunzipped file already exists: %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">newFilePath</span><span class="p">);</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46"></a><span class="w">        </span><span class="n">gunzippedNii</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">newFilePath</span><span class="p">};</span>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48"></a><span class="w">        </span><span class="c">% gunzip them</span>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;GUNZIP: decompressing file %s ...\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">niiGzName</span><span class="p">,</span><span class="w"> </span><span class="n">niiGzExt</span><span class="p">])</span>
</span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50"></a><span class="w">        </span><span class="n">gunzippedNii</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">gunzip</span><span class="p">(</span><span class="n">niiGzFile</span><span class="p">,</span><span class="w"> </span><span class="n">outPath</span><span class="p">);</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;GUNZIP: Created gunzipped file: %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">newFilePath</span><span class="p">);</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52"></a>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53"></a><span class="w">        </span><span class="c">% Save a copy of this function in the output folder</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">exist</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;smoothNiftiFile.m&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-18-55"><a id="__codelineno-18-55" name="__codelineno-18-55"></a><span class="w">            </span><span class="nb">copyfile</span><span class="p">([</span><span class="nb">mfilename</span><span class="p">(</span><span class="s">&#39;fullpath&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;.m&#39;</span><span class="p">],</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;gunzipNiftiFile.m&#39;</span><span class="p">));</span>
</span><span id="__span-18-56"><a id="__codelineno-18-56" name="__codelineno-18-56"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-18-57"><a id="__codelineno-18-57" name="__codelineno-18-57"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-18-58"><a id="__codelineno-18-58" name="__codelineno-18-58"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>smoothNiftiFile.m</summary>
<div class="language-matlab highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span>
<span class="normal"><a href="#__codelineno-19-51">51</a></span>
<span class="normal"><a href="#__codelineno-19-52">52</a></span>
<span class="normal"><a href="#__codelineno-19-53">53</a></span>
<span class="normal"><a href="#__codelineno-19-54">54</a></span>
<span class="normal"><a href="#__codelineno-19-55">55</a></span>
<span class="normal"><a href="#__codelineno-19-56">56</a></span>
<span class="normal"><a href="#__codelineno-19-57">57</a></span>
<span class="normal"><a href="#__codelineno-19-58">58</a></span>
<span class="normal"><a href="#__codelineno-19-59">59</a></span>
<span class="normal"><a href="#__codelineno-19-60">60</a></span>
<span class="normal"><a href="#__codelineno-19-61">61</a></span>
<span class="normal"><a href="#__codelineno-19-62">62</a></span>
<span class="normal"><a href="#__codelineno-19-63">63</a></span>
<span class="normal"><a href="#__codelineno-19-64">64</a></span>
<span class="normal"><a href="#__codelineno-19-65">65</a></span>
<span class="normal"><a href="#__codelineno-19-66">66</a></span>
<span class="normal"><a href="#__codelineno-19-67">67</a></span>
<span class="normal"><a href="#__codelineno-19-68">68</a></span>
<span class="normal"><a href="#__codelineno-19-69">69</a></span>
<span class="normal"><a href="#__codelineno-19-70">70</a></span>
<span class="normal"><a href="#__codelineno-19-71">71</a></span>
<span class="normal"><a href="#__codelineno-19-72">72</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">function</span><span class="w"> </span>newFilePath<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">smoothNiftiFile</span><span class="p">(</span>niiFile, outPath<span class="p">)</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="c">% smoothNiftiFile - Smooth a .nii file and save it into a</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="c">% &#39;./BIDS/derivatives/pre-SPM/smoothed/sub-xx&#39; folder in the derivatives directory of a BIDS dataset</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="c">% Author: Andrea Costantino</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">    </span><span class="c">% Date: 3/2/2023</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="c">% Usage:  </span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">    </span><span class="c">%   outRoot = smoothNiftiFile(niiFile, outPath)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">    </span><span class="c">% Inputs:</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">    </span><span class="c">%    niiFile - String indicating the path to the input .nii file.</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">    </span><span class="c">%    outRoot - String indicating the output directory.</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">    </span><span class="c">% Outputs:</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">    </span><span class="c">%    newFilePath - String indicating the new directory of the output file.</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">    </span><span class="c">%</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18"></a>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">    </span><span class="c">% Extract subject and task from nii file name</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">    </span><span class="p">[</span><span class="n">niiFolder</span><span class="p">,</span><span class="w"> </span><span class="n">niiName</span><span class="p">,</span><span class="w"> </span><span class="n">niiExt</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fileparts</span><span class="p">(</span><span class="n">niiFile</span><span class="p">);</span><span class="w"> </span><span class="c">% isolate the name of the nii file</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">    </span><span class="n">subAndTask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">split</span><span class="p">(</span><span class="n">niiName</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">);</span><span class="w"> </span><span class="c">% split the nii file name into segments</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="w">    </span><span class="n">selectedSub</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">subAndTask</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span><span class="w"> </span><span class="c">% subject is the first segment</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23"></a>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="w">    </span><span class="c">% Infer the output path if not provided</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">nargin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="w">        </span><span class="c">% get the BIDS root folder path</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="w">        </span><span class="n">splitPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strsplit</span><span class="p">(</span><span class="n">niiFile</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;/&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% split the string into folders</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">find</span><span class="p">(</span><span class="nb">contains</span><span class="p">(</span><span class="n">splitPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;BIDS&#39;</span><span class="p">));</span><span class="w"> </span><span class="c">% find the index of the split that includes &#39;BIDS&#39;</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="w">        </span><span class="n">bidsPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strjoin</span><span class="p">(</span><span class="n">splitPath</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">idx</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;/&#39;</span><span class="p">);</span><span class="w"> </span><span class="c">% create the full folder path</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30"></a><span class="w">        </span><span class="n">outPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">bidsPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;derivatives&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pre-SPM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;smoothed&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">selectedSub</span><span class="p">);</span><span class="w"> </span><span class="c">% build the output path</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32"></a>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="w">    </span><span class="c">% Check if the output folder already exists</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">exist</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;dir&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">7</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;SMOOTH: Output directory %s already exists.\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">outPath</span><span class="p">);</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37"></a><span class="w">        </span><span class="nb">mkdir</span><span class="p">(</span><span class="n">outPath</span><span class="p">);</span><span class="w"> </span><span class="c">% create the output directory</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;SMOOTH: Created output directory %s.\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">outPath</span><span class="p">);</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40"></a>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41"></a><span class="w">    </span><span class="c">% Check if the output file already exists</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42"></a><span class="w">    </span><span class="n">smoothFileName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">strcat</span><span class="p">(</span><span class="s">&#39;smooth_&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">niiName</span><span class="p">,</span><span class="w"> </span><span class="n">niiExt</span><span class="p">]);</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43"></a><span class="w">    </span><span class="n">newFilePath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="nb">strrep</span><span class="p">(</span><span class="n">smoothFileName</span><span class="p">,</span><span class="w"> </span><span class="n">niiExt</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;_smooth&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">niiExt</span><span class="p">]));</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44"></a>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">exist</span><span class="p">(</span><span class="n">newFilePath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;SMOOTH: Smoothed file already exists: %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">newFilePath</span><span class="p">);</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48"></a><span class="w">        </span><span class="c">% Setup and run SPM smoothing job</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">spatial</span><span class="p">.</span><span class="n">smooth</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">niiFile</span><span class="p">};</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">spatial</span><span class="p">.</span><span class="n">smooth</span><span class="p">.</span><span class="n">fwhm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">6</span><span class="p">];</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">spatial</span><span class="p">.</span><span class="n">smooth</span><span class="p">.</span><span class="n">dtype</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">spatial</span><span class="p">.</span><span class="n">smooth</span><span class="p">.</span><span class="n">im</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53"></a><span class="w">        </span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">spm</span><span class="p">.</span><span class="n">spatial</span><span class="p">.</span><span class="n">smooth</span><span class="p">.</span><span class="n">prefix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;smooth_&#39;</span><span class="p">;</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54"></a>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55"></a><span class="w">        </span><span class="c">% Initialize SPM</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56"></a><span class="w">        </span><span class="n">spm_jobman</span><span class="p">(</span><span class="s">&#39;initcfg&#39;</span><span class="p">);</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57"></a><span class="w">        </span><span class="n">spm</span><span class="p">(</span><span class="s">&#39;defaults&#39;</span><span class="p">,</span><span class="s">&#39;fmri&#39;</span><span class="p">);</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58"></a>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59"></a><span class="w">        </span><span class="c">% Run batch job and suppress the SPM output</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;SMOOTH: smoothing file %s ...\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">niiName</span><span class="p">,</span><span class="w"> </span><span class="n">niiExt</span><span class="p">])</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61"></a><span class="w">        </span><span class="nb">evalc</span><span class="p">(</span><span class="s">&#39;spm_jobman(&#39;&#39;run&#39;&#39;, matlabbatch);&#39;</span><span class="p">);</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62"></a>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63"></a><span class="w">        </span><span class="c">% Move file to correct folder</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64"></a><span class="w">        </span><span class="nb">movefile</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">niiFolder</span><span class="p">,</span><span class="w"> </span><span class="n">smoothFileName</span><span class="p">),</span><span class="w"> </span><span class="n">newFilePath</span><span class="p">);</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65"></a><span class="w">        </span><span class="nb">fprintf</span><span class="p">(</span><span class="s">&#39;SMOOTH: Created smoothed file: %s\n&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">newFilePath</span><span class="p">);</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66"></a>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67"></a><span class="w">        </span><span class="c">% Save a copy of this function in the output folder</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">exist</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;smoothNiftiFile.m&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;file&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69"></a><span class="w">            </span><span class="nb">copyfile</span><span class="p">([</span><span class="nb">mfilename</span><span class="p">(</span><span class="s">&#39;fullpath&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;.m&#39;</span><span class="p">],</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="n">outPath</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;smoothNiftiFile.m&#39;</span><span class="p">));</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72"></a><span class="k">end</span>
</span></code></pre></div></td></tr></table></div>
</details>
<hr />
<p>Continue to the next guide for instructions on setting up Regions of Interest (ROIs) to extract and analyze data from specific brain regions:
<a href="fmri-rois.html">&rarr; Regions of Interest</a></p>
<hr />
<ul>
<li><strong>[TODO]:</strong> Include screenshots for GUI steps</li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">October 28, 2024 10:35:39</span>
  </span>

    
    
    
      
  
  <span class="md-source-file__fact">
    <span class="md-icon" title="Contributors">
      
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5.5A3.5 3.5 0 0 1 15.5 9a3.5 3.5 0 0 1-3.5 3.5A3.5 3.5 0 0 1 8.5 9 3.5 3.5 0 0 1 12 5.5M5 8c.56 0 1.08.15 1.53.42-.15 1.43.27 2.85 1.13 3.96C7.16 13.34 6.16 14 5 14a3 3 0 0 1-3-3 3 3 0 0 1 3-3m14 0a3 3 0 0 1 3 3 3 3 0 0 1-3 3c-1.16 0-2.16-.66-2.66-1.62a5.54 5.54 0 0 0 1.13-3.96c.45-.27.97-.42 1.53-.42M5.5 18.25c0-2.07 2.91-3.75 6.5-3.75s6.5 1.68 6.5 3.75V20h-13zM0 20v-1.5c0-1.39 1.89-2.56 4.45-2.9-.59.68-.95 1.62-.95 2.65V20zm24 0h-3.5v-1.75c0-1.03-.36-1.97-.95-2.65 2.56.34 4.45 1.51 4.45 2.9z"/></svg>
      
    </span>
    <nav>
      
        <a href="mailto:61991543+timmaniquet@users.noreply.github.com">Tim Maniquet</a>, 
        <a href="mailto:59078281+costantinoai@users.noreply.github.com">costantinoai</a>
    </nav>
  </span>

    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Help us improve this page by opening a new <a href="https://github.com/HOPLAB-LBP/hoplab-wiki/issues/new/?title=[Feedback]+4b.%20First-level%20analysis%20-%20Scripting+-+/research/fmri/analysis/fmri-glm-script.html" target="_blank" rel="noopener">Issue</a>, or contact a Wiki manager.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a href="#__consent">Change cookie settings</a>            
    

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  


  
    
  



  


<h4>Cookie consent</h4>
<p>Please, consider disabling your ad-blocker and allowing cookies for this Wiki .  We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.tabs.link", "content.code.copy", "content.code.select", "content.action.edit", "navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.sections", "search.highlight", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../../assets/external/unpkg.com/mermaid@11/dist/mermaid.min.js"></script>
      
    
  </body>
</html>