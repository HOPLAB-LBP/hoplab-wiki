name: PR checks

on:
  pull_request:
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - "README.md"
      - "requirements.txt"
      - ".markdownlint-cli2.yaml"
      - ".yamllint.yml"
      - "_typos.toml"
      - ".lychee.toml"
      - ".github/workflows/*.yml"
      - "scripts/docs_ci_check.sh"

permissions:
  contents: write
  pull-requests: write

jobs:
  # ───────────────────────────────────────────────────────────
  #  Job 1: Auto-fix safe issues and push back
  # ───────────────────────────────────────────────────────────
  autofix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-fix markdown (trailing spaces, tabs, blank lines)
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: "docs/**/*.md"
          fix: true
        continue-on-error: true

      - name: Auto-fix YAML trailing whitespace
        run: |
          sed -i 's/[[:space:]]*$//' mkdocs.yml .yamllint.yml .github/workflows/*.yml 2>/dev/null || true

      - name: Commit and push fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "style: auto-fix formatting issues"
            git push
          else
            echo "Nothing to fix."
          fi

  # ───────────────────────────────────────────────────────────
  #  Job 2: Run all checks and post a single report comment
  # ───────────────────────────────────────────────────────────
  check-and-report:
    needs: autofix
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # ── Setup ─────────────────────────────────────────────
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt yamllint

      - name: Create results directory
        run: mkdir -p /tmp/pr-checks

      # ── Check 1: Spell check ─────────────────────────────
      - name: Spell check
        id: spellcheck
        continue-on-error: true
        uses: crate-ci/typos@v1
        with:
          config: ./_typos.toml

      - name: Mark spell check status
        if: always()
        run: |
          if [ "$SPELLCHECK_OUTCOME" = "failure" ]; then
            echo "failed" > /tmp/pr-checks/spellcheck-status
            echo "See the **Spell check** step in the [workflow run]($RUN_URL) for the list of flagged words." > /tmp/pr-checks/spellcheck-output
          else
            echo "passed" > /tmp/pr-checks/spellcheck-status
          fi
        env:
          SPELLCHECK_OUTCOME: ${{ steps.spellcheck.outcome }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # ── Check 2: Markdown lint ───────────────────────────
      - name: Markdown lint
        id: markdownlint
        continue-on-error: true
        run: |
          npx -y markdownlint-cli2 "docs/**/*.md" 2>&1 | tee /tmp/pr-checks/markdownlint-output
          echo "passed" > /tmp/pr-checks/markdownlint-status

      - name: Mark markdown lint status
        if: always() && steps.markdownlint.outcome == 'failure'
        run: echo "failed" > /tmp/pr-checks/markdownlint-status

      # ── Check 3: YAML lint ───────────────────────────────
      - name: YAML lint
        id: yamllint
        continue-on-error: true
        run: |
          yamllint -c .yamllint.yml -f parsable mkdocs.yml .github/workflows/ 2>&1 | tee /tmp/pr-checks/yamllint-output
          echo "passed" > /tmp/pr-checks/yamllint-status

      - name: Mark YAML lint status
        if: always() && steps.yamllint.outcome == 'failure'
        run: echo "failed" > /tmp/pr-checks/yamllint-status

      # ── Check 4: Link check ──────────────────────────────
      - name: Link check
        id: linkcheck
        continue-on-error: true
        uses: lycheeverse/lychee-action@v2.0.2
        with:
          args: --config .lychee.toml --format markdown README.md docs/**/*.md
          output: /tmp/pr-checks/linkcheck-output.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Mark link check status
        if: always()
        run: |
          if [ "$LINKCHECK_EXIT" = "0" ]; then
            echo "passed" > /tmp/pr-checks/linkcheck-status
          else
            echo "failed" > /tmp/pr-checks/linkcheck-status
          fi
        env:
          LINKCHECK_EXIT: ${{ steps.linkcheck.outputs.exit_code }}

      # ── Check 5: MkDocs build ────────────────────────────
      - name: MkDocs build
        id: mkdocs
        continue-on-error: true
        run: |
          chmod +x scripts/docs_ci_check.sh
          scripts/docs_ci_check.sh 2>&1 | tee /tmp/pr-checks/mkdocs-output
          echo "passed" > /tmp/pr-checks/mkdocs-status

      - name: Mark MkDocs build status
        if: always() && steps.mkdocs.outcome == 'failure'
        run: echo "failed" > /tmp/pr-checks/mkdocs-status

      # ── Assemble and post the report ─────────────────────
      - name: Build report
        if: always()
        run: |
          REPORT="/tmp/pr-checks/report.md"

          # Hidden marker so we can find and update this comment on future runs
          echo '<!-- pr-checks-report -->' > "$REPORT"

          SPELL=$(cat /tmp/pr-checks/spellcheck-status 2>/dev/null || echo "skipped")
          MDLINT=$(cat /tmp/pr-checks/markdownlint-status 2>/dev/null || echo "skipped")
          YAML=$(cat /tmp/pr-checks/yamllint-status 2>/dev/null || echo "skipped")
          LINKS=$(cat /tmp/pr-checks/linkcheck-status 2>/dev/null || echo "skipped")
          BUILD=$(cat /tmp/pr-checks/mkdocs-status 2>/dev/null || echo "skipped")

          # Count failures
          FAILURES=0
          for s in "$SPELL" "$MDLINT" "$YAML" "$LINKS" "$BUILD"; do
            [ "$s" = "failed" ] && FAILURES=$((FAILURES + 1))
          done

          # ── All passed ──────────────────────────────────
          if [ "$FAILURES" -eq 0 ]; then
            cat >> "$REPORT" << 'EOF'
          ## :white_check_mark: All checks passed

          Your changes look good! A reviewer will take a look shortly.
          EOF
          else

          # ── Header ──────────────────────────────────────
            cat >> "$REPORT" << 'EOF'
          ## :mag: PR check results

          Some checks found issues in your changes. Don't worry — most of these are easy to fix!
          See below for what went wrong and how to resolve each issue.
          EOF
          fi

          # ── Spell check section ─────────────────────────
          if [ "$SPELL" = "failed" ]; then
            cat >> "$REPORT" << 'EOF'

          ---

          ### Spell check — issues found

          The spell checker flagged some words in your changes.

          EOF
            cat /tmp/pr-checks/spellcheck-output >> "$REPORT" 2>/dev/null || echo "(output not available)" >> "$REPORT"
            cat >> "$REPORT" << 'EOF'

          **How to fix:**
          - **If it's a real typo:** correct the spelling in your file.
          - **If the word is correct** (e.g. a technical term, name, or foreign language word), add it to `_typos.toml` under `[default.extend-words]`:
            ```toml
            [default.extend-words]
            YourWord = "YourWord"
            ```
          EOF
          fi

          # ── Markdown lint section ───────────────────────
          if [ "$MDLINT" = "failed" ]; then
            cat >> "$REPORT" << 'EOF'

          ---

          ### Markdown lint — issues found

          Some markdown formatting issues were found that couldn't be auto-fixed:

          <details>
          <summary>View markdown issues</summary>

          ```
          EOF
            cat /tmp/pr-checks/markdownlint-output >> "$REPORT" 2>/dev/null || echo "(output not captured)" >> "$REPORT"
            cat >> "$REPORT" << 'EOF'
          ```

          </details>

          **How to fix:** Open the listed files, go to the line numbers shown, and follow the suggestions.
          Common fixes:
          - **Wrong heading style:** use `## My heading` (with `#` symbols), not underlined headings
          - **Bare URL:** wrap it in angle brackets `<https://...>` or make it a link `[text](https://...)`
          EOF
          fi

          # ── YAML lint section ───────────────────────────
          if [ "$YAML" = "failed" ]; then
            cat >> "$REPORT" << 'EOF'

          ---

          ### YAML lint — issues found

          Problems were found in YAML configuration files:

          <details>
          <summary>View YAML issues</summary>

          ```
          EOF
            cat /tmp/pr-checks/yamllint-output >> "$REPORT" 2>/dev/null || echo "(output not captured)" >> "$REPORT"
            cat >> "$REPORT" << 'EOF'
          ```

          </details>

          **How to fix:** Open the file at the line number shown. YAML is sensitive to indentation —
          make sure you use spaces (not tabs) and align with the surrounding lines.
          EOF
          fi

          # ── Link check section ─────────────────────────
          if [ "$LINKS" = "failed" ]; then
            cat >> "$REPORT" << 'EOF'

          ---

          ### Link check — broken links found

          Some links in the documentation are broken or unreachable:

          <details>
          <summary>View broken links</summary>

          EOF
            cat /tmp/pr-checks/linkcheck-output.md >> "$REPORT" 2>/dev/null || echo "(output not captured)" >> "$REPORT"
            cat >> "$REPORT" << 'EOF'

          </details>

          **How to fix:**
          - **If the URL has moved:** update it to the new address.
          - **If the page is temporarily down:** add the URL to `.lychee.toml` under `exclude` to skip it for now.
          - **If it's an internal link** like `[see here](../other-page.md)`: check that the file exists and the path is correct.
          EOF
          fi

          # ── MkDocs build section ───────────────────────
          if [ "$BUILD" = "failed" ]; then
            cat >> "$REPORT" << 'EOF'

          ---

          ### MkDocs build — failed

          The documentation site failed to build. This usually means a file is missing or misconfigured.

          <details>
          <summary>View build output</summary>

          ```
          EOF
            grep -E '^(WARNING|ERROR|\[ERROR\]|\[docs-ci\])' /tmp/pr-checks/mkdocs-output >> "$REPORT" 2>/dev/null || cat /tmp/pr-checks/mkdocs-output >> "$REPORT" 2>/dev/null
            cat >> "$REPORT" << 'EOF'
          ```

          </details>

          **How to fix:**
          1. **If you added a new page:** you also need to add it to `mkdocs.yml` under the `nav:` section. Find the right section and add a line like:
             ```yaml
             - My new page: research/fmri/new-page.md
             ```
          2. **If you renamed or moved a file:** update the path in `mkdocs.yml` to match.
          3. **If you see "unrecognized relative link":** a `[link](path)` in your page points to a file that doesn't exist — check the path.
          EOF
          fi

          # ── Footer ─────────────────────────────────────
          if [ "$FAILURES" -gt 0 ]; then
            cat >> "$REPORT" << 'EOF'

          ---

          > **Need help?** Ping @costantinoai in the PR comments and I'll help you sort it out.
          >
          > Push a new commit to re-run these checks — this comment will update automatically.
          EOF
          fi

          echo "--- Report ---"
          cat "$REPORT"

      - name: Find existing bot comment
        if: always()
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: "<!-- pr-checks-report -->"

      - name: Post or update PR comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body-path: /tmp/pr-checks/report.md

      # ── Final verdict ──────────────────────────────────
      - name: Fail if any check failed
        if: always()
        run: |
          SPELL=$(cat /tmp/pr-checks/spellcheck-status 2>/dev/null || echo "skipped")
          MDLINT=$(cat /tmp/pr-checks/markdownlint-status 2>/dev/null || echo "skipped")
          YAML=$(cat /tmp/pr-checks/yamllint-status 2>/dev/null || echo "skipped")
          LINKS=$(cat /tmp/pr-checks/linkcheck-status 2>/dev/null || echo "skipped")
          BUILD=$(cat /tmp/pr-checks/mkdocs-status 2>/dev/null || echo "skipped")
          FAILED=false
          for s in "$SPELL" "$MDLINT" "$YAML" "$LINKS" "$BUILD"; do
            [ "$s" = "failed" ] && FAILED=true
          done
          if [ "$FAILED" = "true" ]; then
            echo "One or more checks failed. See the PR comment for details."
            exit 1
          fi
