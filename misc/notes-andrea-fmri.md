To avoid confusion with my main fmri file, here I will describe what I am currently doing for the last few subjects as a reminder for the mai fmri file.

some interesting links: https://www.youtube.com/watch?v=J0npRWV2zTY  [Andrea Jahn on fmriprep](https://www.youtube.com/@AndrewJahn)

Here are my steps:

at the hospital:
  - take fmri scans from the hospital computer. in the gui, specify what buttons to select.
  - anonymize the fnames with the script i use. this is important to protect subjects privacy (no names should be in the files that leave the hospital)
  - take bh and et data from the output folders in the exp PC
  - copy all the files into a sourcedata/ folder in bh, nifti, et folders

Now I have my source data folder. We need to.
  - anonymize/deface the images
  - run the script01 to move and rename the raw files into the main BIDS folder. This will create a sub-xx folder for each raw sub data
  - run the script02 to convert the behavioural mat data into events.tsv files following the BIDS specification. This will parse the trial data from the mat file, and create new tsv files into each sub-xx folder corresponding to each run.

Now we have our base (raw) data organized in a BIDS folder. this is our starting point for any other analysis. What now?
The main steps we need to follow are: fmriprep, GLM. rois. mvpa

For fmriprep: (fmriprep, docker, fmripre-docker)
  - install docker (and WSL if on windows). Assign resources (RAM, disk, cpus) reasonably (< 80% of your system capacity).
  - install fmriprep-docker. this is as easy as `pip install fmriprep-docker`.
  - share with docker the folders you are going to use. these are you BIDS folder, and a `temp_fmriprep` folder.
  - run fmripre-docker. Below you can see my terminal call to pre-process sub-41. The arguments I use (and a lot more that I don't use) are explained [here](https://fmriprep.org/en/stable/usage.html). Make sure you are familiar with these.
    
    ```sh
    fmriprep-docker /data/projects/chess/data/BIDS /data/projects/chess/data/BIDS/derivatives/fmriprep participant --work-dir //data/projects/chess/data/temp_fmriprep --mem-mb 10000 --n-cpus 16 --output-spaces MNI152NLin2009cAsym:res-2 anat fsnative --fs-license-file /data/projects/chess/misc/.license --bold2t1w-dof 9 --task exp --dummy-scans 0 --fs-subjects-dir /data/projects/chess/data/BIDS/derivatives/fastsurfer --notrack --participant-label 41
    ```
    NOTE: if you want to run analysis on surface data, you may want to consider getting CIFTI output images from fmriprep. I did not test this, but it should produce cortical BOLD series projected from the Glasser2016 template (the same parcellation I use for MVPA). In theory, SPM should be able to analyze .gii surface data, and bt getting the CIFTI outputs you should already have the parcellation projected to subject space for subsequent analyses.
    
    WARNING: this call is very resource and time intensive. It will take several hours (4-8, depending on your PC specs) at full capacity to preprocess a single subject. If you need to process many subjects, you may want to play with the ncpus and mem-mb parameters to be sure that you are using all the available resources. A good test of this is to open the task manager on windows, and check the CPU and RAM usage during a run. Ideally, we want the CPU to be always at max speed, and the RAM to be 10 GB below the maximum. If the RAM needed by the process is higher than the RAM available, you will get Out of Memory errors, or No more space on disk errors if you did not specify a work-dir folder. If this happens, lower the mem-mb and n-cpus until tyou find the right spot.
    
  - If the run finishes successfully (check the last line of your terminal output), you should have a new `BIDS/derivatives/fmriprep/sub-xx` folder (see [here](https://fmriprep.org/en/stable/outputs.html) for a complete list of outputs generated by fmriprep). make sure that inside you `anat` and `func` folders you have all the scans (anatomical, functional all runs) in the spaces you specified. Since we specified fsnative as space and we did not use the no-recon-all flag, fmriprep will also produce surface data in `BIDS/derivatives/fastsurfer/sub-xx`.
  - QA: Check the sub-xx.hmtl report to make sure everything run smoothly. Specifically, check the registrations, and look for particularly high FD values in the functional runs -- they may be indicative of poor data. See [this page](https://fmriprep.org/en/stable/outputs.html#confounds) for a description of the confounds and [this video](https://www.youtube.com/watch?v=fQHEKSzFKDc&list=PLIQIswOrUH6_szyxn9Fy-2cxd3vjlklde&index=3) for more information on what to look for.

Once we are done with preprocessing, it's time for GLM.

ADD EXACT STEPS FOR GLM
    
